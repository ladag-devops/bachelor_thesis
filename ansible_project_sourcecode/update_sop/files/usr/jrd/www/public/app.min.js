!function(e){var t={};function n(a){if(t[a])return t[a].exports;var o=t[a]={i:a,l:!1,exports:{}};return e[a].call(o.exports,o,o.exports,n),o.l=!0,o.exports}n.m=e,n.c=t,n.d=function(e,t,a){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:a})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var a=Object.create(null);if(n.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)n.d(a,o,function(t){return e[t]}.bind(null,o));return a},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=0)}([function(e,t,n){"use strict";var a=(Highcharts.setOptions({global:{useUTC:!1}}),{applicationModuleName:"remote-transceiver",applicationModuleVendorDependencies:["ngResource","ngCookies","ngAnimate","ngSanitize","ui.router","uiRouterStyles","ui.bootstrap","ui.utils","highcharts-ng","btford.socket-io","PANDAS","uiGmapgoogle-maps","ngMaterial","md.data.table","ngMessages"],registerModule:function(e,t){angular.module(e,t||[]),angular.module("remote-transceiver").requires.push(e)}});function o(e,t,n,a,o,i,r){var s,l=this;function c(e){i.show(i.simple().position("bottom right").textContent(e).hideDelay(3e3))}l.authentication=e,l.loading=!1,l.fault=!1,l.mt,l.config,l.get=function(){var e,n;l.loading=!0,(n=t.mtId,a.get({mtId:n}).$promise.catch((function(e){throw"Cannot add configuration upload task."}))).then((function(t){return function(e){return r.get(e).catch((function(e){throw"Cannot load configuration."}))}(e=t)})).then((function(t){return function(e,t){if(!e||!t)throw"Invalid data.";l.mt=e,l.config=t,s=_.cloneDeep(t)}(e,t)})).then((function(){l.loading=!1})).catch((function(e){l.loading=!1,l.fault=!0,c(e)}))},l.submit=function(e){if(l.mt){var t,n=_.cloneDeep(l.config),a=!angular.equals(n,s);l.loading=!0,(t=l.mt,t.$update().catch((function(e){throw"Cannot save data."}))).then((function(){if(a)return function(e,t){return r.upload(e,t).catch((function(e){throw"Cannot add configuration upload task."}))}(l.mt,n).then((function(){c("The configuration has been successfully updated, it will be uploaded to the device during next connection.")}));c("The device has been successfully updated")})).then((function(){l.loading=!1,o.back("core.devices.mt.start")})).catch((function(e){l.loading=!1,c(e)}))}},l.download=function(){var e;l.mt&&(l.loading=!0,(e=l.mt,r.download(e).catch((function(e){throw"Cannot add configuration download task."}))).then((function(){l.loading=!1,c("The configuration will be downloaded from the device during next connection."),o.back("core.devices.mt.start")})).catch((function(e){l.loading=!1,c(e)})))}}function o(e,t,n,a,o,i,r,s){var l,c=this;function u(e,t){return r.upload(e,t).catch((function(e){throw"Cannot add configuration upload task."}))}function d(){m("The configuration has been successfully updated, it will be uploaded to the device during next connection.")}function m(e){i.show(i.simple().position("bottom right").textContent(e).hideDelay(3e3))}function f(e,t,n,a){if(e=parseFloat(e),isNaN(e))throw"Cannot parse "+a;if(e<t||e>n)throw a+" is out of range.";return e}function p(e){return a=1.8,(t=1.8*e/65472)<(n=0)?n:t>a?a:t;var t,n,a}function g(e){return e/10}function v(e){return Math.round(10*e)}function h(e){return Math.round(1023*e*64/1.8)}function w(e,t,n,a,o){var i=(o-a)/(n-t),r=i*e+(-i*t+a);if(r-1==65535&&r--,r<0||r>65535)throw"Invalid form data.";return r}c.authentication=e,c.loading=!1,c.fault=!1,c.mt,c.config,c.cal={maxLoad:6553.5,tpc:{max:{load:6553.5,voltage:1.8},min:{load:0,voltage:0}}},c.get=function(){var e,n;c.loading=!0,(n=t.mtId,a.get({mtId:n}).$promise.catch((function(e){throw"Cannot add configuration upload task."}))).then((function(t){return function(e){return r.get(e).catch((function(e){throw"Cannot load Device configuration."}))}(e=t)})).then((function(t){return function(e,t){if(!e||!t)throw"Invalid data.";c.mt=e,c.config=t,l=_.cloneDeep(t),c.cal.maxLoad=g(t.primary.maximumUnit).toFixed(1),c.cal.tpc.max.load=g(t.primary.maximumUnit).toFixed(1),c.cal.tpc.max.voltage=p(t.primary.maximumRange).toFixed(3),c.cal.tpc.min.load=g(t.primary.minimumUnit).toFixed(1),c.cal.tpc.min.voltage=p(t.primary.minimumRange).toFixed(3)}(e,t)})).then((function(){c.loading=!1})).catch((function(e){c.loading=!1,c.fault=!0,m(e)}))},c.submit=function(e){if(c.mt)try{!function(){var e=_.cloneDeep(c.cal);if(e.maxLoad=v(f(e.maxLoad,0,6553.5,"Max. bolt tensile load rating (kN)")),e.tpc.max.load=v(f(e.tpc.max.load,0,6553.5,"Max. calibration load (kN)")),e.tpc.max.voltage=h(f(e.tpc.max.voltage,0,1.8,"Max. calibration load (V)")),e.tpc.min.load=v(f(e.tpc.min.load,0,6553.5,"Unloaded bolt (kN)")),e.tpc.min.voltage=h(f(e.tpc.min.voltage,0,1.8,"Unloaded bolt (V)")),e.tpc.min.load>=e.tpc.max.load)throw"Unloaded bolt (kN) is greater than or equal to Max. calibration load (kN).";if(e.tpc.min.voltage>=e.tpc.max.voltage)throw"Unloaded bolt (V) is greater than or equal to Max. calibration load (V).";if(e.tpc.min.load<0||e.tpc.min.load>e.maxLoad)throw"Unloaded bolt (kN) is out of range.";if(e.tpc.max.load<0||e.tpc.max.load>e.maxLoad)throw"Max. calibration load (kN) is out of range.";c.config.primary.minimumUnit=0,c.config.primary.maximumUnit=e.maxLoad,c.config.primary.minimumRange=w(0,e.tpc.min.load,e.tpc.max.load,e.tpc.min.voltage,e.tpc.max.voltage),c.config.primary.maximumRange=w(e.maxLoad,e.tpc.min.load,e.tpc.max.load,e.tpc.min.voltage,e.tpc.max.voltage)}();var t=_.cloneDeep(c.config);if(t.primary.minimumRange=parseInt(t.primary.minimumRange),t.primary.maximumRange=parseInt(t.primary.maximumRange),t.primary.minimumUnit=parseInt(t.primary.minimumUnit),t.primary.maximumUnit=parseInt(t.primary.maximumUnit),t.primary.minimumAdc=parseInt(t.primary.minimumAdc),t.primary.maximumAdc=parseInt(t.primary.maximumAdc),!!angular.equals(t,l))return void o.back("core.devices.mt.start");var n=s.confirm().parent(angular.element(document.querySelector("body"))).clickOutsideToClose(!1).title("Configuration").textContent("This operation will permanently overwrite the existing calibration. Are you sure you want to proceed?").ok("Okay").cancel("Cancel");s.show(n).then((function(){return c.loading=!0,u(c.mt,t).then((function(){c.loading=!1,d(),o.back("core.devices.mt.start")})).catch((function(e){c.loading=!1,m(e)}))}),(function(){console.log("canceled")}))}catch(e){m(e)}},c.reset=function(){var e=s.confirm().parent(angular.element(document.querySelector("body"))).clickOutsideToClose(!1).title("Configuration").textContent("This operation will permanently overwrite the existing calibration. Are you sure you want to proceed?").ok("Okay").cancel("Cancel");s.show(e).then((function(){var e=_.cloneDeep(c.config);return e.primary.minimumRange=0,e.primary.maximumRange=65535,e.primary.minimumUnit=0,e.primary.maximumUnit=65535,e.primary.minimumAdc=0,e.primary.maximumAdc=65535,c.loading=!0,u(c.mt,e).then((function(){c.loading=!1,d(),o.back("core.devices.mt.start")})).catch((function(e){c.loading=!1,m(e)}))}),(function(){console.log("canceled")}))},c.download=function(){var e;c.mt&&(c.loading=!0,(e=c.mt,r.download(e).catch((function(e){throw"Cannot add configuration download task."}))).then((function(){c.loading=!1,m("The configuration will be downloaded from the device during next connection."),o.back("core.devices.mt.start")})).catch((function(e){c.loading=!1,m(e)})))}}function i(e,t,n){$.msgGrowl({type:e,title:t,text:n})}function i(e,t,n){$.msgGrowl({type:e,title:t,text:n})}function r(){return{Unit:"g",UnitName:"g",ValueDecimals:3,DetailedValueDecimals:3,convert:function(e){return e},minmax:function(){return{min:-16,max:16}}}}function s(){return{Unit:"dsp",UnitName:"dsp",ValueDecimals:3,DetailedValueDecimals:3,convert:function(e){return e},minmax:function(){return{min:-250,max:250}}}}function l(){return{Unit:"dBm",UnitName:"Decibel-milliwatts",ValueDecimals:0,DetailedValueDecimals:0,convert:function(e){return e},minmax:function(){return{min:-105,max:0}}}}function c(){return{Unit:"°C",UnitName:"degree-Celsius",ValueDecimals:1,DetailedValueDecimals:1,convert:function(e){return e},minmax:function(){return{min:-40,max:80}}}}function u(){return{Unit:"V",UnitName:"Volts",ValueDecimals:2,DetailedValueDecimals:2,convert:function(e){return e},minmax:function(){return{min:0,max:3.3}}}}function d(){return{Unit:"",UnitName:"",ValueDecimals:0,DetailedValueDecimals:0,convert:function(e){return e},minmax:function(){}}}function r(){return{Unit:"g",UnitName:"g",ValueDecimals:3,DetailedValueDecimals:3,convert:function(e){return e},minmax:function(){return{min:-16,max:16}}}}function s(){return{Unit:"dsp",UnitName:"dsp",ValueDecimals:3,DetailedValueDecimals:3,convert:function(e){return e},minmax:function(){return{min:-250,max:250}}}}function l(){return{Unit:"dBm",UnitName:"Decibel-milliwatts",ValueDecimals:0,DetailedValueDecimals:0,convert:function(e){return e},minmax:function(){return{min:-105,max:0}}}}function c(){return{Unit:"°C",UnitName:"degree-Celsius",ValueDecimals:1,DetailedValueDecimals:1,convert:function(e){return e},minmax:function(){return{min:-40,max:80}}}}function u(){return{Unit:"V",UnitName:"Volts",ValueDecimals:2,DetailedValueDecimals:2,convert:function(e){return e},minmax:function(){return{min:0,max:3.3}}}}function d(){return{Unit:"",UnitName:"",ValueDecimals:0,DetailedValueDecimals:0,convert:function(e){return e},minmax:function(){}}}function m(){return{Unit:"pF",UnitName:"Piko-farads",ValueDecimals:3,DetailedValueDecimals:3,convert:function(e){return e},minmax:function(){return{min:0,max:26}}}}function r(){return{Unit:"g",UnitName:"g",ValueDecimals:3,DetailedValueDecimals:3,convert:function(e){return e},minmax:function(){return{min:-200,max:200}}}}function l(){return{Unit:"dBm",UnitName:"Decibel-milliwatts",ValueDecimals:0,DetailedValueDecimals:0,convert:function(e){return e},minmax:function(){return{min:-105,max:0}}}}function c(){return{Unit:"°C",UnitName:"degree-Celsius",ValueDecimals:1,DetailedValueDecimals:1,convert:function(e){return e},minmax:function(){return{min:-40,max:80}}}}function u(){return{Unit:"V",UnitName:"Volts",ValueDecimals:2,DetailedValueDecimals:2,convert:function(e){return e},minmax:function(){return{min:0,max:3.3}}}}function d(){return{Unit:"",UnitName:"",ValueDecimals:0,DetailedValueDecimals:0,convert:function(e){return e},minmax:function(){}}}function m(){return{Unit:"pF",UnitName:"Piko-farads",ValueDecimals:3,DetailedValueDecimals:3,convert:function(e){return e},minmax:function(){return{min:-8.192,max:8.192}}}}function r(){return{Unit:"g",UnitName:"g",ValueDecimals:3,DetailedValueDecimals:3,convert:function(e){return e},minmax:function(){return{min:-200,max:200}}}}function l(){return{Unit:"dBm",UnitName:"Decibel-milliwatts",ValueDecimals:0,DetailedValueDecimals:0,convert:function(e){return e},minmax:function(){return{min:-105,max:0}}}}function c(){return{Unit:"°C",UnitName:"degree-Celsius",ValueDecimals:1,DetailedValueDecimals:1,convert:function(e){return e},minmax:function(){return{min:-40,max:80}}}}function u(){return{Unit:"V",UnitName:"Volts",ValueDecimals:2,DetailedValueDecimals:2,convert:function(e){return e},minmax:function(){return{min:0,max:3.3}}}}function d(){return{Unit:"",UnitName:"",ValueDecimals:0,DetailedValueDecimals:0,convert:function(e){return e},minmax:function(){}}}function f(e,t,n,a,o,i,r,s){var l,c=this;function u(e,t){return r.upload(e,t).catch((function(e){throw"Cannot add configuration upload task."}))}function d(){m("The configuration has been successfully updated, it will be uploaded to the device during next connection.")}function m(e){i.show(i.simple().position("bottom right").textContent(e).hideDelay(3e3))}function f(e,t,n,a){if(e=parseFloat(e),isNaN(e))throw"Cannot parse "+a;if(e<t||e>n)throw a+" is out of range.";return e}function p(e){return a=1.8,(t=1.8*e/65472)<(n=0)?n:t>a?a:t;var t,n,a}function g(e){return e/10}function v(e){return Math.round(10*e)}function h(e){return Math.round(1023*e*64/1.8)}function w(e,t,n,a,o){var i=(o-a)/(n-t),r=i*e+(-i*t+a);if(r-1==65535&&r--,r<0||r>65535)throw"Invalid form data.";return r}c.authentication=e,c.loading=!1,c.fault=!1,c.bcm,c.config,c.cal={maxLoad:6553.5,tpc:{max:{load:6553.5,voltage:1.8},min:{load:0,voltage:0}}},c.get=function(){var e,n;c.loading=!0,(n=t.bcmId,a.get({bcmId:n}).$promise.catch((function(e){throw"Cannot add configuration upload task."}))).then((function(t){return function(e){return r.get(e).catch((function(e){throw"Cannot load Bolt-Cap configuration."}))}(e=t)})).then((function(t){return function(e,t){if(!e||!t)throw"Invalid data.";c.bcm=e,c.config=t,l=_.cloneDeep(t),c.cal.maxLoad=g(t.primary.maximumAdc).toFixed(1),c.cal.tpc.max.load=g(t.primary.maximumUnit).toFixed(1),c.cal.tpc.max.voltage=p(t.primary.maximumRange).toFixed(3),c.cal.tpc.min.load=g(t.primary.minimumUnit).toFixed(1),c.cal.tpc.min.voltage=p(t.primary.minimumRange).toFixed(3)}(e,t)})).then((function(){c.loading=!1})).catch((function(e){c.loading=!1,c.fault=!0,m(e)}))},c.submit=function(e){if(c.bcm)try{!function(){var e=_.cloneDeep(c.cal);if(e.maxLoad=v(f(e.maxLoad,0,6553.5,"Max. bolt tensile load rating (kN)")),e.tpc.max.load=v(f(e.tpc.max.load,0,6553.5,"Max. calibration load (kN)")),e.tpc.max.voltage=h(f(e.tpc.max.voltage,0,1.8,"Max. calibration load (V)")),e.tpc.min.load=v(f(e.tpc.min.load,0,6553.5,"Unloaded bolt (kN)")),e.tpc.min.voltage=h(f(e.tpc.min.voltage,0,1.8,"Unloaded bolt (V)")),e.tpc.min.load>=e.tpc.max.load)throw"Unloaded bolt (kN) is greater than or equal to Max. calibration load (kN).";if(e.tpc.min.voltage>=e.tpc.max.voltage)throw"Unloaded bolt (V) is greater than or equal to Max. calibration load (V).";if(e.tpc.min.load<0||e.tpc.min.load>e.maxLoad)throw"Unloaded bolt (kN) is out of range.";if(e.tpc.max.load<0)throw"Max. calibration load (kN) is out of range.";c.config.primary.minimumUnit=0,c.config.primary.maximumUnit=e.tpc.max.load,c.config.primary.minimumRange=w(0,e.tpc.min.load,e.tpc.max.load,e.tpc.min.voltage,e.tpc.max.voltage),c.config.primary.maximumRange=w(e.tpc.max.load,e.tpc.min.load,e.tpc.max.load,e.tpc.min.voltage,e.tpc.max.voltage),c.config.primary.minimumAdc=0,c.config.primary.maximumAdc=e.maxLoad}();var t=_.cloneDeep(c.config);if(t.primary.minimumRange=parseInt(t.primary.minimumRange),t.primary.maximumRange=parseInt(t.primary.maximumRange),t.primary.minimumUnit=parseInt(t.primary.minimumUnit),t.primary.maximumUnit=parseInt(t.primary.maximumUnit),t.primary.minimumAdc=parseInt(t.primary.minimumAdc),t.primary.maximumAdc=parseInt(t.primary.maximumAdc),!!angular.equals(t,l))return void o.back("core.devices.bcm.start");var n=s.confirm().parent(angular.element(document.querySelector("body"))).clickOutsideToClose(!1).title("Configuration").textContent("This operation will permanently overwrite the existing calibration. Are you sure you want to proceed?").ok("Okay").cancel("Cancel");s.show(n).then((function(){return c.loading=!0,u(c.bcm,t).then((function(){c.loading=!1,d(),o.back("core.devices.bcm.start")})).catch((function(e){c.loading=!1,m(e)}))}),(function(){console.log("canceled")}))}catch(e){m(e)}},c.reset=function(){var e=s.confirm().parent(angular.element(document.querySelector("body"))).clickOutsideToClose(!1).title("Configuration").textContent("This operation will permanently overwrite the existing calibration. Are you sure you want to proceed?").ok("Okay").cancel("Cancel");s.show(e).then((function(){var e=_.cloneDeep(c.config);return e.primary.minimumRange=0,e.primary.maximumRange=65535,e.primary.minimumUnit=0,e.primary.maximumUnit=65535,e.primary.minimumAdc=0,e.primary.maximumAdc=65535,c.loading=!0,u(c.bcm,e).then((function(){c.loading=!1,d(),o.back("core.devices.bcm.start")})).catch((function(e){c.loading=!1,m(e)}))}),(function(){console.log("canceled")}))},c.download=function(){var e;c.bcm&&(c.loading=!0,(e=c.bcm,r.download(e).catch((function(e){throw"Cannot add configuration download task."}))).then((function(){c.loading=!1,m("The configuration will be downloaded from the device during next connection."),o.back("core.devices.bcm.start")})).catch((function(e){c.loading=!1,m(e)})))}}angular.module(a.applicationModuleName,a.applicationModuleVendorDependencies),angular.module(a.applicationModuleName).config(["$locationProvider","$compileProvider","$mdThemingProvider",function(e,t,n){e.hashPrefix("!"),t.debugInfoEnabled(!1),n.theme("default").primaryPalette("grey",{default:"900","hue-1":"800","hue-2":"700","hue-3":"600"}).accentPalette("orange",{default:"500","hue-1":"400","hue-2":"300","hue-3":"200"})}]).run(["$rootScope","$location","Authentication",function(e,t,n){e.authentication=n,e.$on("$stateChangeSuccess",(function(t,n,a,o,i){e.$prevState=o}))}]),angular.element(document).ready((function(){"#_=_"===window.location.hash&&(window.location.hash="#!"),angular.bootstrap(document,[a.applicationModuleName])})),a.registerModule("firmware"),a.registerModule("mt"),a.registerModule("core"),a.registerModule("astute"),a.registerModule("wa"),a.registerModule("atl"),a.registerModule("sop"),a.registerModule("td"),a.registerModule("cw"),a.registerModule("users"),a.registerModule("bcm"),angular.module("firmware").config(["$stateProvider",function(e){e.state("core.devices.firmware",{abstract:!0,url:"/firmware",template:"<div ui-view></div>"}).state("core.devices.firmware.start",{url:"/",templateUrl:"modules/firmware/views/coming-soon.client.view.html"})}]),angular.module("firmware").controller("FirmwareController",["$rootScope",function(e){e.section="devices.firmware"}]),angular.module("mt").config(["$stateProvider",function(e){e.state("core.devices.mt",{abstract:!0,url:"/mt",templateUrl:"modules/mt/views/mt-content.client.view.html"}).state("core.devices.mt.start",{url:"/",templateUrl:"modules/mt/views/mt-individual.client.view.html"}).state("core.devices.mt.edit",{url:"/edit/:mtId",templateUrl:"modules/mt/views/mt-edit.client.view.html"}).state("core.devices.mt.edit-sleep",{url:"/edit-sleep/:mtId",templateUrl:"modules/mt/views/mt-edit-sleep.client.view.html"}).state("core.devices.mt.calibration",{url:"/calibration/:mtId",templateUrl:"modules/mt/views/mt-calibration.client.view.html"}).state("core.devices.mt.stats",{url:"/statistics/:mtId",templateUrl:"modules/mt/views/mt-statistics.client.view.html"}).state("core.devices.mt.connecting",{url:"/connecting/:mtId/:request/:next",templateUrl:"modules/mt/views/mt-connecting.client.view.html"}).state("core.devices.mt.stream",{url:"/stream/:mtId",templateUrl:"modules/mt/views/mt-stream.client.view.html"})}]),angular.module("mt").controller("MtController",["$rootScope","$scope","Authentication","$mdToast","MtSocket",function(e,t,n,a,o){t.authentication=n,e.section="devices.mt",t.$on("$destroy",(function(){}))}]),angular.module("mt").controller("MtStreamController",["$rootScope","$scope","$q","$state","$stateParams","$interval","$window","TdDialog","Authentication","Mt","MtStream","TdAdvert","MtConnectionStatus",function(e,t,n,a,o,i,r,s,m,f,p,h,w){var y=this,b=null,x=!1,C=60,S=1e3;y.authentication=m,y.loadingDevice=!1,y.loadingSamples=!1,y.sample=null,y.samples=[],y.tensionUnit=null,y.tensionValue=null,y.chartConfig={options:{chart:{zoomType:"x",animation:!1},exporting:{enabled:!1},plotOptions:{series:{borderWidth:0,animation:!1,marker:{enabled:!1}}}},credits:{enabled:!1},legend:{width:300,itemWidth:150,itemStyle:{width:150}},title:{text:""},xAxis:{type:"datetime",title:{text:"Date"}},yAxis:[{labels:{format:"{value} V",style:{color:Highcharts.getOptions().colors[0]}},title:{text:"Battery Voltage",style:{color:Highcharts.getOptions().colors[0]}}},{title:{text:"Temperature",style:{color:Highcharts.getOptions().colors[1]}},labels:{format:"{value} °C",style:{color:Highcharts.getOptions().colors[1]}},opposite:!0}],series:[{name:"Battery Voltage",type:"line",yAxis:0,data:E(),tooltip:{valueSuffix:" V"}},{name:"Temperature",type:"line",yAxis:1,data:E(),tooltip:{valueSuffix:" °C"}}],func:function(e){b=e}};var $=e.$on("$stateChangeStart",(function(e,t,n,a,o,i){if(!0===x)return;x=!0,e.preventDefault(),M(t.name)}));function D(e){var t="Do not leave this page during connection, please navigate back first to disconnect first.";return e.returnValue=t,t}function A(e){}t.$on("$destroy",(function(){$(),h.removeListener("advert",q),w.removeListener("status",O),p.removeListener("sample",P),p.removeListener("state",V),r.removeEventListener("beforeunload",D),r.removeEventListener("unload",A),b=null})),r.addEventListener("beforeunload",D),r.addEventListener("unload",A);var I={tension:{title:"Tension",units:[new v,new g],allowedUnits:function(){return k()?[0,1]:[0]},defaultUnit:function(){return k()?1:0}},temperature:{title:"Temperature",units:[new c]},batteryVoltage:{title:"Battery Voltage",units:[new u]},remoteRssi:{title:"RSSI (Remote)",units:[new l]},packetCounter:{title:"Packet Counter",units:[new d],minmax:{min:0,max:255}}};function k(){if(!y.config||!y.config.primary)return!1;var e=y.config.primary;return!(0===e.minimumRange&&65535===e.maximumRange&&0===e.minimumUnit&&65535===e.maximumUnit)}function U(e){var t=y.channels[e].selectedChannel,n=I[t];y.channels[e].availableUnits=n.units.filter((function(e,t){return!n.allowedUnits||-1!==n.allowedUnits().indexOf(t)})).map((function(e,t){return{name:e.Unit,value:t.toString()}}));var a=0;n.defaultUnit&&(a=n.defaultUnit()),y.channels[e].selectedUnit=y.channels[e].availableUnits[a],L(e)}function T(e){L(e)}function L(e){var t=function(e){const t=y.channels[e];var n=I[t.selectedChannel],a=n.units[parseInt(t.selectedUnit.value)];return{def:n,unit:a,unit:a}}(e);b.yAxis[e].update(function(e,t,n){return{labels:{format:"{value:."+t.ValueDecimals+"f}",style:{color:Highcharts.getOptions().colors[n]}},title:{text:e.title+(t.Unit?" ("+t.Unit+")":""),style:{color:Highcharts.getOptions().colors[n]}},startOnTick:!0,endOnTick:!0}}(t.def,t.unit,e));var n=function(e,t){if(e.minmax)return{min:e.minmax.min,max:e.minmax.max};var n=t.minmax(y.config.primary);if(n)return{min:n.min,max:n.max};return{min:void 0,max:void 0}}(t.def,t.unit);b.yAxis[e].setExtremes(n.min,n.max),b.series[e].update(function(e,t,n){return{name:e.title+(t.Unit?" ("+t.Unit+")":""),type:"line",yAxis:n,data:B(n,y.config.primary),tooltip:{valueSuffix:t.Unit?" ("+t.Unit+")":"",valueDecimals:t.DetailedValueDecimals}}}(t.def,t.unit,e))}function q(e,t){e===y.mt.uuid&&console.log(t)}function O(e,t){e===y.mt.uuid&&console.log(e,t)}function P(e,t){e===y.mt.uuid&&t&&(y.sample=t,y.loadingSamples=!1,b&&function(e){if(!b)return;const t=I.tension,n=t.units[t.defaultUnit()];y.tensionUnit=n.Unit,y.tensionValue=n.convert(e.tension,y.config.primary);var a=Date.now();y.samples.unshift({timestamp:a,sample:e});for(;y.samples.length>C;)y.samples.pop();W(0,a,e,y.config.primary),W(1,a,e,y.config.primary),b.xAxis[0].setExtremes(a-C*S,a),b.redraw()}(t))}function V(e,t,n){e===y.mt.uuid&&("error"===t?(s.error("Data Stream",void 0,n),M("core.devices.mt.start")):"completed"===t&&console.log("completed"))}function M(e){a.go("core.devices.mt.connecting",{mtId:y.mt._id,request:"stop-stream",next:e})}function W(e,t,n,a){b.series[e].addPoint(R(e,t,n,a),!1,!0)}function R(e,t,n,a){var o=y.channels[e].selectedChannel,i=parseInt(y.channels[e].selectedUnit.value);return[t,I[o].units[i].convert(n[o],a)]}function B(e,t){for(var n=[],a=(new Date).getTime(),o=C-1;o>=0;o--){var i=a+-o*S,r=null;y.samples&&y.samples[o]&&y.samples[o].timestamp&&y.samples[o].sample&&(i=parseInt(y.samples[o].timestamp),r=y.samples[o].sample),r?n.push(R(e,i,r,t)):n.push([i,0])}return n}function E(){var e,t=[],n=(new Date).getTime();for(e=-C;e<=0;e++)t.push({x:n+e*S,y:0});return t}y.channels=[{selectedChannel:"tension",channelChanged:function(){U(0)},selectedUnit:{value:"0",name:"V"},availableUnits:[{value:"0",name:"V"}],unitChanged:function(){T(0)},style:{color:Highcharts.getOptions().colors[0]}},{selectedChannel:"temperature",channelChanged:function(){U(1)},selectedUnit:{value:"0",name:"°C"},availableUnits:[{value:"0",name:"°C"}],unitChanged:function(){T(1)},style:{color:Highcharts.getOptions().colors[1]}}],y.get=function(){y.loadingSamples=!0,(y.loadingDevice=!0,f.get({mtId:o.mtId}).$promise.then((function(e){y.mt=e,y.advert=e.advertisement,y.config=e.config,y.loadingDevice=!1}),(function(e){throw y.loadingDevice=!1,s.error("MT Error",e,"Cannot find MT device in the data base."),e}))).then((function(){h.on("advert",q),w.on("status",O),p.on("sample",P),p.on("state",V),U(0),U(1)}),(function(e){s.error("MT Error",e,"Canot load MT.")}))}}]),angular.module("mt").controller("MtEditController",["Authentication","$stateParams","TdDialog","Mt","StateHelper","$mdToast","MtConfig",o]),angular.module("mt").controller("MtIndividualController",["$scope","$state","$window","Mt","MtStream","MtConnectionStatus","TdDialog","TdAdvert","MtSocket",function(e,t,n,a,o,i,r,s,l){var c=this;e.$on("$destroy",(function(){c.selected[0]?sessionStorage.setItem("mt.individual.selected",c.selected[0].uuid):sessionStorage.setItem("mt.individual.selected",void 0),sessionStorage.setItem("mt.individual.query",JSON.stringify(c.query)),s.removeListener("advert",p),i.removeListener("status",f),l.removeListener("app:mt:config-state",g)})),c.isLoading=!1,c.selected=[],c.section="devices";var u=sessionStorage.getItem("mt.individual.query"),d=sessionStorage.getItem("mt.individual.selected");c.query=u?JSON.parse(u):{order:"uuid",limit:10,page:1};function m(e){return _.find(c.mts.devices,(function(t){return e===t.uuid}))}function f(e,t){var n=m(e);n&&_.set(n,"connection.status",t)}function p(e,t){var n=m(e);n&&_.set(n,"advertisement",t)}function g(e,t,n){if("upload"===t||"download"===t){var a=m(e);a&&(_.set(a,"config.timestamp",n.timestamp),_.set(a,"config.primary",n.primary))}}c.get=function(){c.isLoading=!0,function(e){return a.query(e).$promise.catch((function(e){throw r.error("MT Request",e,"Cannot load MT devices."),e}))}({order:c.query.order,skip:(c.query.page-1)*c.query.limit,limit:c.query.limit}).then((function(e){c.mts=e,d&&c.mts.devices.forEach((function(e){e.uuid===d&&(c.selected[0]=e)})),i.on("status",f),s.on("advert",p),l.on("app:mt:config-state",g),c.isLoading=!1})).catch((function(e){c.isLoading=!1}))},c.stream=function(){c.selected[0]&&(c.isLoading=!0,o.request(c.selected[0]).then((function(){c.isLoading=!1,t.go("core.devices.mt.connecting",{mtId:c.selected[0]._id,request:"start-stream"})}),(function(e){c.isLoading=!1,r.error("MT Error",e,"Cannot start data stream.")})))},c.statistics=function(){c.selected[0]&&t.go("core.devices.mt.stats",{mtId:c.selected[0]._id})},c.calibration=function(){c.selected[0]&&t.go("core.devices.mt.calibration",{mtId:c.selected[0]._id})},c.editSleep=function(){c.selected[0]&&t.go("core.devices.mt.edit-sleep",{mtId:c.selected[0]._id})},c.edit=function(){c.selected[0]&&t.go("core.devices.mt.edit",{mtId:c.selected[0]._id})}}]),angular.module("mt").controller("MtStatisticsController",["$scope","Authentication","$q","$stateParams","TdDialog","TdAdvert","MtSample","Mt","MtConnectionStatus","StateHelper","$window",function(e,t,n,a,o,i,r,s,m,f,p){var g=this,v=200,h=[],w=null,y=0,b=null,x=null,C={measurement:{title:"Temperature",units:[new d]},rssi:{title:"RSSI",units:[new l]},temperature:{title:"Temperature",units:[new c]},batteryVoltage:{title:"Battery Voltage",units:[new u]},restartsUnknown:{title:"Unknown Restarts",units:[new d]},restartsSoftware:{title:"Software Restarts",units:[new d]},restartsWatchdog:{title:"Watchdog Restarts",units:[new d]},configNumber:{title:"Configuration Number",units:[new d]},packetCounter:{title:"Packet Counter",units:[new d]}};function S(e,t){e===g.mt.uuid&&(g.mt||(g.mt={}),g.mt.connection||(g.mt.connection={}),g.mt.connection.status=t)}function $(e,t){e===g.mt.uuid&&(g.mt||(g.mt={}),g.mt.advertisement=t,g.advert=t)}function D(e,t){if(e===g.mt.uuid){var n,a=w;if(w=t,!0!==g.loadingSamples)if(!a||a.packetCounter!==t.packetCounter)if(!(t.timestamp<new Date(2010,1,1,1,0,0,0).getTime()))y+=1,k(t),O(0,n=t),O(1,n)}}function A(){return g.loadingSamples=!0,b.showLoading("Loading..."),(e=y,t=v,r.query({uuid:g.mt.uuid,skip:e,limit:t})).then((function(e){return g.loadingSamples=!1,b.hideLoading(),e.samplesList&&(y+=e.samplesList.length),e.samplesList}),(function(e){throw g.loadingSamples=!1,b.hideLoading(),o.error("Load Samples",e,"Cannot load samples."),e}));var e,t}function I(){q(0),q(1)}function k(e){e&&h.push(e)}function U(e){e&&h.unshift(e)}function T(e){var t=g.channels[e].selectedChannel,n=C[t];g.channels[e].availableUnits=n.units.filter((function(e,t){return!n.allowedUnits||-1!==n.allowedUnits().indexOf(t)})).map((function(e,t){return{name:e.Unit,value:t.toString()}}));var a=0;n.defaultUnit&&(a=n.defaultUnit()),g.channels[e].selectedUnit=g.channels[e].availableUnits[a],q(e)}function L(e){q(e)}function q(e){var t=g.channels[e].selectedChannel,n=parseInt(g.channels[e].selectedUnit.value),a=C[t],o=a.title,i=a.units[n],r=i.Unit,s=i.ValueDecimals,l=i.DetailedValueDecimals;b.yAxis[e].update({labels:{format:"{value:."+s+"f}",style:{color:Highcharts.getOptions().colors[e]}},title:{text:o+(r?" ("+r+")":""),style:{color:Highcharts.getOptions().colors[e]}}}),b.series[e].update({name:o+(r?" ("+r+")":""),type:"line",yAxis:e,data:h.map((function(e){return[e.timestamp,i.convert(e[t],e)]})),tooltip:{valueSuffix:r?" ("+r+")":"",valueDecimals:l}})}function O(e,t){var n=g.channels[e].selectedChannel,a=parseInt(g.channels[e].selectedUnit.value),o=C[n].units[a];b.series[e].addPoint([t.timestamp,o.convert(t[n],t)])}e.$on("$destroy",(function(){i.removeListener("advert",$),r.removeListener("sample",D),m.removeListener("status",S),x&&x()})),g.authentication=t,g.loadingDevice=!1,g.loadingSamples=!1,g.mt,g.advert,g.config,g.channels=[{selectedChannel:"measurement",channelChanged:function(){T(0)},selectedUnit:{value:"0",name:"V"},availableUnits:[{value:"0",name:"V"}],unitChanged:function(){L(0)},style:{color:Highcharts.getOptions().colors[0]}},{selectedChannel:"temperature",channelChanged:function(){T(1)},selectedUnit:{value:"0",name:"°C"},availableUnits:[{value:"0",name:"°C"}],unitChanged:function(){L(1)},style:{color:Highcharts.getOptions().colors[1]}}],g.get=function(){(g.loadingDevice=!0,s.get({mtId:a.mtId}).$promise.then((function(e){g.mt=e,g.advert=e.advertisement,g.config=e.config,g.loadingDevice=!1}),(function(e){throw g.loadingDevice=!1,o.error("MT Error",e,"Cannot find MT device in the data base."),e}))).then((function(){var e,t,n;return b=new Highcharts.Chart({plotOptions:{series:{borderWidth:0,animation:!1,states:{hover:{enabled:!1}},marker:{enabled:!1}}},chart:{zoomType:"x",renderTo:"chart",animation:!1},legend:{width:300,itemWidth:150,itemStyle:{width:150}},credits:{enabled:!1},title:{text:""},xAxis:{title:{text:"Date"},type:"datetime"},yAxis:[{labels:{format:"{value} V",style:{color:Highcharts.getOptions().colors[0]}},title:{text:"Battery Voltage",style:{color:Highcharts.getOptions().colors[0]}}},{title:{text:"Temperature",style:{color:Highcharts.getOptions().colors[1]}},labels:{format:"{value} °C",style:{color:Highcharts.getOptions().colors[1]}},opposite:!0}],series:[{name:"Battery Voltage",type:"line",yAxis:0,data:[],tooltip:{valueSuffix:" V"}},{name:"Temperature",type:"line",yAxis:1,data:[],tooltip:{valueSuffix:" °C"}}]}),e=angular.element("#chart"),t=0,n=setInterval((function(){e.width()!==t&&(t=e.width(),b.setSize(t,b.height))}),500),x=function(){clearInterval(n)},A()})).then((function(e){w=e[0],T(0),function(e){for(var t=e.length-1;t>=0;t--)k(e[t])}(e),I(),i.on("advert",$),r.on("sample",D),m.on("status",S)}))},g.loadMore=function(){A().then((function(e){!function(e){for(var t=0;t<e.length;t++)U(e[t])}(e),I()}))}}]),angular.module("mt").controller("MtEditSleepController",["$scope","Authentication","$stateParams","TdDialog","Mt","StateHelper","$mdToast","MtConfig","$q",function(e,t,n,a,o,i,r,s,l){var c=this,u=null;function d(e){e=1e3*parseInt(e),c.advertWindows=c.availableAdvertWindows.filter((function(t){var n=parseInt(t.value);return e>n}));var t=parseInt(c.config.primary.advertWindowContactable);0===c.advertWindows.filter((function(e){return parseInt(e.value)===t})).length&&(c.config.primary.advertWindowContactable=c.advertWindows[0].value)}function m(e){r.show(r.simple().position("bottom right").textContent(e).hideDelay(3e3))}c.authentication=t,c.loading=!1,c.fault=!1,c.mt,c.advertIntervals=[{value:"5",text:"5 secounds"},{value:"10",text:"10 secounds"},{value:"20",text:"20 secounds"},{value:"30",text:"30 seconds"},{value:"60",text:"1 minute"},{value:"120",text:"2 minutes"},{value:"300",text:"5 minutes"},{value:"600",text:"10 minutes"},{value:"1200",text:"20 minutes"},{value:"1800",text:"30 minutes"},{value:"3600",text:"1 hour"}],c.availableAdvertWindows=[{value:"900",text:"900 milliseconds"},{value:"1000",text:"1 second"},{value:"2000",text:"2 seconds"},{value:"3000",text:"3 seconds"},{value:"5000",text:"5 seconds"},{value:"8000",text:"8 seconds"},{value:"10000",text:"10 seconds"},{value:"20000",text:"20 seconds"},{value:"30000",text:"30 seconds"},{value:"40000",text:"40 seconds"},{value:"50000",text:"50 seconds"},{value:"60000",text:"1 minute"}],c.advertWindows=c.availableAdvertWindows,c.get=function(){var t,a;c.loading=!0,(a=n.mtId,o.get({mtId:a}).$promise.catch((function(e){throw"Cannot load MT."}))).then((function(e){return function(e){return s.get(e).catch((function(e){throw"Cannot load MT's configuration."}))}(t=e)})).then((function(n){return function(t,n){if(!t||!n)throw"Invalid data.";c.mt=t,c.config=n,u=_.cloneDeep(n),e.$watch(angular.bind(c,(function(){return this.config.primary.advertInterval})),d)}(t,n)})).then((function(){c.loading=!1})).catch((function(e){c.loading=!1,c.fault=!0,m(e)}))},c.submit=function(e){if(c.mt){var t=_.cloneDeep(c.config);t.primary.advertInterval=parseInt(c.config.primary.advertInterval),t.primary.advertWindowContactable=parseInt(c.config.primary.advertWindowContactable),angular.equals(t,u)?i.back("core.devices.mt.start"):(c.loading=!0,function(e,t){return s.upload(e,t).catch((function(e){throw"Cannot add configuration upload task."}))}(c.mt,t).then((function(){c.loading=!1,m("The configuration has been successfully updated, it will be uploaded to the device during next connection."),i.back("core.devices.mt.start")})).catch((function(e){c.loading=!1,m(e)})))}}}]),angular.module("mt").controller("MtConnectingController",["Authentication","$rootScope","$scope","$q","$stateParams","$state","$window","TdDialog","$mdToast","StateHelper","TdAdvert","Mt","MtStream","MtConnectionStatus",function(e,t,n,a,o,i,r,s,l,c,u,d,m,f){var p=this,g=!1,v={advert:"Waiting for advertisement...",connecting:"Connecting...",configuring:"Configuring...",disconnecting:"Disconnecting...",disconnected:"Disconnected",canceling:"Cancelling..."},h=t.$on("$stateChangeStart",(function(e,t,n,a,o,i){if(g)return;console.log("unexpected state change"),e.preventDefault(),p.canCancel?(console.log("can cancel"),C()):(console.log("cannot cancel"),S("error","Cannot cancel request."))}));function w(e){console.log("on before unload");return e.returnValue="Operation in progress, please don't unload the window","Operation in progress, please don't unload the window"}function y(e){}n.$on("$destroy",(function(){u.removeListener("advert",I),f.removeListener("status",k),r.removeEventListener("beforeunload",w),r.removeEventListener("unload",y),h()})),r.addEventListener("beforeunload",w),r.addEventListener("unload",y);var b=null;function x(){switch(-1!==b.request.indexOf("start")?p.message=v.advert:-1!==b.request.indexOf("stop")&&(p.message=v.disconnecting),b.request){case"start-stream":(console.log("wait stream"),a((function(e,t){var n=function(t,a,o){p.mt.uuid===t&&("started"===a?(m.removeListener("state",n),e()):"error"===a&&S("error",o))};m.on("state",n)}))).then((function(){A("core.devices.mt.stream",{mtId:p.mt._id})}),(function(){D()}));break;case"stop-stream":$().then((function(){D()}),(function(){D()}))}}function C(){switch(p.message=v.canceling,b.request){case"start-stream":$().then((function(){D()}),(function(){D()}))}}function S(e,t){l.show(l.simple().position("bottom right").textContent(t).hideDelay(3e3))}function $(){return a((function(e,t){m.cancelRequest(p.mt).then((function(){e()}),(function(e){s.error("MT Error",e,"Cannot stop data stream."),t()}))}))}function D(){b.next&&"core.devices.mt.connecting"!==b.next?A(b.next):A("core.devices.mt.start")}function A(e,t){g=!0,i.go(e,t)}function I(e,t){e===p.mt.uuid&&console.log(t)}function k(e,t){if(e===p.mt.uuid){switch(t.label){case"Connecting...":p.message=v.connecting,p.canCancel=!1;break;case"Connected":p.message=v.configuring,p.canCancel=!1;break;case"Failure":p.message=v.advert,p.canCancel=!0;break;case"Disconnecting...":p.message=v.disconnecting,p.canCancel=!1;break;case"Disconnected":p.message=v.disconnected,p.canCancel=!1}console.log(e,t)}}p.authentication=e,p.loading=!1,p.canCancel=!0,p.mt=null,p.title="Connecting...",p.message="",p.get=function(){p.loading=!0,b={mtId:o.mtId,request:o.request,next:o.next},d.get({mtId:o.mtId}).$promise.then((function(e){p.mt=e})).then((function(){p.title="Connecting to "+p.mt.uuid,u.on("advert",I),f.on("status",k),p.loading=!1,x()}),(function(e){s.error("MT Error",e,"Cannot find device in the data base."),p.loading=!1}))},p.cancel=function(){C()}}]),angular.module("mt").controller("MtCalibrationController",["Authentication","$stateParams","TdDialog","Mt","StateHelper","$mdToast","MtConfig","$mdDialog",o]),angular.module("mt").factory("MtStream",["$q","MtSocket","Task",function(e,t,n){var a={sample:null,state:null};return t.on("app:mt:stream-sample",(function(e,t){a.sample&&a.sample(e,t)})),t.on("app:mt:stream-state",(function(e,t,n){a.state&&a.state(e,t,n)})),{request:function(e,t){var a=e.uuid;return o(a,1).then((function(e){return e.tasks.length?e.tasks[0]:new n({uuid:a,command:"stream",mode:"Individual"}).$save()}))},cancelRequest:function(t){return o(t.uuid).then((function(t){var a=t.tasks.map((function(e){return new n(e).$remove()}));return e.all(a)}))},on:function(e,t){"sample"===e?a.sample=t:"state"===e&&(a.state=t)},removeListener:function(e,t){"sample"===e?a.sample=null:"state"===e&&(a.state=null)}};function o(e,t){var a={uuid:e,command:"stream",order:"-createdOn",skip:0};return t&&(a.limit=t),n.query(a).$promise}}]),angular.module("mt").factory("Devices",["$resource",function(e){return e("api/devices/:deviceId",{deviceId:"@_id"},{update:{method:"PUT"}})}]),angular.module("mt").factory("LastDevices",["$resource",function(e){return e("api/lastDevices")}]),angular.module("mt").factory("GrowlMessage",[function(){return{success:function(e,t){i("success",e,t)},info:function(e,t){i("info",e,t)},warning:function(e,t){i("warning",e,t)},error:function(e,t){i("error",e,t)}}}]),angular.module("mt").factory("MtSocket",["socketFactory",function(e){var t=io.connect();return t.on("connect",(function(){t.emit("name","www")})),e({prefix:"app:mt:",ioSocket:t})}]),angular.module("mt").factory("MtConnectionStatus",["$q","MtSocket",function(e,t){var n={status:null};return t.on("app:mt:status",(function(e,t){n.status&&n.status(e,t)})),{on:function(e,t){"status"===e&&(n.status=t)},removeListener:function(e,t){"status"===e&&(n.status=null)}}}]),goog.require("proto.MtSample.Data"),goog.require("proto.MtSample.DataArray"),angular.module("mt").factory("MtSample",["$q","$resource","TdSocket","TdDialog",function(e,t,n,a){var o={sample:null},i=t("api/mt-sample",null,{get:{responseType:"arraybuffer",transformResponse:function(e,t){return{data:e}}}});return n.on("app:mt:sample",(function(e,t){if(o.sample){var n=proto.MtSample.Data.deserializeBinary(new Uint8Array(t));o.sample(e,n.toObject())}})),{query:function(t){return e((function(e,n){t.proto="protobuf",i.get(t).$promise.then((function(t){var n=proto.MtSample.DataArray.deserializeBinary(new Uint8Array(t.data));e(n.toObject())}),(function(e){n(e)}))}))},on:function(e,t){"sample"===e&&(o.sample=t)},removeListener:function(e,t){"sample"===e&&(o.sample=null)}}}]),angular.module("mt").factory("Mt",["$resource",function(e){return e("api/mt/:mtId",{mtId:"@_id"},{update:{method:"PUT"},query:{method:"GET",isArray:!1}})}]),angular.module("mt").factory("MtSamples",["$resource",function(e){return e("api/mt/samples/:mtDeviceId",{mtDeviceId:"@_id"},{update:{method:"PUT"}})}]),angular.module("mt").factory("DeviceSocket",["socketFactory",function(e){var t=io.connect();return t.on("connect",(function(){t.emit("name","www")})),e({prefix:"device:",ioSocket:t})}]),angular.module("mt").factory("StatusSocket",["socketFactory",function(e){var t=io.connect();return t.on("connect",(function(){t.emit("name","www")})),e({prefix:"status:",ioSocket:t})}]),angular.module("mt").factory("MtConfig",["Task",function(e){return{upload:function(t,n){var a=t.uuid;return new e({uuid:a,command:"upload",mode:"Individual",options:n}).$save()},download:function(t){var n=t.uuid;return function(t){return e.query({uuid:t,command:"download",order:"-createdOn",limit:1,skip:0}).$promise}(n).then((function(t){return t.tasks.length?t.tasks[0]:new e({uuid:n,command:"download",mode:"Individual"}).$save()}))},get:function(t){return(n=t.uuid,e.query({uuid:n,command:"upload",order:"-createdOn",limit:1,skip:0}).$promise).then((function(e){var n=e.tasks,a=n.length?n[0].options:t.config;return _.cloneDeep(a)}));var n}}}]),angular.module("core").directive("ngFileModel",["$parse",function(e){return{restrict:"A",link:function(t,n,a){var o=e(a.ngFileModel).assign;n.bind("change",(function(){t.$apply((function(){o(t,n[0].files)}))}))}}}]),angular.module("core").filter("tdVersion",(function(){return function(e){if(!e)return e;var t=e%100,n=(e=Math.round(e/100))%100;return(e=Math.round(e/100))+"."+n+"."+t}})),angular.module("core").filter("tdShortName",(function(){return function(e){if(!e)return"Unknown";switch(parseInt(e)){case 1:return"MT";case 5:return"BCM";case 6:return"DPM";case 7:return"LSW";default:return"Unknown"}}})),angular.module("core").filter("tdLongName",(function(){return function(e){if(!e)return"Unknown";switch(parseInt(e)){case 1:return"Temperature Logger";case 5:return"Bolt Cap Module";case 6:return"Data Processing Module";case 7:return"Limit Switch";default:return"Unknown"}}})),angular.module("core").filter("fromLastNHours",(function(){return function(e,t){var n=[];if(!e)return n;var a=new Date;a.setHours(a.getHours()-t);for(var o=a.getTime(),i=0;i<e.length;i++)Date.parse(e[i].timestamp)>=o&&n.push(e[i]);return n}})),angular.module("core").config(["$stateProvider","$urlRouterProvider",function(e,t){t.otherwise("/core/"),e.state("core",{abstract:!0,url:"/core",templateUrl:"modules/core/views/content.client.view.html"}).state("core.dashboard",{url:"/",templateUrl:"modules/core/views/home.client.view.html"}).state("core.network",{url:"/network",templateUrl:"modules/core/views/network.client.view.html"}).state("core.files-viewer-lvl0",{url:"/files",templateUrl:"modules/core/views/files-viewer.client.view.html"}).state("core.files-viewer-lvl1",{url:"/files/:lvl1",templateUrl:"modules/core/views/files-viewer.client.view.html"}).state("core.files-viewer-lvl2",{url:"/files/:lvl1/:lvl2",templateUrl:"modules/core/views/files-viewer.client.view.html"}).state("core.files-viewer-lvl3",{url:"/files/:lvl1/:lvl2/:lvl3",templateUrl:"modules/core/views/files-viewer.client.view.html"}).state("core.files-viewer-lvl4",{url:"/files/:lvl1/:lvl2/:lvl3/:lvl4",templateUrl:"modules/core/views/files-viewer.client.view.html"}).state("core.files-viewer-lvl5",{url:"/files/:lvl1/:lvl2/:lvl3/:lvl4/:lvl5",templateUrl:"modules/core/views/files-viewer.client.view.html"}).state("core.files-viewer-lvl6",{url:"/files/:lvl1/:lvl2/:lvl3/:lvl4/:lvl5/:lvl6",templateUrl:"modules/core/views/files-viewer.client.view.html"}).state("core.chart",{url:"/files/:deviceId/:dayId/:fileId",templateUrl:"modules/core/views/chart.client.view.html"}).state("core.lsw-file",{url:"/files/:deviceId/:dayId/:fileId/lsw",templateUrl:"modules/core/views/lsw-file.client.view.html"}).state("core.update",{url:"/update",templateUrl:"modules/core/views/update.client.view.html"}).state("core.reboot",{url:"/reboot",templateUrl:"modules/core/views/reboot.client.view.html"})}]).run(["$rootScope","$state","$location","Authentication",function(e,t,n,a){e.$on("$stateChangeStart",(function(e,t,o,i,r){"signin"!==t.name&&(a.user||n.path("signin"))}))}]),angular.module("core").controller("FilesDeviceDaysController",["$rootScope","$scope","$state","$stateParams","Files","Authentication",function(e,t,n,a,o,i){t.authentication=i,e.section="files",t.isCollapsed=!0,t.toggleCollapsibleMenu=function(){t.isCollapsed=!t.isCollapsed},t.$on("$stateChangeSuccess",(function(){t.isCollapsed=!0})),t.dayClick=function(e){e&&("Parent Directory"!==e.name?n.transitionTo("view-files-deivce-day-files",{deviceId:a.deviceId,dayId:e.name}):n.transitionTo("view-files-devices"))},o.query({deviceId:a.deviceId},(function(e){var n=[];n.push({icon:"icon-share-alt icon-rotate-180",name:"Parent Directory"}),e.forEach((function(e){n.push({icon:"icon-folder-open",name:e})})),t.days=n}))}]),angular.module("core").controller("CoreController",["$scope",function(e){}]),angular.module("core").controller("FilesController",["$rootScope","$scope","$state","$stateParams","Files","Authentication",function(e,t,n,a,o,i){var r=this;e.section="files",r.authentication=i;for(var s=0,l={},c=[],u=1;u<=6;++u){var d=a["lvl"+u];d&&(l["lvl"+u]=d,c.push(d),s++)}r.get=function(){o.query(l,(function(e){var t=[];0!==s&&t.push({name:"Parent Directory",icon:"subdirectory_arrow_left",time:void 0,size:void 0,type:"parent"}),e.sort((function(e,t){return Date.parse(t.mtime)-Date.parse(e.mtime)})).forEach((function(e){t.push({name:e.name,icon:"file"===e.type?"insert_drive_file":"folder",time:e.mtime,size:"file"===e.type?(e.size/1024).toFixed(0):"N/A",type:e.type})})),r.files=t}))},r.open=function(e){var t;"parent"===e.type?(t="core.files-viewer-lvl"+(s-1),n.go(t,l)):"directory"===e.type?function(e){var t=s+1,a="core.files-viewer-lvl"+t;l["lvl"+t]=e.name,n.go(a,l)}(e):"file"===e.type&&function(e){"astute"===l.lvl1&&n.go("core.devices.astute.log-view",{path:c.join("/")}),-1!==e.name.indexOf("sbd.gz")&&n.go("core.devices.sop.log-view",{path:c.join("/")+"/"+e.name}),-1!==e.name.indexOf("cwd.gz")&&n.go("core.devices.cw.log-view",{path:c.join("/")+"/"+e.name}),-1!==e.name.indexOf("wad.gz")&&n.go("core.devices.wa.log-view",{path:c.join("/")+"/"+e.name}),-1!==e.name.indexOf("waad.gz")&&n.go("core.devices.wa.evt-view",{path:c.join("/")+"/"+e.name}),-1!==e.name.indexOf("atd.gz")&&n.go("core.devices.atl.log-view",{path:c.join("/")+"/"+e.name})}(e)}}]),angular.module("core").controller("ChartController",["$rootScope","$scope","$stateParams","Files","Authentication","pandasConverter","GrowlMessage",function(e,t,n,a,o,i,r){function s(e,n,a,o){var r=function(e,t,n,a){var o,r,s,l,c,u={x:[],values:[0,0],minimumThreshold:{positive:0,negative:0},lowAlarmThreshold:{positive:0,negative:0},highAlarmThreshold:{positive:0,negative:0},triggerDelta:{positive:0,negative:0}},d=[0,2];for(o=0;o<2;o++)u.values[o]=[];for(r=0,s=e.length;r<s;r++)for(u.x.push(i.eventIndexToTime(r)),o=0;o<2;o++)u.values[o].push(i.adcToUnitValue(e[r][o],a,t.offsets[d[o]]));l=t.offsets[t.triggerChannel],"volts"===a?l=i.adcToUnitValue(l,a,0):"g"===a&&(l=0);return c=i.adcToUnitValue(t.minimumDelta,a,0),u.minimumThreshold.positive=l+c,u.minimumThreshold.negative=l-c,c=i.adcToUnitValue(t.triggerDelta,a,0),u.triggerDelta.positive=l+c,u.triggerDelta.negative=l-c,c=i.adcToUnitValue(n.lowAlarmThreshold,a,0),u.lowAlarmThreshold.positive=l+c,u.lowAlarmThreshold.negative=l-c,c=i.adcToUnitValue(n.highAlarmThreshold,a,0),u.highAlarmThreshold.positive=l+c,u.highAlarmThreshold.negative=l-c,u}(e,n,a,o);t.chartConfig.loading?function(e,n){t.chartConfig={options:{chart:{type:"line",zoomType:"x"}},credits:{enabled:!1},title:{text:"Acceleration"},legend:{enabled:!0,floating:!0,verticalAlign:"bottom",align:"right",y:15,width:300,itemWidth:150,itemStyle:{width:150}},tooltip:{useHTML:!0,shared:!0,formatter:function(){var e='<span style="font-size: 10px">'+Highcharts.numberFormat(.003*(this.points[0].x+1)-2)+" s</span><br/>";return angular.forEach(this.points,(function(t,n){e+='<span style="color:'+n.color+'">●</span> '+n.series.name+": <b>"+n.y+" g</b><br/>"})),e}},xAxis:{title:{text:"Time (s)"},labels:{format:"{value:.2f}"},categories:e.x,currentMin:0,currentMax:e.x.length-1,minRange:1},yAxis:{title:{text:"Acceleration ("+n+")"}},series:[{name:"Channel X",data:e.values[0],zIndex:700},{name:"Channel Y",data:e.values[1],zIndex:700},{name:"Minimum Threshold",color:"green",dashStyle:"shortdash",lineWidth:1,data:[[0,e.minimumThreshold.positive],[2047,e.minimumThreshold.positive]],marker:{enabled:!1},zIndex:800,enableMouseTracking:!1},{linkedTo:":previous",color:"green",dashStyle:"shortdash",lineWidth:1,data:[[0,e.minimumThreshold.negative],[2047,e.minimumThreshold.negative]],marker:{enabled:!1},zIndex:800,enableMouseTracking:!1},{name:"Low Alarm",color:"blue",dashStyle:"shortdash",lineWidth:1,data:[[0,e.lowAlarmThreshold.positive],[2047,e.lowAlarmThreshold.positive]],marker:{enabled:!1},zIndex:900,enableMouseTracking:!1},{linkedTo:":previous",color:"blue",dashStyle:"shortdash",lineWidth:1,data:[[0,e.lowAlarmThreshold.negative],[2047,e.lowAlarmThreshold.negative]],marker:{enabled:!1},zIndex:900,enableMouseTracking:!1},{name:"High Alarm",color:"red",dashStyle:"shortdash",lineWidth:1,data:[[0,e.highAlarmThreshold.positive],[2047,e.highAlarmThreshold.positive]],marker:{enabled:!1},zIndex:1e3,enableMouseTracking:!1},{linkedTo:":previous",color:"red",dashStyle:"shortdash",lineWidth:1,data:[[0,e.highAlarmThreshold.negative],[2047,e.highAlarmThreshold.negative]],marker:{enabled:!1},zIndex:1e3,enableMouseTracking:!1},{name:"Trigger Delta",color:"black",dashStyle:"shortdash",lineWidth:1,data:[[0,e.triggerDelta.positive],[2047,e.triggerDelta.positive]],marker:{enabled:!1},zIndex:1100,enableMouseTracking:!1},{linkedTo:":previous",color:"black",dashStyle:"shortdash",lineWidth:1,data:[[0,e.triggerDelta.negative],[2047,e.triggerDelta.negative]],marker:{enabled:!1},zIndex:1100,enableMouseTracking:!1}],loading:!1}}(r,o):function(e,n){t.chartConfig.yAxis.title.text="Acceleration ("+n+")",t.chartConfig.series[0].data=e.values[0],t.chartConfig.series[1].data=e.values[1],l(0,e.minimumThreshold.positive,e.minimumThreshold.negative),l(1,e.lowAlarmThreshold.positive,e.lowAlarmThreshold.negative),l(2,e.highAlarmThreshold.positive,e.highAlarmThreshold.negative),l(3,e.triggerDelta.positive,e.triggerDelta.negative),t.chartConfig.tooltip.valueSuffix=n,t.chartConfig.loading=!1}(r,o)}function l(e,t,n){c(2+2*e,t),c(2+2*e+1,n)}function c(e,n){t.chartConfig.series[e].data[0][1]=n,t.chartConfig.series[e].data[1][1]=n}t.authentication=o,e.section="files",t.isCollapsed=!0,t.toggleCollapsibleMenu=function(){t.isCollapsed=!t.isCollapsed},t.$on("$stateChangeSuccess",(function(){t.isCollapsed=!0})),t.unit="g",t.unitChanged=function(){s(t.eventData,t.dpmHeader,t.rsruHeader,t.unit)},t.chartConfig={options:{chart:{type:"line",zoomType:"x"}},title:{text:"Acceleration"},loading:!0},a.get({deviceId:n.deviceId,dayId:n.dayId,fileId:n.fileId},(function(e){t.eventData=e.event,t.dpmHeader=e.dpmHeader,t.rsruHeader=e.rsruHeader,s(t.eventData,t.dpmHeader,t.rsruHeader,t.unit)}),(function(e){t.chartConfig.loading=!1,r.error("Plot Chart","Cannot plot chart, invalid data")}))}]),angular.module("core").controller("RebootController",["$rootScope","$scope","Authentication","TransceiverReboot","GrowlMessage",function(e,t,n,a,o){t.authentication=n,e.section="reboot",t.reboot=function(){a.get((function(e){o.success("Reboot","The transceiver is rebooting... You may be unable to connect for up to two minutes.")}))}}]),angular.module("core").controller("HeaderController",["$scope","Authentication","Menus","$mdSidenav","$mdMedia",function(e,t,n,a,o){var i=this;i.authentication=t,i.toggleList=function(){a("left").toggle()},i.toolbarTitleFont="md-body-2",i.toolbarUserSettingsClass=["md-button","md-icon-button"],i.openMenu=function(e,t){t,e(t)},e.$watch((function(){return o("gt-xs")}),(function(e){i.toolbarTitleFont=e?"md-headline":"md-body-2"})),e.$watch((function(){return o("gt-sm")}),(function(e){i.toolbarUserSettingsClass=e?"md-button":["md-button","md-icon-button"]})),e.authentication=t,e.isCollapsed=!0,e.menu=n.getMenu("topbar"),e.toggleCollapsibleMenu=function(){e.isCollapsed=!e.isCollapsed},e.$on("$stateChangeSuccess",(function(){e.isCollapsed=!0}))}]),angular.module("core").controller("HomeController",["$rootScope","$scope","$interval","$q","Authentication","LastDevices","StatusSocket","GsmData",function(e,t,n,a,o,i,r,s){function l(e,n){t.GSM=e,t.GPS=n,t.showStatusPanel=t.GPS||t.GSM}function c(e){var n=_.find(t.lastDevices,(function(t){return e.uuid==t.uuid}));n?(n.timestamp=e.timestamp,n.rssi=e.rssi,n.type=e.type,n.temperature=e.temperature,n.batteryVoltage=e.batteryVoltage):t.lastDevices.unshift(e)}function u(e){d(e.sq)}function d(e){if(!t.gsmSignal||t.gsmSignal.value!==e){var n=function(e){var t=[{sq:99,percent:0,text:"Unknown",img:"gsm_unknown.gif"},{sq:8,percent:"",text:"Very poor",img:"gsm_very_poor.gif"},{sq:12,percent:"",text:"Poor",img:"gsm_poor.gif"},{sq:16,percent:"",text:"Fair",img:"gsm_fair.gif"},{sq:22,percent:"",text:"Good",img:"gsm_good.gif"},{sq:31,percent:"",text:"Excellent",img:"gsm_excellent.gif"}];if(e===t[0].sq)return t[0];for(var n=1;n<t.length;n++)if(!(e>t[n].sq)){var a=t[n];return a.percent=Math.round(100*e/31),a}return t[0]}(e);t.gsmSignal={value:e,percent:n.percent,text:n.text,icon:"/img/"+n.img}}}function m(e){t.location=e,t.map.center={latitude:e.latitude,longitude:e.longitude},t.marker.coords={latitude:e.latitude,longitude:e.longitude},f(e.horDilution)}function f(e){if(!t.gpsSignal||t.gpsSignal.value!==e){var n=function(e){var t=[{sq:99,text:"Unknown",img:"gsm_unknown.gif"},{sq:1,text:"Excellent",img:"gsm_excellent.gif"},{sq:2,text:"Good",img:"gsm_good.gif"},{sq:5,text:"Fair",img:"gsm_fair.gif"},{sq:10,text:"Poor",img:"gsm_poor.gif"},{sq:20,text:"Very poor",img:"gsm_very_poor.gif"}];if(e===t[0].sq)return t[0];for(var n=1;n<t.length;n++)if(!(e>=t[n].sq))return t[n];return t[0]}(e);t.gpsSignal={value:e,text:n.text,icon:"/img/"+n.img}}}e.section="dashboard",t.authentication=o,t.GPS=!1,t.GSM=!1,t.showStatusPanel=!1,t.location={timestamp:"",alt:0,direction:0,horDilution:99,latitude:55.098427,longitude:-1.611894,numSat:0,speed:0,status:"warning"},t.map={center:{latitude:t.location.latitude,longitude:t.location.longitude},zoom:14},t.marker={id:0,coords:{latitude:t.location.latitude,longitude:t.location.longitude}},t.$on("$destroy",(function(){r.removeListener("app:lastDevice",c),r.removeListener("gsm:data",u),r.removeListener("gps:location",m)})),t.get=function(){l(!1,!1),d(99),f(99),a.all([i.query().$promise,s.query({limit:1,skip:0}).$promise]).then((function(e){console.log(e),t.lastDevices=e[0],function(e){var t=99;if(0!==e.length){var n=new Date;n.setMinutes(n.getMinutes()-10),e[0].timestamp>n.getTime()&&(t=e[0].sq),d(t)}else d(t)}(e[1]),l(!0,!1),r.on("app:lastDevice",c),r.on("gsm:data",u),r.on("gsp:location",m)}))}}]),angular.module("core").controller("NetworkController",["$rootScope","$scope","$q","Authentication","NetworkGsmProviders","NetworkGsmConfig","GrowlMessage",function(e,t,n,a,o,i,r){e.section="network",t.authentication=a,t.types=["GSM","CDMA"],t.init=function(){t.isLoading=!0,n.all([o.query().$promise.then((function(e){return e.unshift({name:"Other"}),e})),i.query().$promise]).then((function(e){t.isLoading=!1,t.providers=e[0],t.config=e[1][0],t.config.provider?t.selectedProvider=function(e,t){for(var n=0;n<e.length;n++)if(e[n]._id===t)return e[n];return null}(t.providers,t.config.provider._id):t.selectedProvider=t.providers[0],t.config.type&&"GSM"!==t.config.type?t.selectedType=t.types[1]:t.selectedType=t.types[0]})).catch((function(e){t.isLoading=!1,console.log(e)}))},t.update=function(){"Other"===t.selectedProvider.name?t.config.provider=null:t.config.provider=t.selectedProvider._id,t.config.type=t.selectedType,t.config.$update((function(){r.success("Network Configuration","The network configuration has been updated successfully. Please restart the transceiver to apply these changes. You may be unable to connect for up to two minutes.")}),(function(e){r.error("Network Configuration",e.data.message)}))}}]),angular.module("core").controller("FilesDeviceDayFilesController",["$rootScope","$scope","$stateParams","$state","Files","Authentication","GrowlMessage",function(e,t,n,a,o,i,r){t.authentication=i,e.section="files",t.isCollapsed=!0,t.toggleCollapsibleMenu=function(){t.isCollapsed=!t.isCollapsed},t.$on("$stateChangeSuccess",(function(){t.isCollapsed=!0})),t.fileClick=function(e){if(e)if("Parent Directory"!==e.name){var t=null;e.name.indexOf("p2ad")>=0?t="chart":e.name.indexOf("json")>=0||e.name.indexOf("lsad")>=0?t="lsw-file":r.error("Load File","Unsupported file selected, please select other file and try again"),a.transitionTo(t,{deviceId:n.deviceId,dayId:n.dayId,fileId:e.name})}else a.transitionTo("view-files-device-days",{deviceId:n.deviceId})},o.query({deviceId:n.deviceId,dayId:n.dayId},(function(e){var n=[];n.push({icon:"icon-share-alt icon-rotate-180",name:"Parent Directory",time:"",size:""}),e.forEach((function(e){n.push({icon:"icon-file",name:e.name,time:e.mtime,size:e.size})})),t.files=n}))}]),angular.module("core").controller("MainController",["Authentication","$rootScope","$scope","$state","$window","$mdSidenav","$mdBottomSheet","$mdMedia",function(e,t,n,a,o,i,r,s){var l=this,c=s("gt-sm");t.section="dashboard",l.$rootScope=t,l.authentication=e,l.title="Dashboard",l.toolbarTitleFont="md-body-1",l.userSettingsClass=["md-button","md-icon-button"],l.toggleList=function(){c||i("left").toggle()},l.openMenu=function(e,t){e(t)},n.$watch((function(){return s("gt-xs")}),(function(e){l.toolbarTitleFont=e?"md-subhead":"md-body-1",l.userSettingsClass=e?"md-button":["md-button","md-icon-button"]})),n.$watch((function(){return s("gt-sm")}),(function(e){c=e,i("left").close()})),n.$watch((function(){return t.section}),(function(e){switch(e){case"dashboard":l.title="Dashboard";break;case"files":l.title="Files";break;case"devices.astute":l.title="Devices > Astute";break;case"devices.mt":l.title="Devices > Temperature";break;case"devices.bcm":l.title="Devices > Bolt-Cap";break;case"devices.sop":l.title="Devices > Smart-Oil Plug";break;case"devices.cw":l.title="Devices > Carbon Wear";break;case"devices.pandas":l.title="Devices > PANDAS";break;case"devices.firmware":l.title="Devices > Update";break;case"network":l.title="Settings > Network";break;case"reboot":l.title="Settings > Reboot";break;case"account":l.title="Settings > Account";break;default:l.title="Unknown Page"}})),l.editProfile=function(){a.go("core.user.profile")},l.editPassword=function(){a.go("core.user.password")},l.signOut=function(){o.location.href="/auth/signout"}}]),angular.module("core").controller("LswFileController",["$rootScope","$scope","$stateParams","Files","Authentication","GrowlMessage",function(e,t,n,a,o,i){t.authentication=o,e.section="files",t.isCollapsed=!0,t.toggleCollapsibleMenu=function(){t.isCollapsed=!t.isCollapsed},t.$on("$stateChangeSuccess",(function(){t.isCollapsed=!0})),t.data=null,a.get({deviceId:n.deviceId,dayId:n.dayId,fileId:n.fileId},(function(e){t.data=e}),(function(e){i.error("Limit Switch Viewer","Cannot open file.")}))}]),angular.module("core").controller("UpdateController",["$rootScope","$scope","$q","Authentication","Updates","GrowlMessage","StatusSocket","LastDevices","Devices",function(e,t,n,a,o,i,r,s,l){function c(e){var t=e.status;-1!==t.indexOf("In progress")?e.rowColour="bg-info":-1!==t.indexOf("Success")?e.rowColour="bg-success":-1!==t.indexOf("Failure")?e.rowColour="bg-danger":e.rowColour=""}function u(e){t.addDisabled=!1,i.error("Firmware Update",e)}t.authentication=a,e.section="update",t.uuid="",t.deviceIdOther="",t.selectedLastDevice=null,t.addDisabled=!0,t.removeDisabled=!0,t.find=function(){n.all([o.query().$promise,s.query().$promise]).then((function(e){t.updates=e[0],t.lastDevices=e[1],t.updates.forEach((function(e){c(e)})),t.addDisabled=!1,t.removeDisabled=!1}),(function(e){!function(e,t,n){t&&t.data&&t.data.message?i.error(e,t.data.message):n?i.error(e,n):i.error(e,"Unknown erorr")}("Firmware Update",e)}))},t.addUpdate=function(){t.addDisabled=!0;var e=t.selectedDevice?t.selectedDevice.uuid.trim():t.deviceIdOther.trim(),n=t.fileList;"string"!=typeof e||12!==e.length?u("Invalid UUID, please check your UUID and try again."):function(e){var n=!1;return t.updates.map((function(t){t.uuid===e&&(n=!0)})),n}(e)?u("Cannot execute firmware update, action already exists."):n&&1===n.length?n[0].size>1e5?u("Invalid file size, please try again."):function(e,n){var a=new FileReader;a.onloadend=function(){!function(e,n,a){var r=new JSZip(a).file("manifest.json");if(!r)return u("Invalid file structure.");var s=JSON.parse(r.asText()),l=s.manifest.application.init_packet_data.application_version,c=s.manifest.application.init_packet_data.device_type,d=btoa(String.fromCharCode.apply(null,new Uint8Array(a)));new o({uuid:e,deviceType:c,firmwareVersion:l,fileName:n.name,fileData:d,status:"Pending"}).$save((function(e){!function(e){t.updates.push(e),t.addDisabled=!1,i.success("Firmware Update","The file has been uploaded sucessfully. Firmware will be updated during next connection.")}(e)}),(function(e){console.log(e),u("Cannot upload file.")}))}(e,n,a.result)},a.readAsArrayBuffer(n)}(e,n[0]):u("Please select one file.")},t.remove=function(e){t.removeDisabled=!0,function(e,n){e.$remove((function(){for(var a in t.updates)if(t.updates[a]===e){t.updates.splice(a,1);break}n()}),(function(e){console.log(e),n(e)}))}(e,(function(e){e?i.error("Firmware Update","Cannot remove firmware update file."):i.success("Firmware Update","The firmware update file has been successfully removed."),t.removeDisabled=!1}))},r.removeAllListeners("status:firmwareUpdate"),r.on("status:firmwareUpdate",(function(e){if(console.log(e),t.updates)for(var n in t.updates){var a=t.updates[n];if(a.uuid===e.uuid){a.status=e.status,a.timestamp=e.timestamp,c(a);break}}}))}]),angular.module("core").factory("TransceiverStatus",["$resource",function(e){return e("/api/transceiver/status")}]),angular.module("core").factory("TransceiverReboot",["$resource",function(e){return e("/api/transceiver/reboot")}]),angular.module("core").service("Menus",[function(){this.defaultRoles=["*"],this.menus={};var e=function(e){if(!e)return this.isPublic;if(~this.roles.indexOf("*"))return!0;for(var t in e.roles)for(var n in this.roles)if(this.roles[n]===e.roles[t])return!0;return!1};this.validateMenuExistance=function(e){if(e&&e.length){if(this.menus[e])return!0;throw new Error("Menu does not exists")}throw new Error("MenuId was not provided")},this.getMenu=function(e){return this.validateMenuExistance(e),this.menus[e]},this.addMenu=function(t,n,a){return this.menus[t]={isPublic:n||!1,roles:a||this.defaultRoles,items:[],shouldRender:e},this.menus[t]},this.removeMenu=function(e){this.validateMenuExistance(e),delete this.menus[e]},this.addMenuItem=function(t,n,a,o,i,r,s,l){return this.validateMenuExistance(t),this.menus[t].items.push({title:n,link:a,menuItemType:o||"item",menuItemClass:o,uiRoute:i||"/"+a,isPublic:null==r?this.menus[t].isPublic:r,roles:null==s?this.menus[t].roles:s,position:l||0,items:[],shouldRender:e}),this.menus[t]},this.addSubMenuItem=function(t,n,a,o,i,r,s,l){for(var c in this.validateMenuExistance(t),this.menus[t].items)this.menus[t].items[c].link===n&&this.menus[t].items[c].items.push({title:a,link:o,uiRoute:i||"/"+o,isPublic:null==r?this.menus[t].items[c].isPublic:r,roles:null==s?this.menus[t].items[c].roles:s,position:l||0,shouldRender:e});return this.menus[t]},this.removeMenuItem=function(e,t){for(var n in this.validateMenuExistance(e),this.menus[e].items)this.menus[e].items[n].link===t&&this.menus[e].items.splice(n,1);return this.menus[e]},this.removeSubMenuItem=function(e,t){for(var n in this.validateMenuExistance(e),this.menus[e].items)for(var a in this.menus[e].items[n].items)this.menus[e].items[n].items[a].link===t&&this.menus[e].items[n].items.splice(a,1);return this.menus[e]},this.addMenu("topbar")}]),angular.module("core").factory("Updates",["$resource",function(e){return e("/api/update")}]),angular.module("core").factory("Updates",["$resource",function(e){return e("api/update/:updateId",{updateId:"@_id"},{save:{method:"POST"},update:{method:"PUT"}})}]),angular.module("core").factory("GrowlMessage",[function(){return{success:function(e,t){i("success",e,t)},info:function(e,t){i("info",e,t)},warning:function(e,t){i("warning",e,t)},error:function(e,t){i("error",e,t)}}}]),angular.module("core").factory("GsmData",["$resource",function(e){return e("api/gsm-data")}]),angular.module("core").factory("NetworkGsmProviders",["$resource",function(e){return e("api/network/gsm/providers")}]),angular.module("core").factory("NetworkGsmConfig",["$resource",function(e){return e("api/network/gsm/config/:configId",{configId:"@_id"},{update:{method:"PUT"}})}]),angular.module("core").factory("Files",["$resource",function(e){return e("api/fs/:lvl1/:lvl2/:lvl3/:lvl4/:lvl5/:lvl6")}]),angular.module("core").factory("DeviceSocket",["socketFactory",function(e){var t=io.connect();return t.on("connect",(function(){t.emit("name","www")})),e({prefix:"device:",ioSocket:t})}]),angular.module("core").factory("StatusSocket",["socketFactory",function(e){var t=io.connect();return t.on("connect",(function(){t.emit("name","www")})),e({prefix:"status:",ioSocket:t})}]),angular.module("core").factory("Task",["$resource",function(e){return e("api/task/:taskId",{taskId:"@_id"},{update:{method:"PUT"},query:{method:"GET",isArray:!1}})}]),angular.module("core").factory("LastDevices",["$resource",function(e){return e("api/lastDevices")}]),angular.module("astute").config(["$stateProvider",function(e){e.state("core.devices",{abstract:!0,url:"/devices",template:"<div ui-view></div>"}).state("core.devices.astute",{abstract:!0,url:"/astute",templateUrl:"modules/astute/views/astute-content.client.view.html"}).state("core.devices.astute.start",{url:"/",templateUrl:"modules/astute/views/astute-start.client.view.html"}).state("core.devices.astute.individual",{url:"/individual",templateUrl:"modules/astute/views/astute-individual.client.view.html"}).state("core.devices.astute.gearbox",{url:"/gearbox",templateUrl:"modules/astute/views/astute-gearbox.client.view.html"}).state("core.devices.astute.add",{url:"/add",templateUrl:"modules/astute/views/astute-add.client.view.html"}).state("core.devices.astute.edit",{url:"/edit/:astuteId",templateUrl:"modules/astute/views/astute-edit.client.view.html"}).state("core.devices.astute.edit-sleep",{url:"/edit-sleep/:astuteId",templateUrl:"modules/astute/views/astute-edit-sleep.client.view.html"}).state("core.devices.astute.stats",{url:"/stats/:astuteId",templateUrl:"modules/astute/views/astute-statistics.client.view.html"}).state("core.devices.astute.connecting",{url:"/connecting/:astuteId/:request/:next",templateUrl:"modules/astute/views/astute-connecting.client.view.html"}).state("core.devices.astute.test",{url:"/test/:astuteId",templateUrl:"modules/astute/views/astute-test.client.view.html"}).state("core.devices.astute.log-set-params",{url:"/log-set-params/:astuteId",templateUrl:"modules/astute/views/astute-logging-set-params.client.view.html"}).state("core.devices.astute.log-progress",{url:"/log-progress/:astuteId",templateUrl:"modules/astute/views/astute-logging-progress.client.view.html"}).state("core.devices.astute.log-view",{url:"/log-view/:path",templateUrl:"modules/astute/views/astute-logging-view.client.view.html"}).state("core.devices.astute.chan-def",{url:"/chan-def/:astuteId",templateUrl:"modules/astute/views/astute-channels-definition.client.view.html"})}]),angular.module("core").directive("customPopover",["$parse",function(e){return{restrict:"A",link:function(e,t,n){e.label=n.popoverLabel,$(t).popover({trigger:"hover",html:!0,content:n.popoverHtml,placement:n.popoverPlacement})}}}]),angular.module("astute").controller("AstuteEditController",["Authentication","$stateParams","TdDialog","Astute","StateHelper","$mdToast","AstuteConfig",function(e,t,n,a,o,i,r){var s,l=this;function c(e){i.show(i.simple().position("bottom right").textContent(e).hideDelay(3e3))}l.authentication=e,l.loading=!1,l.fault=!1,l.astute,l.config,l.get=function(){var e,n;l.loading=!0,(n=t.astuteId,a.get({astuteId:n}).$promise.catch((function(e){throw"Cannot add configuration upload task."}))).then((function(t){return function(e){return r.get(e).catch((function(e){throw"Cannot load Astute configuration."}))}(e=t)})).then((function(t){return function(e,t){if(!e||!t)throw"Invalid data.";l.astute=e,l.config=t,s=_.cloneDeep(t)}(e,t)})).then((function(){l.loading=!1})).catch((function(e){l.loading=!1,l.fault=!0,c(e)}))},l.submit=function(e){if(l.astute){var t,n=!angular.equals(l.config,s);l.loading=!0,(t=l.astute,t.$update().catch((function(e){throw"Cannot save Astute."}))).then((function(){if(n)return function(e,t){return r.upload(e,t).catch((function(e){throw"Cannot add configuration upload task."}))}(l.astute,l.config).then((function(){c("The configuration has been successfully updated, it will be uploaded to the device during next connection.")}));c("The Astute has been updated successfully")})).then((function(){l.loading=!1,o.back("core.devices.astute.start")})).catch((function(e){l.loading=!1,c(e)}))}},l.download=function(){var e;l.astute&&(l.loading=!0,(e=l.astute,r.download(e).catch((function(e){throw"Cannot add configuration download task."}))).then((function(){l.loading=!1,c("The configuration will be downloaded from the device during next connection."),o.back("core.devices.astute.start")})).catch((function(e){l.loading=!1,c(e)})))}}]),angular.module("astute").controller("AstuteStartController",["$state","Authentication",function(e,t){this.authentication=t,this.$state=e}]),angular.module("astute").controller("AstuteGearboxController",["$scope",function(e){e.text="AstuteGearboxController"}]),angular.module("astute").controller("AstuteLoggingViewController",["$rootScope","$scope","$q","$interval","$timeout","$stateParams","$state","Authentication","AstuteFile","Files","TdDialog","AstuteUnit",function(e,t,n,a,o,i,r,s,l,c,u,d){var m=8,f=this,p=!1,g=[],v=[],h={};f.loading=!0,f.authentication=s,f.astute,f.advert,f.config,f.options,f.loadingDevice=!1,f.progress={type:"determinate",value:100,disabled:!0},f.totalSamples=0;var w=e.$on("$stateChangeStart",(function(e,t,n,a,o,i){"core.devices.astute.log-progress"===t.name&&!1===p&&(p=!0,e.preventDefault(),t.name,r.go("core.devices.astute.individual"))}));function y(e){var t,n={},a=i.path.split("/");for(t=0;t<a.length;++t)n["lvl"+(t+1)]=a[t];return n["lvl"+(t+1)]=e,n}function b(e,t,n){return new Highcharts.Chart({plotOptions:{series:{marker:{enabled:!1}}},exporting:{buttons:{contextButton:{enabled:!1}}},chart:{height:230,zoomType:"x",renderTo:"chart-"+e},tooltip:{valueDecimals:3,valueSuffix:" "+n},legend:{enabled:!1},credits:{enabled:!1},title:{text:""},subtitle:{text:"CH "+(e+1)+" ("+n+")"},xAxis:{title:{text:""},type:"linear"},yAxis:{title:{text:""}},series:[{name:"CH"+(e+1),data:[],pointStart:0,pointInterval:t}]})}function x(e){f.progress.value=e}t.$on("$destroy",(function(){w()})),f.get=function(){(f.loadingDevice=!0,c.get(y("config.json")).$promise.then((function(e){f.astute=e.astute,f.advert=e.astute.advertisement,f.config=e.astute.config.actual,f.channelsDefinition=e.astute.config.actual.additional.channelEntry,f.options=e.task.options,f.loadingDevice=!1}),(function(e){throw f.loadingDevice=!1,u.error("Astute Error",e,"Cannot find Astute description file."),e}))).then((function(){for(var e=f.options.samples,t=1/f.options.frequency,a=0;a<m;++a){var o=d.getUnitSuffix(f.channelsDefinition[a].engUnit);g[a]=b(a,t,o),g[a].showLoading("Loading...")}return function(e,t){return n((function(n,a){f.progress={type:"indeterminate",value:void 0,disabled:!1},l.get(y("data.ad"),e,t,f.channelsDefinition).then((function(e){f.progress.disabled=!0,n(e)}),(function(e){f.progress.disabled=!0,u.error("Astute Error",e,"Cannot find logging data file."),a(e)}))}))}(t,e)})).then((function(e){var t,n,a;f.totalSamples=(t=e.valid,(n=(t+10)/f.options.samples*100)>100?100:n<0?0:n);for(var i=0;i<m;++i)v[i]=new Float32Array(e.data.channels[i]);h={size:e.data.tacho.size,timestamps:new Float32Array(e.data.tacho.timestamps)},f.loading=!1,a=0,f.options.frequency,o((function e(){g[a].series[0].setData(v[a]);for(var t=0;t<h.size;++t)n=g[a],i=h.timestamps[t],n.xAxis[0].addPlotLine({color:"black",dashStyle:"solid",value:i,width:2,verticalAlign:"middle",formatter:function(e){return e[2]=e[5]-10,e}});var n,i;g[a].hideLoading(),++a<m&&o(e,200)}),200)}))},f.exportCSV=function(){var e=f.options.samples,t=1/f.options.frequency,n=0,a="",i=f.astute.uuid+".csv";f.progress={type:"determinate",value:100,disabled:!1};var r=0;o((function(){x(r)})),o((function s(){x(r+=2),a+=function(e,t,n,a){for(var o=n/t,i=e*o,r=(e+1)*o,s=i*a,l="",c=i;c<r&&c<n;++c){l+=s.toFixed(7)+",";for(var u=0;u<8;u++)l+=v[u][c]?v[u][c].toFixed(6)+",":"0,";l+="\n",s+=a}return l}(n,50,e,t),++n<50?o(s,40):(f.progress.disabled=!0,o((function(){!function(e,t){var n=new Blob([t],{type:"text/csv;charset=utf-8;"}),a=URL.createObjectURL(n),o=document.createElement("a");o.style.visibility="hidden",o.setAttribute("href",a),o.setAttribute("download",e),document.body.appendChild(o),o.click(),document.body.removeChild(o)}(i,a)})))}),500)}}]),angular.module("astute").controller("AstuteLoggingSetParamsController",["$scope","Authentication","$q","$stateParams","$state","TdDialog","Astute","AstuteLogging",function(e,t,n,a,o,i,r,s){var l=this,c={Nrf2Mbps:0,Nrf1Mbps:1,Ble1Mbps:2},u={Yes:1,No:0},d={Yes:1,No:0},m={Noise:0,Current:1},f={Pos4dBm:4,Pos3dBm:3,ZerodBm:0,Neg4dBm:252,Neg8dBm:248,Neg12dBm:244,Neg16dBm:240,Neg20dBm:236,Neg40dBm:216},p=[16e3,8e3,4e3,2e3,1e3,500,250],g=[13,24,24,24,24,24,24],v=[37,37,34,33,33,33,33],h=[2,2,1,1,1,1,1],w=[-1,-1,25,25,21,20,19],y=[-1,-1,2,1,1,1,1];l.authentication=t,l.loading=!1,l.astute,l.params={samplingTime:"10000",samplingRate:"4000",rfTxPower:f.Pos4dBm.toString(10),rfChannel:"40",rfDataRate:c.Ble1Mbps.toString(10),rfAlwaysOn:u.Yes.toString(10),rfUseLna:d.Yes.toString(10),optimization:"0"},l.samplingTimeOptions=[{value:"10000",text:"10 seconds"},{value:"20000",text:"20 seconds"},{value:"30000",text:"30 seconds"},{value:"60000",text:"1 minute"},{value:"120000",text:"2 minutes"},{value:"180000",text:"3 minutes"},{value:"240000",text:"4 minutes"},{value:"300000",text:"5 minutes"}],l.samplingRateOptions=["16000","8000","4000","2000","1000","500","250"],l.optimizationDisabled=!1,l.optimizationOptions=[{value:m.Noise.toString(10),text:"Low noise"},{value:m.Current.toString(10),text:"Low power"}];for(var b=[],x=0;x<=140;++x){var C,S=2.36+x/1e3;C=S<2.4?x+128:x-40,b.push({value:C.toFixed(0),frequency:S.toFixed(3)})}function $(){var e,t=parseInt(l.params.samplingRate),n=parseInt(l.params.optimization),a=p.indexOf(t);if(-1===a)throw"Unknown sampling rate";t>=8e3?(l.params.rfDataRate=c.Nrf2Mbps.toString(10),l.params.rfAlwaysOn=u.Yes.toString(10),l.params.optimization=m.Noise.toString(10),l.optimizationDisabled=!0):(l.optimizationDisabled=!1,n===m.Noise?(e=h[a],l.params.rfAlwaysOn=u.Yes.toString(10)):(e=y[a],l.params.rfAlwaysOn=u.No.toString(10)),2===e?l.params.rfDataRate=c.Nrf2Mbps.toString(10):1===e&&(l.params.rfDataRate=c.Ble1Mbps.toString(10)));l.description=function(e,t){var n,a,o;o=g[e],t===m.Noise?(n=v[e],a=h[e]):(n=w[e],a=y[e]);var i={resolution:o.toString(10)};i.range=1===a?"full":"reduced";-1!==n&&(i.power=(3.6*n).toFixed(0));return i}(a,n)}l.rfChannelOptions=b,l.rfDataRateOptions=[{value:c.Nrf2Mbps.toString(10),text:"2 Mbps"},{value:c.Ble1Mbps.toString(10),text:"1 Mbps"}],l.rfAlwaysOnOptions=[{value:u.Yes.toString(10),text:"Yes"},{value:u.No.toString(10),text:"No"}],l.rfUseLnaOptions=[{value:d.Yes.toString(10),text:"Yes"},{value:d.No.toString(10),text:"No"}],l.rfTxPowerOptions=[{value:f.Pos4dBm.toString(10),text:"+4 dBm"},{value:f.Pos3dBm.toString(10),text:"+3 dBm"},{value:f.ZerodBm.toString(10),text:"0 dBm"},{value:f.Neg4dBm.toString(10),text:"-4 dBm"},{value:f.Neg8dBm.toString(10),text:"-8 dBm"},{value:f.Neg12dBm.toString(10),text:"-12 dBm"},{value:f.Neg16dBm.toString(10),text:"-16 dBm"},{value:f.Neg20dBm.toString(10),text:"-20 dBm"},{value:f.Neg40dBm.toString(10),text:"-40 dBm"}],l.advancedFeatures=localStorage.getItem("advancedFeatures"),l.get=function(){l.loading=!0,r.get({astuteId:a.astuteId}).$promise.then((function(e){l.astute=e,l.advert=e.advertisement})).catch((function(e){throw i.error("Astute Error",e,"Cannot find Astute device in the data base."),e})).then((function(){l.loading=!1,e.$watch(angular.bind(l,(function(){return this.params.samplingRate})),$,!0),e.$watch(angular.bind(l,(function(){return this.params.optimization})),$,!0)})).catch((function(e){l.loading=!1}))},l.submit=function(){n((function(e,t){l.loading=!0;var n=parseInt(l.params.samplingRate),a=parseInt(l.params.samplingTime),o=parseInt(l.params.rfChannel),r=parseInt(l.params.rfDataRate),c=parseInt(l.params.rfAlwaysOn),u=parseInt(l.params.rfUseLna),d=parseInt(l.params.rfTxPower),m=n<8e3?1:0;s.request(l.astute,{samplingRate:n,samplingTime:a,decimation:200,rfChannel:o,rfDataRate:r,rfAlwaysOn:c,rfUseLna:u,rfTxPower:d,sleepDuringLogging:m}).then((function(t){l.loading=!1,e()}),(function(e){l.loading=!1,i.error("Astute Error",e,"Cannot start logging."),t(e)}))})).then((function(){o.go("core.devices.astute.connecting",{astuteId:l.astute._id,request:"start-log"})}))},l.back=function(){o.go("core.devices.astute.individual")}}]),angular.module("astute").controller("AstuteChannelsDefinitionController",["$scope","Authentication","$stateParams","TdDialog","Astute","StateHelper","$mdToast","AstuteUnit","AstuteConfig",function(e,t,n,a,o,i,r,s,l){var c=this,u=null;function d(t,n){if(!t||!n)throw"Invalid Astute";c.astute=t,c.config=n,u=_.cloneDeep(n),e.$watch((function(){return c.config.additional.channelEntry}),(function(e){var t,n;c.ranges=(t=c.config.additional.channelEntry,n=[],t.forEach((function(e,t){var a=parseInt(e.engUnit),o=-2400/parseFloat(e.hardwareGain)/parseFloat(e.softwareGain),i=2400/parseFloat(e.hardwareGain)/parseFloat(e.softwareGain);if(a>0){var r=parseFloat(e.offset);o+=r,i+=r}if(a>1){var l=parseFloat(e.engUnitFactor);o*=l,i*=l}n.push({min:o,max:i,unit:s.getUnitSuffix(a)})})),n)}),!0)}function m(e){r.show(r.simple().position("bottom right").textContent(e).hideDelay(3e3))}c.authentication=t,c.loading=!1,c.fault=!1,c.astute,c.config,c.ranges,c.get=function(){var e,t;c.loading=!0,(t=n.astuteId,o.get({astuteId:t}).$promise.catch((function(e){throw"Cannot add configuration upload task."}))).then((function(t){return function(e){return l.get(e).catch((function(e){throw"Cannot load Astute configuration."}))}(e=t)})).then((function(t){return d(e,t)})).then((function(){c.loading=!1})).catch((function(e){c.loading=!1,c.fault=!0,m(e)}))},c.submit=function(){var e,t;c.astute&&(angular.equals(c.config,u)?i.back("core.devices.astute.start"):(c.loading=!0,(e=c.astute,t=c.config,l.upload(e,t).catch((function(e){throw"Cannot add configuration upload task."}))).then((function(){c.loading=!1,m("The configuration has been successfully updated, it will be uploaded to the device during next connection."),i.back("core.devices.astute.start")})).catch((function(e){c.loading=!1,m(e)}))))}}]),angular.module("astute").controller("AstuteController",["$rootScope","$scope","Authentication","AstuteSocket","$mdToast",function(e,t,n,a,o){function i(e,t,n){"completed"===t?s("Sleep settings has been successfully uploaded to the "+e+"."):"error"===t&&s("Cannot upload sleep settings to the "+e+".")}function r(e,t,n,a){var o,i;switch(-1!==t.indexOf("error")?(o=null,i=n,console.log(t,i)):(o=n,i=null,console.log(o)),t){case"upload":s("Configuration has been successfully uploaded to the "+e+".");break;case"upload-error":s("Cannot upload configuration to the "+e+".");break;case"download":s("Configuration has been successfully downloaded from the "+e+".");break;case"download-error":s("Cannot download configuration from the "+e+".")}}function s(e){o.show(o.simple().position("bottom right").textContent(e).hideDelay(3e3))}t.authentication=n,e.section="devices.astute",a.on("app:ast:sleep-state",i),a.on("app:ast:config-state",r),t.$on("$destroy",(function(){a.removeListener("app:ast:sleep-state",i),a.removeListener("app:ast:config-state",r)}))}]),angular.module("astute").controller("AstuteConnectingController",["Authentication","$rootScope","$scope","$q","$stateParams","$state","$window","TdDialog","$mdToast","StateHelper","TdAdvert","Astute","AstuteLogging","AstuteStream","AstuteConnectionStatus",function(e,t,n,a,o,i,r,s,l,c,u,d,m,f,p){var g=this,v=!1,h=null,w={advert:"Waiting for advertisement...",connecting:"Connecting...",configuring:"Configuring...",disconnecting:"Disconnecting...",disconnected:"Disconnected",canceling:"Cancelling...",erasing:"Erasing Memory..."},y=t.$on("$stateChangeStart",(function(e,t,n,a,o,i){if(v)return;console.log("unexpected state change"),e.preventDefault(),g.canCancel?(console.log("can cancel"),$()):(console.log("cannot cancel"),D("error","Cannot cancel request."))}));function b(e){console.log("on before unload");return e.returnValue="Operation in progress, please don't unload the window","Operation in progress, please don't unload the window"}function x(e){}n.$on("$destroy",(function(){u.removeListener("advert",U),p.removeListener("status",T),r.removeEventListener("beforeunload",b),r.removeEventListener("unload",x),h&&(clearInterval(h),h=null),y()})),r.addEventListener("beforeunload",b),r.addEventListener("unload",x);var C=null;function S(){switch(-1!==C.request.indexOf("start")?g.message=w.advert:-1!==C.request.indexOf("stop")&&(g.message=w.disconnecting),C.request){case"start-test":(console.log("wait test"),a((function(e,t){var n=function(n){f.removeListener("state",a),h&&(clearInterval(h),h=null),n?(D("error",n),t(n)):e()};h=setInterval((function(){f.request(g.astute.uuid).then((function(){console.log("ping con")})).catch((function(e){n(e)}))}),5e3);var a=function(e,t,a){console.log("state",e,t,a),g.astute.uuid===e&&("started"===t?n():"error"===t&&n("Cannot start data stream."))};f.on("state",a)}))).then((function(){k("core.devices.astute.test",{astuteId:g.astute._id})}),(function(){I()}));break;case"stop-test":A().then((function(){I()}),(function(){I()}));break;case"start-log":a((function(e,t){var n=function(t,a,o){g.astute.uuid===t&&(console.log(t,a),"started"===a?(m.removeListener("state",n),e()):"erasing"===a?g.message=w.erasing:"error"===a&&l.show(l.simple().position("bottom right").textContent(o).hideDelay(3e3)))};m.on("state",n)})).then((function(){k("core.devices.astute.log-progress",{astuteId:g.astute._id})}),(function(){I()}));break;case"stop-log":a((function(e){e()})).then((function(){I()}),(function(){I()}))}}function $(){switch(g.message=w.canceling,C.request){case"start-test":A().then((function(){I()}),(function(){I()}));break;case"start-log":a((function(e,t){m.cancelRequest(g.astute).then((function(t){e()})).catch((function(e){t(e),s.error("Astute Error",e,"Cannot stop logging.")}))})).then((function(){I()}),(function(){I()}))}}function D(e,t){l.show(l.simple().position("bottom right").textContent(t).hideDelay(3e3))}function A(){return h&&(clearInterval(h),h=null),a((function(e,t){f.cancelRequest(g.astute).then((function(){e()}),(function(e){s.error("Astute Error",e,"Cannot stop data stream."),t()}))}))}function I(){C.next&&"core.devices.astute.connecting"!==C.next?k(C.next):k(sessionStorage.getItem("astuteMode")?"core.devices.astute.individual":"core.devices.astute.start")}function k(e,t){v=!0,i.go(e,t)}function U(e,t){e===g.astute.uuid&&console.log(t)}function T(e,t){if(e===g.astute.uuid){switch(t.label){case"Connecting...":g.message=w.connecting,g.canCancel=!1;break;case"Connected":g.message=w.configuring,g.canCancel=!1;break;case"Failure":g.message=w.advert,g.canCancel=!0;break;case"Disconnecting...":g.message=w.disconnecting,g.canCancel=!1;break;case"Disconnected":g.message=w.disconnected,g.canCancel=!1}console.log(e,t)}}g.authentication=e,g.loading=!1,g.canCancel=!0,g.astute=null,g.title="Connecting...",g.message="",g.get=function(){g.loading=!0,C={astuteId:o.astuteId,request:o.request,next:o.next},d.get({astuteId:o.astuteId}).$promise.then((function(e){g.astute=e})).then((function(){g.title="Connecting to "+g.astute.uuid,u.on("advert",U),p.on("status",T),g.loading=!1,S()}),(function(e){s.error("Astute Error",e,"Cannot find Astute device in the data base."),g.loading=!1}))},g.cancel=function(){$()}}]),angular.module("astute").controller("AstuteEditSleepController",["Authentication","$stateParams","TdDialog","Astute","StateHelper","$mdToast","AstuteConfig","AstuteSleep","$q",function(e,t,n,a,o,i,r,s,l){var c=this,u=null;function d(e,t,n){return s.sleep(e,t,n).catch((function(e){throw"Cannot add sleep task."}))}function m(){f("The configuration has been successfully updated, it will be uploaded to the device during next connection.")}function f(e){i.show(i.simple().position("bottom right").textContent(e).hideDelay(3e3))}c.authentication=e,c.loading=!1,c.fault=!1,c.sleepMode="shallow",c.shallowSleepTimeout=3600,c.astute,c.get=function(){var e,n;c.loading=!0,(n=t.astuteId,a.get({astuteId:n}).$promise.catch((function(e){throw"Cannot load Astute."}))).then((function(t){return function(e){return r.get(e).catch((function(e){throw"Cannot load Astute's configuration."}))}(e=t)})).then((function(t){return function(e,t){if(!e||!t)throw"Invalid data.";c.astute=e,c.config=t,u=_.cloneDeep(t)}(e,t)})).then((function(){c.loading=!1})).catch((function(e){c.loading=!1,c.fault=!0,f(e)}))},c.changeSleep=function(){c.astute&&l.resolve().then((function(){if("shallow"===c.sleepMode)return l.resolve().then((function(){var e=c.shallowSleepTimeout;if(isNaN(e))throw"Invalid shallow sleep.";if((e=parseInt(e))>86400)throw"Shallow sleep timeout is too long (86400 s is the maximum value).";return d(c.astute,"shallow",e)}));if("deep"===c.sleepMode)return d(c.astute,"deep");throw"Invalid sleep mode."})).then((function(){m(),o.back("core.devices.astute.start")})).catch((function(e){f(e)}))},c.submit=function(e){var t,n;c.astute&&(c.config.primary.advertWindow=parseInt(c.config.primary.advertWindow),c.config.primary.deepSleep=parseInt(c.config.primary.deepSleep),c.config.primary.shallowSleep=parseInt(c.config.primary.shallowSleep),angular.equals(c.config,u)?o.back("core.devices.astute.start"):(c.loading=!0,(t=c.astute,n=c.config,r.upload(t,n).catch((function(e){throw"Cannot add configuration upload task."}))).then((function(){c.loading=!1,m(),o.back("core.devices.astute.start")})).catch((function(e){c.loading=!1,f(e)}))))}}]),angular.module("astute").controller("AstuteLoggingProgressController",["$rootScope","$scope","Authentication","$stateParams","$state","$window","$interval","AstuteFile","TdDialog","Astute","AstuteLogging","AstuteConnectionStatus","AstuteUnit","Task",function(e,t,n,a,o,i,r,s,l,c,u,d,m,f){var p,g=this,v=!1,h=null;g.authentication=n,g.loadingDevice=!1,g.astute,g.advert,g.config,g.options,g.message="Acquring data...",g.description="(0 %)",g.progress=0,g.state="logging";var w=e.$on("$stateChangeStart",(function(e,t,n,a,i,r){if(!0===v)return;v=!0,e.preventDefault(),t.name,console.log("go back"),o.go("core.devices.astute.individual")}));function y(e){console.log("on before unload");return e.returnValue="Operation in progress, please don't unload the window","Operation in progress, please don't unload the window"}function b(e){}function x(e,t,n){if(e===g.astute.uuid){if("trasferring"===t){g.progress=100,h&&(r.cancel(h),h=null);var a=Date.now(),i=g.options.samples,s=g.options.frequency,l=16e3===s?141:254,c=Math.ceil(i/10*l/125e3);console.log(i,s,l,125e3,c),g.state="transferring",g.message="Transferring data...",g.description="0 seconds (up to: "+C(c)+")",h=r((function(){var e=Math.floor((Date.now()-a)/1e3);g.description=C(e)+" (up to: "+C(c)+")"}),1e3)}var u;if("completed"===t)u=n,console.log("go next",u),v=!0,o.go("core.devices.astute.log-view",{path:u})}}function C(e){if(e<60)return e+" seconds";if(60===e)return"1 minute";var t=Math.floor(e/60),n=Math.round(e%60),a="";return a+=1===t?t+" minute":t+" minutes",0!==n&&(a+=" and "+n+" second",n>1&&(a+="s")),a}function S(e,t){e===g.astute.uuid&&("Success"===t.label?g.status="Completed":"Failure"===t.label&&(g.status="Failure ("+t.message+")"),console.log(e,t))}t.$on("$destroy",(function(){w(),h&&(r.cancel(h),h=null),d.removeListener("status",S),u.removeListener("state",x),i.removeEventListener("beforeunload",y),i.removeEventListener("unload",b)})),i.addEventListener("beforeunload",y),i.addEventListener("unload",b),g.get=function(){var e;v=!1,g.loadingDevice=!0,(e=a.astuteId,c.get({astuteId:e}).$promise.catch((function(e){throw"Cannot load Astute."}))).then((function(e){return g.astute=e,g.advert=e.advertisement,g.config=e.config.actual,function(e){var t={uuid:e,command:"logging",order:"-createdOn",skip:0,limit:1};return f.query(t).$promise.catch((function(e){throw"Cannod load logging task."}))}(e.uuid)})).then((function(e){if(0===e.tasks.length)throw"Cannot find logging task.";g.options=e.tasks[0].options;var t=g.options.samples,n=g.options.frequency,a=1e3*(p=t/n)/100;g.progress=0,g.message="Acquring data...",g.description="("+g.progress+" %)";var o=Date.now();h=r((function(){var e=Math.floor((Date.now()-o)/1e3);g.progress=Math.floor(e/p*100),g.progress<100?g.description="("+g.progress+" %)":(g.description="(100 %)",h&&(r.cancel(h),h=null))}),a),d.on("status",S),u.on("state",x),g.loadingDevice=!1})).catch((function(e){g.loadingDevice=!1,l.error("Astute Error",e)}))}}]),angular.module("astute").controller("AstuteIndividualController",["$scope","$state","$window","Astute","AstuteStream","AstuteConnectionStatus","TdDialog","TdAdvert","AstuteSocket",function(e,t,n,a,o,i,r,s,l){var c=this;e.$on("$destroy",(function(){c.selected[0]?sessionStorage.setItem("astute.individual.selected",c.selected[0].uuid):sessionStorage.setItem("astute.individual.selected",void 0),sessionStorage.setItem("astute.individual.query",JSON.stringify(c.query)),sessionStorage.setItem("astuteMode","individual"),i.removeListener("status",f),s.removeListener("advert",p),l.removeListener("app:ast:config-state",g)})),c.isLoading=!1,c.selected=[],c.section="devices";var u=sessionStorage.getItem("astute.individual.query"),d=sessionStorage.getItem("astute.individual.selected");c.query=u?JSON.parse(u):{order:"uuid",limit:10,page:1};function m(e){return _.find(c.astutes.devices,(function(t){return e===t.uuid}))}function f(e,t){var n=m(e);n&&_.set(n,"connection.status",t)}function p(e,t){var n=m(e);n&&_.set(n,"advertisement",t)}function g(e,t,n,a){if("upload"===t||"download"===t){var o=m(e);o&&(_.set(o,"config.timestamp",n),_.set(o,"config.actual",a))}}c.get=function(){c.isLoading=!0,function(e){return a.query(e).$promise.catch((function(e){throw r.error("Astute Request",e,"Cannot load Astute device."),e}))}({order:c.query.order,skip:(c.query.page-1)*c.query.limit,limit:c.query.limit}).then((function(e){c.astutes=e,d&&c.astutes.devices.forEach((function(e){e.uuid===d&&(c.selected[0]=e)})),i.on("status",f),s.on("advert",p),l.on("app:ast:config-state",g),c.isLoading=!1})).catch((function(e){c.isLoading=!1}))},c.logging=function(){c.selected[0]&&t.go("core.devices.astute.log-set-params",{astuteId:c.selected[0]._id})},c.test=function(){if(c.selected[0]){var e=c.selected[0];c.isLoading=!0,o.isBusy(e).then((function(n){if(!0===n)return c.isLoading=!1,void r.error("Astute Error","","Test in progress.");o.request(e).then((function(){c.isLoading=!1,t.go("core.devices.astute.connecting",{astuteId:c.selected[0]._id,request:"start-test"})}),(function(e){c.isLoading=!1,r.error("Astute Error",e,"Cannot start test session.")}))}))}},c.statistics=function(){c.selected[0]&&t.go("core.devices.astute.stats",{astuteId:c.selected[0]._id})},c.viewFiles=function(){console.log("go view files")},c.channels=function(){c.selected[0]&&t.go("core.devices.astute.chan-def",{astuteId:c.selected[0]._id})},c.editSleep=function(){c.selected[0]&&t.go("core.devices.astute.edit-sleep",{astuteId:c.selected[0]._id})},c.edit=function(){c.selected[0]&&t.go("core.devices.astute.edit",{astuteId:c.selected[0]._id})}}]),angular.module("astute").controller("AstuteStatisticsController",["$scope","Authentication","$q","$stateParams","TdDialog","TdAdvert","Astute","AstuteConnectionStatus","StateHelper","$window",function(e,t,n,a,o,i,r,s,l,c){var u=this,d=null,m=null;e.$on("$destroy",(function(){i.removeListener("advert",h),s.removeListener("status",w),m&&m()})),u.authentication=t,u.loadingDevice=!1,u.loadingSamples=!1,u.astute,u.advert,u.config,u.sleepText="N/A",u.channels=[{selected:"batteryVoltage",style:{color:Highcharts.getOptions().colors[0]},changed:function(){S(0)}},{selected:"temperature",style:{color:Highcharts.getOptions().colors[1]},changed:function(){S(1)}}];var f=200,p=0,g={rssi:{title:"RSSI",unit:"dBm"},temperature:{title:"Temperature",unit:"°C"},batteryVoltage:{title:"Battery Voltage",unit:"V"},packetCounter:{title:"Packet Counter",unit:""},restartsUnknown:{title:"Restarts (Unknown)",unit:""},restartsSoftware:{title:"Restarts (Software)",unit:""},restartsWatchdog:{title:"Restarts (Watchdog)",unit:""},configNumber:{title:"Configuration Number",unit:""}},v={rssi:[],temperature:[],batteryVoltage:[],packetCounter:[],restartsUnknown:[],restartsSoftware:[],restartsWatchdog:[],configNumber:[]};function h(e,t){e===u.astute.uuid&&(u.advert=t,function(e){var t=u.astute.advertisement;if(u.astute.advertisement=e,!0===u.loadingSamples)return;if(t&&t.packetCounter===e.packetCounter)return;if(e.timestamp<new Date(2010,1,1,1,0,0,0).getTime())return;p+=1,x(e),n=e,$(0,n),$(1,n);var n}(t))}function w(e,t){e===u.astute.uuid&&(u.astute||(u.astute={}),u.astute.connection||(u.astute.connection={}),u.astute.connection.status=t)}function y(){return u.loadingSamples=!0,d.showLoading("Loading..."),(e=p,t=f,i.query({uuid:u.astute.uuid,skip:e,limit:t})).then((function(e){return u.loadingSamples=!1,d.hideLoading(),console.log(p),e.samplesList&&(p+=e.samplesList.length),e.samplesList}),(function(e){throw u.loadingSamples=!1,d.hideLoading(),o.error("Load Samples",e,"Cannot load samples."),e}));var e,t}function b(){S(0),S(1)}function x(e){e&&(v.rssi.push([e.timestamp,e.rssi]),v.temperature.push([e.timestamp,e.temperature]),v.batteryVoltage.push([e.timestamp,e.batteryVoltage]),v.packetCounter.push([e.timestamp,e.packetCounter]),v.restartsUnknown.push([e.timestamp,e.restartsUnknown]),v.restartsSoftware.push([e.timestamp,e.restartsSoftware]),v.restartsWatchdog.push([e.timestamp,e.restartsWatchdog]),v.configNumber.push([e.timestamp,e.configNumber]))}function C(e){e&&(v.rssi.unshift([e.timestamp,e.rssi]),v.temperature.unshift([e.timestamp,e.temperature]),v.batteryVoltage.unshift([e.timestamp,e.batteryVoltage]),v.packetCounter.unshift([e.timestamp,e.packetCounter]),v.restartsUnknown.unshift([e.timestamp,e.restartsUnknown]),v.restartsSoftware.unshift([e.timestamp,e.restartsSoftware]),v.restartsWatchdog.unshift([e.timestamp,e.restartsWatchdog]),v.configNumber.unshift([e.timestamp,e.configNumber]))}function S(e){var t=u.channels[e].selected,n=g[t],a=n.title,o=n.unit;d.yAxis[e].update({labels:{format:"{value} "+o,style:{color:Highcharts.getOptions().colors[e]}},title:{text:a,style:{color:Highcharts.getOptions().colors[e]}}}),d.series[e].update({name:a,type:"spline",yAxis:e,data:v[t],tooltip:{valueSuffix:" "+o}})}function $(e,t){var n=u.channels[e].selected;d.series[e].addPoint([t.timestamp,t[n]])}u.get=function(){(u.loadingDevice=!0,r.get({astuteId:a.astuteId}).$promise.then((function(t){u.astute=t,u.advert=t.advertisement,u.config=t.config.actual,e.$watch((function(){return u.advert.shallowSleepTimeout}),(function(e){u.sleepText=e?"Shallow ("+e+" s)":"Deep"})),u.loadingDevice=!1}),(function(e){throw u.loadingDevice=!1,o.error("Astute Error",e,"Cannot find Astute device in the data base."),e}))).then((function(){var e,t,n;return d=new Highcharts.Chart({plotOptions:{series:{borderWidth:0,animation:!1,states:{hover:{enabled:!1}},marker:{enabled:!1}}},chart:{zoomType:"x",renderTo:"chart",animation:!1},legend:{width:300,itemWidth:150,itemStyle:{width:150}},credits:{enabled:!1},title:{text:""},xAxis:{title:{text:"Date"},type:"datetime"},yAxis:[{labels:{format:"{value} V",style:{color:Highcharts.getOptions().colors[0]}},title:{text:"Battery Voltage",style:{color:Highcharts.getOptions().colors[0]}}},{title:{text:"Temperature",style:{color:Highcharts.getOptions().colors[1]}},labels:{format:"{value} °C",style:{color:Highcharts.getOptions().colors[1]}},opposite:!0}],series:[{name:"Battery Voltage",type:"spline",yAxis:0,data:[],tooltip:{valueSuffix:" V"}},{name:"Temperature",type:"spline",yAxis:1,data:[],tooltip:{valueSuffix:" °C"}}]}),e=angular.element("#chart"),t=0,n=setInterval((function(){e.width()!==t&&(t=e.width(),d.setSize(t,d.height))}),500),m=function(){clearInterval(n)},y()})).then((function(e){!function(e){for(var t=e.length-1;t>=0;t--)x(e[t])}(e),b(),i.on("advert",h),s.on("status",w)}))},u.loadMore=function(){y().then((function(e){!function(e){for(var t=0;t<e.length;t++)C(e[t])}(e),b()}))}}]),angular.module("astute").controller("AstuteAddController",["Authentication","Astute","StateHelper","TdDialog",function(e,t,n,a){var o=this;o.authentication=e,o.isLoading=!1,o.astute={uuid:"",name:"Astute",serialNumber:"",description:""},o.submit=function(){o.isLoading=!0;var e=o.astute.uuid.match(/.{1,2}/g).join(":");new t({uuid:o.astute.uuid,address:e,name:o.astute.name,serialNumber:o.astute.serialNumber,description:o.astute.description}).$save((function(e){o.isLoading=!1,n.back("core.devices.astute.start")}),(function(e){o.isLoading=!1,a.error("Astute Error",e,"Cannot add Astute to the data base.")}))},o.cancel=function(){n.back("core.devices.astute.start")}}]),angular.module("astute").factory("AstuteLogging",["$q","AstuteSocket","Task",function(e,t,n){var a={sample:null,stats:null,state:null};return t.on("app:ast:log-sample",(function(e,t){if(a.sample){var n=proto.AstuteLogging.Sample.deserializeBinary(new Uint8Array(t));a.sample(e,n.toObject())}})),t.on("app:ast:log-stats",(function(e,t){if(a.stats){var n=proto.AstuteLogging.Stats.deserializeBinary(new Uint8Array(t));a.stats(e,n.toObject())}})),t.on("app:ast:log-state",(function(e,t){if(a.state){for(var n,o=[],i=0;i<arguments.length;i++)o[i]=arguments[i];(n=a).state.apply(n,o)}})),{request:function(t,a){return e.resolve().then((function(){if(!a)throw"Invalid options";if(0!==a.mode&&(a.mode=0),!a.samplingTime||!Number.isInteger(a.samplingTime))throw"Invalid sampling time";if(!a.samplingRate||!Number.isInteger(a.samplingRate))throw"Invalid sampling rate";Number.isInteger(a.decimation)||(console.log("revert decimation"),a.decimation=40),Number.isInteger(a.rfChannel)&&a.rfChannel>=0&&a.rfChannel<=255||(console.log("revert rf channel"),a.rfChannel=40),Number.isInteger(a.rfDataRate)&&a.rfDataRate>=0&&a.rfDataRate<=2||(console.log("revert data rate"),a.rfDataRate=0),Number.isInteger(a.rfAlwaysOn)&&a.rfAlwaysOn>=0&&a.rfAlwaysOn<=1||(console.log("revert rf always on"),a.rfAlwaysOn=0),Number.isInteger(a.rfUseLna)&&a.rfUseLna>=0&&a.rfUseLna<=1||(console.log("revert rf use lna"),a.rfUseLna=1),Number.isInteger(a.sleepDuringLogging)&&a.sleepDuringLogging>=0&&a.sleepDuringLogging<=1||(console.log("revert sleep during logging"),a.sleepDuringLogging=1),Number.isInteger(a.rfTxPower)||(console.log("revert rf tx power"),a.rfTxPower=4);var e=t.uuid,i=Math.round(a.samplingTime/1e3*a.samplingRate),r={mode:a.mode,frequency:a.samplingRate,samples:i,decimation:a.decimation,rfChannel:a.rfChannel,rfDataRate:a.rfDataRate,rfAlwaysOn:a.rfAlwaysOn,rfUseLna:a.rfUseLna,rfTxPower:a.rfTxPower,sleepDuringLogging:a.sleepDuringLogging};return o(e,1).then((function(t){return t.tasks.length?t.tasks[0]:new n({uuid:e,command:"logging",mode:"Individual",options:r}).$save()}))}))},cancelRequest:function(t){return o(t.uuid).then((function(t){var a=t.tasks.map((function(e){return new n(e).$remove()}));return e.all(a)}))},on:function(e,t){"sample"===e?a.sample=t:"stats"===e?a.stats=t:"state"===e&&(a.state=t)},removeListener:function(e,t){"sample"===e?a.sample=null:"stats"===e?a.stats=null:"state"===e&&(a.state=null)}};function o(e,t){var a={uuid:e,command:"logging",order:"-createdOn",skip:0};return t&&(a.limit=t),n.query(a).$promise}}]),angular.module("astute").factory("AstuteStream",["$q","AstuteSocket","Task",function(e,t,n){var a={sample:null,state:null};return t.on("app:ast:stream-sample",(function(e,t){if(a.sample){var n=proto.AstuteStream.Sample.deserializeBinary(new Uint8Array(t));a.sample(e,n.toObject())}})),t.on("app:ast:stream-state",(function(e,t,n){a.state&&a.state(e,t,n)})),{isBusy:function(e){return o(e.uuid,1).then((function(e){return e.tasks.length>0}))},request:function(e,t){var a=e.uuid,i=t&&t.frequency||25;return o(a,1).then((function(e){if(e.tasks.length){var t=e.tasks[0];return new n(t).$update()}return new n({uuid:a,createdOn:Date.now(),command:"stream",mode:"Individual",options:{frequency:i}}).$save()}))},cancelRequest:function(t){return o(t.uuid).then((function(t){var a=t.tasks.map((function(e){return new n(e).$remove()}));return e.all(a)}))},on:function(e,t){"sample"===e?a.sample=t:"state"===e&&(a.state=t)},removeListener:function(e,t){"sample"===e?a.sample=null:"state"===e&&(a.state=null)}};function o(e,t){var a={uuid:e,command:"stream",order:"-createdOn",skip:0};return t&&(a.limit=t),n.query(a).$promise}}]),goog.require("proto.AstuteLogging.FileEntry"),goog.require("proto.AstuteLogging.FileEntry.Samples"),goog.require("proto.AstuteLogging.Sample"),goog.require("proto.AstuteLogging.Stats"),goog.require("proto.AstuteLogging.ValueStats"),goog.require("proto.AstuteStream.Sample"),goog.require("proto.BleAdvert.Data"),goog.require("proto.BleAdvert.DataArray"),angular.module("astute").factory("Astute",["$resource",function(e){return e("api/astute/:astuteId",{astuteId:"@_id"},{update:{method:"PUT"},query:{method:"GET",isArray:!1}})}]),angular.module("astute").factory("AstuteSocket",["socketFactory",function(e){var t=io.connect();return t.on("connect",(function(){t.emit("name","www")})),e({prefix:"app:ast:",ioSocket:t})}]),angular.module("astute").factory("AstuteConnectionStatus",["$q","AstuteSocket",function(e,t){var n={status:null};return t.on("app:ast:status",(function(e,t){n.status&&n.status(e,t)})),{on:function(e,t){"status"===e&&(n.status=t)},removeListener:function(e,t){"status"===e&&(n.status=null)}}}]),angular.module("astute").factory("AstuteFile",["$q","$resource",function(e,t){var n=t("api/fs/:lvl1/:lvl2/:lvl3/:lvl4/:lvl5/:lvl6",null,{get:{responseType:"arraybuffer",transformResponse:function(e,t){return{data:e}}}});return{get:function(t,a,o,i){return e((function(e,r){n.get(t).$promise.then((function(t){var n=t.data,r=new Worker("/workers/astute-load-data.client.worker.js");r.addEventListener("message",(function(t){r.terminate(),r=void 0,e(t.data)})),r.postMessage({samplingInterval:a,samples:o,input:n,channelsDefinition:i},[n])}),(function(e){r(e)}))}))}}}]),angular.module("astute").factory("AstuteUnit",[function(e){return{getUnitName:function(e){switch(e){case 0:case 1:return"Voltage";case 2:return"Strain"}return""},getUnitSuffix:function(e){switch(e){case 0:case 1:return"mV";case 2:return"µε"}return""}}}]),angular.module("astute").factory("AstuteConfig",["Task",function(e){return{upload:function(t,n){var a=t.uuid;return new e({uuid:a,command:"upload",mode:"Individual",options:n}).$save()},download:function(t){var n=t.uuid;return function(t){return e.query({uuid:t,command:"download",order:"-createdOn",limit:1,skip:0}).$promise}(n).then((function(t){return t.tasks.length?t.tasks[0]:new e({uuid:n,command:"download",mode:"Individual"}).$save()}))},get:function(t){return(n=t.uuid,e.query({uuid:n,command:"upload",order:"-createdOn",limit:1,skip:0}).$promise).then((function(e){var n=e.tasks,a=n.length?n[0].options:t.config.actual;return _.cloneDeep(a)}));var n}}}]),angular.module("astute").factory("AstuteSleep",["Task",function(e){return{sleep:function(t,n,a){var o=t.uuid;return new e({uuid:o,command:"sleep",mode:"Individual",options:{mode:n,timeout:a}}).$save()}}}]),angular.module("astute").factory("StateHelper",["$rootScope","$state",function(e,t){return{back:function(n){t.go(e.$prevState.name||n)}}}]),angular.module("wa").config(["$stateProvider",function(e){e.state("core.devices.wa",{abstract:!0,url:"/wa",templateUrl:"modules/wirelessaccel/views/wa-content.client.view.html"}).state("core.devices.wa.start",{url:"/",templateUrl:"modules/wirelessaccel/views/wa-individual.client.view.html"}).state("core.devices.wa.stats",{url:"/statistics/:waId",templateUrl:"modules/wirelessaccel/views/wa-statistics.client.view.html"}).state("core.devices.wa.edit",{url:"/edit/:waId",templateUrl:"modules/wirelessaccel/views/wa-edit.client.view.html"}).state("core.devices.wa.edit-sleep",{url:"/edit-sleep/:waId",templateUrl:"modules/wirelessaccel/views/wa-edit-sleep.client.view.html"}).state("core.devices.wa.connecting",{url:"/connecting/:waId/:request/:next",templateUrl:"modules/wirelessaccel/views/wa-connecting.client.view.html"}).state("core.devices.wa.stream",{url:"/stream/:waId",templateUrl:"modules/wirelessaccel/views/wa-stream.client.view.html"}).state("core.devices.wa.log-view",{url:"/log-view/:path",templateUrl:"modules/wirelessaccel/views/wa-data-viewer.client.view.html"}).state("core.devices.wa.evt-view",{url:"/evt-view/:path",templateUrl:"modules/wirelessaccel/views/wa-evt-viewer.client.view.html"})}]),angular.module("wa").controller("WaConnectingController",["Authentication","$rootScope","$scope","$q","$stateParams","$state","$window","TdDialog","$mdToast","StateHelper","TdAdvert","Wa","WaStream","WaConnectionStatus",function(e,t,n,a,o,i,r,s,l,c,u,d,m,f){var p=this,g=!1,v={advert:"Waiting for advertisement...",connecting:"Connecting...",configuring:"Configuring...",disconnecting:"Disconnecting...",disconnected:"Disconnected",canceling:"Cancelling..."},h=t.$on("$stateChangeStart",(function(e,t,n,a,o,i){if(g)return;console.log("unexpected state change"),e.preventDefault(),p.canCancel?(console.log("can cancel"),C()):(console.log("cannot cancel"),S("error","Cannot cancel request."))}));function w(e){console.log("on before unload");return e.returnValue="Operation in progress, please don't unload the window","Operation in progress, please don't unload the window"}function y(e){}n.$on("$destroy",(function(){u.removeListener("advert",I),f.removeListener("status",k),r.removeEventListener("beforeunload",w),r.removeEventListener("unload",y),h()})),r.addEventListener("beforeunload",w),r.addEventListener("unload",y);var b=null;function x(){switch(-1!==b.request.indexOf("start")?p.message=v.advert:-1!==b.request.indexOf("stop")&&(p.message=v.disconnecting),b.request){case"start-stream":(console.log("wait stream"),a((function(e,t){var n=function(n){m.removeListener("state",o),clearInterval(a),n?(S("error",error),t(n)):e()},a=setInterval((function(){m.ping(p.wa.uuid).then((function(){console.log("ping con")})).catch((function(e){n(e)}))}),5e3),o=function(e,t,a){console.log("state",e,t,a),p.wa.uuid===e&&("started"===t?n():"error"===t&&n("Cannot start data stream."))};m.on("state",o)}))).then((function(){A("core.devices.wa.stream",{waId:p.wa.uuid})}),(function(){D()}));break;case"stop-stream":$().then((function(){D()}),(function(){D()}))}}function C(){switch(p.message=v.canceling,b.request){case"start-stream":$().then((function(){D()}),(function(){D()}))}}function S(e,t){l.show(l.simple().position("bottom right").textContent(t).hideDelay(3e3))}function $(){return a((function(e,t){m.cancelRequest(p.wa).then((function(){e()}),(function(e){s.error("SOP Error",e,"Cannot stop data stream."),t()}))}))}function D(){b.next&&"core.devices.wa.connecting"!==b.next?A(b.next):A("core.devices.wa.start")}function A(e,t){g=!0,i.go(e,t)}function I(e,t){e===p.wa.uuid&&console.log(t)}function k(e,t){if(e===p.wa.uuid){switch(t.label){case"Connecting...":p.message=v.connecting,p.canCancel=!1;break;case"Connected":p.message=v.configuring,p.canCancel=!1;break;case"Failure":p.message=v.advert,p.canCancel=!0;break;case"Disconnecting...":p.message=v.disconnecting,p.canCancel=!1;break;case"Disconnected":p.message=v.disconnected,p.canCancel=!0}console.log(e,t)}}p.authentication=e,p.loading=!1,p.canCancel=!0,p.wa=null,p.title="Connecting...",p.message="",p.get=function(){p.loading=!0,b={waId:o.waId,request:o.request,next:o.next},d.get({waId:o.waId}).$promise.then((function(e){p.wa=e})).then((function(){p.title="Connecting to "+p.wa.uuid,u.on("advert",I),f.on("status",k),p.loading=!1,x()}),(function(e){s.error("SOP Error",e,"Cannot find SOP device in the data base."),p.loading=!1}))},p.cancel=function(){C()}}]),angular.module("wa").controller("WaEditSleepController",["$scope","Authentication","$stateParams","TdDialog","Wa","StateHelper","$mdToast","WaConfig","$q",function(e,t,n,a,o,i,r,s,l){var c=this,u=null;function d(e){e=1e3*parseInt(e,10),c.advertWindows=c.availableAdvertWindows.filter((function(t){var n=parseInt(t.value,10);return e>n}));var t=parseInt(c.config.primary.advertWindow,10);0===c.advertWindows.filter((function(e){return parseInt(e.value,10)===t})).length&&(c.config.primary.advertWindow=c.advertWindows[0].value)}function m(e){r.show(r.simple().position("bottom right").textContent(e).hideDelay(3e3))}c.authentication=t,c.loading=!1,c.fault=!1,c.wa,c.advertIntervals=[{value:"5",text:"5 seconds"},{value:"10",text:"10 seconds"},{value:"20",text:"20 seconds"},{value:"30",text:"30 seconds"},{value:"60",text:"1 minute"},{value:"120",text:"2 minutes"},{value:"300",text:"5 minutes"},{value:"600",text:"10 minutes"},{value:"1200",text:"20 minutes"},{value:"1800",text:"30 minutes"},{value:"3600",text:"1 hour"}],c.availableAdvertWindows=[{value:"1000",text:"1 second"},{value:"2000",text:"2 seconds"},{value:"3000",text:"3 seconds"},{value:"5000",text:"5 seconds"},{value:"8000",text:"8 seconds"},{value:"10000",text:"10 seconds"},{value:"20000",text:"20 seconds"},{value:"30000",text:"30 seconds"},{value:"40000",text:"40 seconds"},{value:"50000",text:"50 seconds"},{value:"60000",text:"1 minute"}],c.advertWindows=c.availableAdvertWindows,c.get=function(){var t,a;c.loading=!0,(a=n.waId,o.get({waId:a}).$promise.catch((function(e){throw"Cannot load device."}))).then((function(e){return function(e){return s.get(e).catch((function(e){throw"Cannot load configuration."}))}(t=e)})).then((function(n){return function(t,n){if(!t||!n)throw"Invalid data.";c.wa=t,c.config=n,u=_.cloneDeep(n),e.$watch(angular.bind(c,(function(){return this.config.primary.advertInterval})),d)}(t,n)})).then((function(){c.loading=!1})).catch((function(e){c.loading=!1,c.fault=!0,m(e)}))},c.submit=function(e){if(c.wa){var t=_.cloneDeep(c.config);t.primary.advertInterval=parseInt(c.config.primary.advertInterval,10),t.primary.advertWindow=parseInt(c.config.primary.advertWindow,10),angular.equals(t,u)?i.back("core.devices.wa.start"):(c.loading=!0,function(e,t){return s.upload(e,t).catch((function(e){throw"Cannot add configuration upload task."}))}(c.wa,t).then((function(){c.loading=!1,m("The configuration has been successfully updated, it will be uploaded to the device during next connection."),i.back("core.devices.wa.start")})).catch((function(e){c.loading=!1,m(e)})))}}}]),angular.module("wa").controller("WaDataViewerController",["$scope","Authentication","$q","$stateParams","TdDialog","WirelessAccelFile","$interval",function(e,t,n,a,o,i,r){var s=3,l=16/32768,c=250/32768,u=1666,d=this,m=null,f=null,p=null,g=null;function v(){return n((function(e,t){d.progress={type:"indeterminate",value:void 0,disabled:!1},i.get(function(){var e,t={},n=a.path.split("/");for(e=0;e<n.length;++e)t["lvl"+(e+1)]=n[e];return t}()).then((function(t){d.progress.disabled=!0,e(t)}),(function(e){d.progress.disabled=!0,o.error("Wireless Accelerometer",e,"Cannot find logging data file."),t(e)}))}))}function h(e,t,n,a,o,i){var r=1/u;return new Highcharts.Chart({plotOptions:{series:{borderWidth:0,animation:!1,states:{hover:{enabled:!1}},marker:{enabled:!1},pointStart:0,pointInterval:r}},chart:{zoomType:"xy",renderTo:e,animation:!1},tooltip:{useHTML:!0,shared:!0,formatter:function(){var e="";return e+='<span style="font-size: 10px">'+Highcharts.numberFormat(this.points[0].x,3)+" s</span><br/>",angular.forEach(this.points,(function(t){e+='<span style="color:'+t.color+'">●</span> '+t.series.name+": <b>"+t.y.toFixed(3)+" "+n+"</b><br/>"})),e}},legend:{width:300,itemWidth:100,itemStyle:{width:100}},credits:{enabled:!1},title:{text:t},xAxis:{title:{text:"Time [s]"}},yAxis:[{min:a,max:o,startOnTick:!0,endOnTick:!0,labels:{format:"{value} "+n},title:{text:t+" ["+n+"]"}}],series:i})}function w(){for(var e=d.file,t=function(e){for(var t,n=0,a=0;a<s;a++)(t=e.acceleration.samplesList[a].valuesList.length)>n&&(n=t),(t=e.gyroscope.samplesList[a].valuesList.length)>n&&(n=t);return n}(e),n="Time [s],ACC-X [g],ACC-Y [g],ACC-Z [g],GYR-X [dps],GYR-Y [dps],GYR-Z [dps]\n",a=0,o=0;o<t;o++){n+=a+",";for(var i=0;i<s;i++){n+=(y(e.acceleration,i,o)*l).toFixed(4)+","}for(i=0;i<s;i++){n+=(y(e.gyroscope,i,o)*c).toFixed(4)+","}n+="\n",a+=1/u}return n}function y(e,t,n){var a=e.samplesList;if(t>a.length)return 0;var o=a[t].valuesList;return n>o.length?0:o[n]}d.authentication=t,d.file=null,d.progress={type:"determinate",value:100,disabled:!0},d.canvasStyle={height:"80px"},d.samplingRate=u,e.$on("$destroy",(function(){m&&(r.cancel(m),m=null),f&&(r.cancel(f),f=null)})),d.get=function(){p=h("chartAcc","Acceleration","g",-16,16,[{name:"X",type:"line",data:[],tooltip:{valueSuffix:" g"}},{name:"Y",type:"line",data:[],tooltip:{valueSuffix:" g"}},{name:"Z",type:"line",data:[],tooltip:{valueSuffix:" g"}}]),g=h("chartGyr","Angular Rate","dps",-250,250,[{name:"X",type:"line",data:[],tooltip:{valueSuffix:" dps"}},{name:"Y",type:"line",data:[],tooltip:{valueSuffix:" dps"}},{name:"Z",type:"line",data:[],tooltip:{valueSuffix:" dps"}}]),p.showLoading("Loading..."),g.showLoading("Loading..."),v().then((function(e){console.log(e),d.file=e;for(var t=0;t<s;t++)p.series[t].setData(e.acceleration.samplesList[t].valuesList.map((function(e){return e*l}))),g.series[t].setData(e.gyroscope.samplesList[t].valuesList.map((function(e){return e*c})));var n,a,o,i;p.hideLoading(),g.hideLoading(),n=angular.element("#chartAcc"),a=0,o=angular.element("#chartGyr"),i=0,f=r((function(){n.width()!==a&&(a=n.width(),p.setSize(a,p.height)),o.width()!==i&&(i=o.width(),g.setSize(i,g.height))}),500)}))},d.downloadCSV=function(){!function(e,t){var n=new Blob([t],{type:"text/csv;charset=utf-8;"}),a=URL.createObjectURL(n),o=document.createElement("a");o.style.visibility="hidden",o.setAttribute("href",a),o.setAttribute("download",e),document.body.appendChild(o),o.click(),document.body.removeChild(o)}(d.file.timestamp.toFixed()+".csv",w())}}]),angular.module("wa").controller("WaStatisticsController",["$scope","Authentication","$q","$stateParams","TdDialog","TdAdvert","WaSample","Wa","WaConnectionStatus","StateHelper","$window","$interval",function(e,t,n,a,o,i,r,s,m,f,p,g){var v=this,h=200,w=[],y=null,b=0,x=null,C=null,S=null,$={temperature:{title:"Temperature",units:[new c]},batteryVoltage:{title:"Battery Voltage",units:[new u]},rssi:{title:"RSSI",units:[new l]},restartsUnknown:{title:"Unknown Restarts",units:[new d]},restartsSoftware:{title:"Software Restarts",units:[new d]},restartsWatchdog:{title:"Watchdog Restarts",units:[new d]},configNumber:{title:"Configuration Number",units:[new d]},packetCounter:{title:"Packet Counter",units:[new d]}};function D(e,t){e===v.wa.uuid&&(v.wa||(v.wa={}),v.wa.connection||(v.wa.connection={}),v.wa.connection.status=t)}function A(e,t){e===v.wa.uuid&&(v.wa||(v.wa={}),v.wa.advertisement=t)}function I(e,t){if(e===v.wa.uuid){var n,a=y;if(y=t,!0!==v.loadingSamples)if(!a||a.packetCounter!==t.packetCounter)if(!(t.timestamp<new Date(2010,1,1,1,0,0,0).getTime()))v.sample=t,b+=1,T(t),V(0,n=t),V(1,n)}}function k(){return v.loadingSamples=!0,C.showLoading("Loading..."),(e=b,t=h,r.query({uuid:v.wa.uuid,skip:e,limit:t})).then((function(e){return v.loadingSamples=!1,C.hideLoading(),e.samplesList&&(b+=e.samplesList.length),e.samplesList}),(function(e){throw v.loadingSamples=!1,C.hideLoading(),o.error("Load Samples",e,"Cannot load samples."),e}));var e,t}function U(){P(0),P(1)}function T(e){e&&w.push(e)}function L(e){e&&w.unshift(e)}function q(e){var t=v.channels[e].selectedChannel,n=$[t];v.channels[e].availableUnits=n.units.filter((function(e,t){return!n.allowedUnits||-1!==n.allowedUnits().indexOf(t)})).map((function(e,t){return{name:e.Unit,value:t.toString()}}));var a=0;n.defaultUnit&&(a=n.defaultUnit()),v.channels[e].selectedUnit=v.channels[e].availableUnits[a],P(e)}function O(e){P(e)}function P(e){var t=v.channels[e].selectedChannel,n=parseInt(v.channels[e].selectedUnit.value),a=$[t],o=a.title,i=a.units[n],r=i.Unit,s=i.ValueDecimals,l=i.DetailedValueDecimals;C.yAxis[e].update({labels:{format:"{value:."+s+"f}",style:{color:Highcharts.getOptions().colors[e]}},title:{text:o+(r?" ("+r+")":""),style:{color:Highcharts.getOptions().colors[e]}}}),C.series[e].update({name:o+(r?" ("+r+")":""),type:"line",yAxis:e,data:w.map((function(e){return[e.timestamp,i.convert(e[t],e)]})),tooltip:{valueSuffix:r?" ("+r+")":"",valueDecimals:l}})}function V(e,t){var n=v.channels[e].selectedChannel,a=parseInt(v.channels[e].selectedUnit.value),o=$[n].units[a];C.series[e].addPoint([t.timestamp,o.convert(t[n],t)])}e.$on("$destroy",(function(){i.removeListener("advert",A),r.removeListener("sample",I),m.removeListener("status",D),x&&(g.cancel(x),x=null),S&&S()})),v.authentication=t,v.loadingDevice=!1,v.loadingSamples=!1,v.wa,v.sample,v.config,v.canvasStyle={height:"80px"},v.channels=[{selectedChannel:"temperature",channelChanged:function(){q(0)},selectedUnit:{value:"0",name:"°C"},availableUnits:[{value:"0",name:"°C"}],unitChanged:function(){O(0)},style:{color:Highcharts.getOptions().colors[0]}},{selectedChannel:"batteryVoltage",channelChanged:function(){q(1)},selectedUnit:{value:"0",name:"V"},availableUnits:[{value:"0",name:"V"}],unitChanged:function(){O(1)},style:{color:Highcharts.getOptions().colors[1]}}],v.get=function(){(v.loadingDevice=!0,s.get({waId:a.waId}).$promise.then((function(e){v.wa=e,v.config=e.remoteConfig,v.loadingDevice=!1}),(function(e){throw v.loadingDevice=!1,o.error("Wireless Accelerometer",e,"Cannot find device in the data base."),e}))).then((function(){var e,t,n;return C=new Highcharts.Chart({plotOptions:{series:{borderWidth:0,animation:!1,states:{hover:{enabled:!1}},marker:{enabled:!1}}},chart:{zoomType:"x",renderTo:"chart",animation:!1},legend:{width:300,itemWidth:150,itemStyle:{width:150}},credits:{enabled:!1},title:{text:""},xAxis:{title:{text:"Date"},type:"datetime"},yAxis:[{labels:{format:"{value} V",style:{color:Highcharts.getOptions().colors[0]}},title:{text:"Battery Voltage",style:{color:Highcharts.getOptions().colors[0]}}},{title:{text:"Temperature",style:{color:Highcharts.getOptions().colors[1]}},labels:{format:"{value} °C",style:{color:Highcharts.getOptions().colors[1]}},opposite:!0}],series:[{name:"Battery Voltage",type:"line",yAxis:0,data:[],tooltip:{valueSuffix:" V"}},{name:"Temperature",type:"line",yAxis:1,data:[],tooltip:{valueSuffix:" °C"}}]}),e=angular.element("#chart"),t=0,n=setInterval((function(){e.width()!==t&&(t=e.width(),C.setSize(t,C.height))}),500),S=function(){clearInterval(n)},k()})).then((function(e){y=e[0],v.sample=y,q(0),function(e){for(var t=e.length-1;t>=0;t--)T(e[t])}(e),U(),i.on("advert",A),r.on("sample",I),m.on("status",D)}))},v.loadMore=function(){k().then((function(e){!function(e){for(var t=0;t<e.length;t++)L(e[t])}(e),U()}))}}]),angular.module("wa").controller("WaIndividualController",["$scope","$state","Wa","WaConnectionStatus","TdDialog","TdAdvert","WaSocket","WaStream","Dpm",function(e,t,n,a,o,i,r,s,l){var c=this;e.$on("$destroy",(function(){c.selected[0]?sessionStorage.setItem("wa.individual.selected",c.selected[0].uuid):sessionStorage.setItem("wa.individual.selected",void 0),sessionStorage.setItem("wa.individual.query",JSON.stringify(c.query)),i.removeListener("advert",h),a.removeListener("status",v),r.removeListener("app:wa:config-state",w)})),c.isLoading=!1,c.selected=[],c.section="devices";var u=sessionStorage.getItem("wa.individual.query"),d=sessionStorage.getItem("wa.individual.selected");c.query=u?JSON.parse(u):{order:"uuid",limit:10,page:1};function m(e){return n.query(query).$promise.then((function(t){p(t,e)}))}function f(e){return l.query(query).$promise.then((function(t){p(t,e)}))}function p(e,t){t.count+=e.count,e.devices.forEach((function(e){t.devices.push(e)}))}function g(e){return _.find(c.was.devices,(function(t){return e===t.uuid}))}function v(e,t){var n=g(e);n&&_.set(n,"connection.status",t)}function h(e,t){var n=g(e);n&&_.set(n,"advertisement",t)}function w(e,t,n){if("upload"===t||"download"===t){var a=g(e);a&&(_.set(a,"config.timestamp",n.timestamp),_.set(a,"config.primary",n.primary))}}c.get=function(){c.isLoading=!0;var e;c.query.order,c.query.page,c.query.limit,c.query.limit;(e={count:0,devices:[]},m(e).then((function(){return f(e)})).then((function(){return e})).catch((function(e){throw o.error("Wireless Accelerometer",e,"Cannot load devices."),e}))).then((function(e){c.was=e,d&&c.was.devices.forEach((function(e){e.uuid===d&&(c.selected[0]=e)})),a.on("status",v),i.on("advert",h),r.on("app:wa:config-state",w),c.isLoading=!1})).catch((function(e){c.isLoading=!1}))},c.stream=function(){if(c.selected[0]){c.isLoading=!0;var e=c.selected[0].uuid;s.request(e,50).then((function(){c.isLoading=!1,t.go("core.devices.wa.connecting",{waId:c.selected[0].uuid,request:"start-stream"})}),(function(e){c.isLoading=!1,o.error("Wireless Accel Error",e,"Cannot start data stream.")}))}},c.statistics=function(){c.selected[0]&&t.go("core.devices.wa.stats",{waId:c.selected[0].uuid})},c.editSleep=function(){c.selected[0]&&t.go("core.devices.wa.edit-sleep",{waId:c.selected[0].uuid})},c.edit=function(){c.selected[0]&&t.go("core.devices.wa.edit",{waId:c.selected[0].uuid})}}]),angular.module("wa").controller("WaEvtViewerController",["$scope","Authentication","$q","$stateParams","TdDialog","WirelessAccelEvent","$interval",function(e,t,n,a,o,i,r){var s=3,l=16/32768,c=415,u=this,d=null,m=null,f=null;function p(){return n((function(e,t){u.progress={type:"indeterminate",value:void 0,disabled:!1},i.get(function(){var e,t={},n=a.path.split("/");for(e=0;e<n.length;++e)t["lvl"+(e+1)]=n[e];return t}()).then((function(t){u.progress.disabled=!0,e(t)}),(function(e){u.progress.disabled=!0,o.error("Wireless Accelerometer",e,"Cannot find event data file."),t(e)}))}))}function g(){for(var e=u.file.data,t=function(e){for(var t,n=0,a=0;a<s;a++)(t=e.samplesList[a].valuesList.length)>n&&(n=t);return n}(e),n="Time [s],ACC-X [g],ACC-Y [g],ACC-Z [g]\n",a=0,o=0;o<t;o++){n+=a+",";for(var i=0;i<s;i++){n+=(v(e,i,o)*l).toFixed(4)+","}n+="\n",a+=1/c}return n}function v(e,t,n){var a=e.samplesList;if(t>a.length)return 0;var o=a[t].valuesList;return n>o.length?0:o[n]}u.authentication=t,u.file=null,u.progress={type:"determinate",value:100,disabled:!0},u.canvasStyle={height:"80px"},u.samplingRate=c,e.$on("$destroy",(function(){d&&(r.cancel(d),d=null),m&&(r.cancel(m),m=null)})),u.get=function(){var e,t,n,a,o,i,d;e="chartAcc",t="Acceleration",n="g",a=-16,o=16,i=[{name:"X",type:"line",data:[],tooltip:{valueSuffix:" g"}},{name:"Y",type:"line",data:[],tooltip:{valueSuffix:" g"}},{name:"Z",type:"line",data:[],tooltip:{valueSuffix:" g"}}],d=1/c,(f=new Highcharts.Chart({plotOptions:{series:{borderWidth:0,animation:!1,states:{hover:{enabled:!1}},marker:{enabled:!1},pointStart:0,pointInterval:d}},chart:{zoomType:"xy",renderTo:e,animation:!1},tooltip:{useHTML:!0,shared:!0,formatter:function(){var e="";return e+='<span style="font-size: 10px">'+Highcharts.numberFormat(this.points[0].x,3)+" s</span><br/>",angular.forEach(this.points,(function(t){e+='<span style="color:'+t.color+'">●</span> '+t.series.name+": <b>"+t.y.toFixed(3)+" "+n+"</b><br/>"})),e}},legend:{width:300,itemWidth:100,itemStyle:{width:100}},credits:{enabled:!1},title:{text:t},xAxis:{title:{text:"Time [s]"}},yAxis:[{min:a,max:o,startOnTick:!0,endOnTick:!0,labels:{format:"{value} "+n},title:{text:t+" ["+n+"]"}}],series:i})).showLoading("Loading..."),p().then((function(e){console.log(e),u.file=e;for(var t=0;t<s;t++)f.series[t].setData(e.data.samplesList[t].valuesList.map((function(e){return e*l})));var n,a;f.hideLoading(),n=angular.element("#chartAcc"),a=0,m=r((function(){n.width()!==a&&(a=n.width(),f.setSize(a,f.height))}),500)}))},u.downloadCSV=function(){!function(e,t){var n=new Blob([t],{type:"text/csv;charset=utf-8;"}),a=URL.createObjectURL(n),o=document.createElement("a");o.style.visibility="hidden",o.setAttribute("href",a),o.setAttribute("download",e),document.body.appendChild(o),o.click(),document.body.removeChild(o)}(u.file.timestamp.toFixed()+".csv",g())}}]),angular.module("wa").controller("WaStreamController",["$rootScope","$scope","$q","$state","$stateParams","$interval","$window","TdDialog","Authentication","Wa","WaStream","TdAdvert","WaConnectionStatus",function(e,t,n,a,o,i,m,f,p,g,v,h,w){var y=this,b=null,x=!1,C=12,S=.5,$=.2,D=10,A=1/D*1e3,I=C/A*1e3,k=S/A*1e3,U=$/A*1e3,T=0,L=0,q=null;y.authentication=p,y.loadingDevice=!1,y.loadingSamples=!1,y.sample=null,y.samples=[],y.chartConfig={options:{chart:{zoomType:"x",animation:!1},exporting:{enabled:!1},plotOptions:{series:{borderWidth:0,animation:!1,marker:{enabled:!1}}}},credits:{enabled:!1},legend:{width:300,itemWidth:150,itemStyle:{width:150}},title:{text:""},xAxis:{type:"datetime",title:{text:"Date"}},yAxis:[{labels:{style:{color:Highcharts.getOptions().colors[0]}},title:{style:{color:Highcharts.getOptions().colors[0]}}},{title:{style:{color:Highcharts.getOptions().colors[1]}},labels:{style:{color:Highcharts.getOptions().colors[1]}},opposite:!0}],series:[{type:"line",yAxis:0,data:Y(),tooltip:{valueSuffix:""}},{type:"line",yAxis:1,data:Y(),tooltip:{valueSuffix:""}}],func:function(e){b=e}};var O=e.$on("$stateChangeStart",(function(e,t,n,a,o,i){if(!0===x)return;x=!0,e.preventDefault(),_(t.name)}));function P(e){var t="Do not leave this page during connection, please navigate back first to disconnect first.";return e.returnValue=t,t}function V(e){}t.$on("$destroy",(function(){O(),h.removeListener("advert",E),w.removeListener("status",H),v.removeListener("sample",F),v.removeListener("state",N),m.removeEventListener("beforeunload",P),m.removeEventListener("unload",V),q&&(clearInterval(q),q=null),b=null})),m.addEventListener("beforeunload",P),m.addEventListener("unload",V);var M={sensorAccelX:{title:"Accel-X",units:[new r]},sensorAccelY:{title:"Accel-Y",units:[new r]},sensorAccelZ:{title:"Accel-Z",units:[new r]},sensorGyroX:{title:"Gyro-X",units:[new s]},sensorGyroY:{title:"Gyro-Y",units:[new s]},sensorGyroZ:{title:"Gyro-Z",units:[new s]},temperature:{title:"Temperature",units:[new c]},batteryVoltage:{title:"Battery Voltage",units:[new u]},remoteRssi:{title:"RSSI - Remote",units:[new l]},localRssi:{title:"RSSI - Local",units:[new l]},packetCounter:{title:"Packet Counter",units:[new d]}};function W(e){var t=y.channels[e].selectedChannel,n=M[t];y.channels[e].availableUnits=n.units.filter((function(e,t){return!n.allowedUnits||-1!==n.allowedUnits().indexOf(t)})).map((function(e,t){return{name:e.Unit,value:t.toString()}}));var a=0;n.defaultUnit&&(a=n.defaultUnit()),y.channels[e].selectedUnit=y.channels[e].availableUnits[a],B(e)}function R(e){B(e)}function B(e){var t=function(e){const t=y.channels[e];var n=M[t.selectedChannel],a=n.units[parseInt(t.selectedUnit.value)];return{def:n,unit:a,unit:a}}(e);b.yAxis[e].update(function(e,t,n){return{labels:{format:"{value:."+t.ValueDecimals+"f}",style:{color:Highcharts.getOptions().colors[n]}},title:{text:e.title+(t.Unit?" ("+t.Unit+")":""),style:{color:Highcharts.getOptions().colors[n]}},startOnTick:!0,endOnTick:!0}}(t.def,t.unit,e));var n=function(e,t){if(e.minmax)return{min:e.minmax.min,max:e.minmax.max};var n=t.minmax(y.config.primary);if(n)return{min:n.min,max:n.max};return{min:void 0,max:void 0}}(t.def,t.unit);b.yAxis[e].setExtremes(n.min,n.max),b.series[e].update(function(e,t,n){return{name:e.title+(t.Unit?" ("+t.Unit+")":""),type:"line",yAxis:n,data:j(n,y.config.primary),tooltip:{valueSuffix:t.Unit?" ("+t.Unit+")":"",valueDecimals:t.DetailedValueDecimals}}}(t.def,t.unit,e))}function E(e,t){e===y.wa.uuid&&console.log(t)}function H(e,t){e===y.wa.uuid&&console.log(e,t)}function F(e,t){e===y.wa.uuid&&t&&(null===y.sample&&(y.sample=t,y.loadingSamples=!1),++T>=k&&(T=0,y.sample=t),b&&function(e){if(!b)return;var t=Date.now();y.samples.unshift({timestamp:t,sample:e});for(;y.samples.length>I;)y.samples.pop();z(0,t,e,y.config.primary),z(1,t,e,y.config.primary),++L>U&&(b.xAxis[0].setExtremes(t-I*A,t),b.redraw())}(t))}function N(e,t,n){e===y.wa.uuid&&("stopped"===t?(n&&(console.log(n),f.error("Data Stream",void 0,n)),_("core.devices.wa.start")):console.log("unhandled stream state: "+t))}function _(e){a.go("core.devices.wa.connecting",{waId:y.wa.uuid,request:"stop-stream",next:e})}function z(e,t,n,a){b.series[e].addPoint(G(e,t,n,a),!1,!0,!1)}function G(e,t,n,a){var o=y.channels[e].selectedChannel,i=parseInt(y.channels[e].selectedUnit.value);return[t,M[o].units[i].convert(n[o],a)]}function j(e,t){for(var n=[],a=(new Date).getTime(),o=I-1;o>=0;o--){var i=a+-o*A,r=null;y.samples&&y.samples[o]&&y.samples[o].timestamp&&y.samples[o].sample&&(i=parseInt(y.samples[o].timestamp),r=y.samples[o].sample),r?n.push(G(e,i,r,t)):n.push([i,0])}return n}function Y(){var e,t=[],n=(new Date).getTime();for(e=-I;e<=0;e++)t.push({x:n+e*A,y:0});return t}y.channels=[{selectedChannel:"sensorAccelX",channelChanged:function(){W(0)},selectedUnit:{value:"0",name:"pF"},availableUnits:[{value:"0",name:"pF"}],unitChanged:function(){R(0)},style:{color:Highcharts.getOptions().colors[0]}},{selectedChannel:"sensorAccelY",channelChanged:function(){W(1)},selectedUnit:{value:"0",name:"°C"},availableUnits:[{value:"0",name:"°C"}],unitChanged:function(){R(1)},style:{color:Highcharts.getOptions().colors[1]}}],y.get=function(){y.loadingSamples=!0,function(){y.loadingDevice=!0;var e=o.waId;return g.get({waId:e}).$promise.then((function(t){return y.wa=t,y.advert=t.advertisement,y.config=t.remoteConfig,v.load(e)})).then((function(e){D=e.options.freq,I=C/(A=1/D*1e3)*1e3,k=S/A*1e3,U=$/A*1e3,T=0,L=0,y.loadingDevice=!1})).catch((function(e){throw y.loadingDevice=!1,f.error("Wireless Accelerometer",errorResponse,"Cannot load data from the data base."),errorResponse}))}().then((function(){h.on("advert",E),w.on("status",H),v.on("sample",F),v.on("state",N),q=setInterval((function(){v.ping(y.wa.uuid).then((function(){console.log("ping")})).catch((function(e){console.log("ping error"+e)}))}),5e3),W(0),W(1)}),(function(e){f.error("Wireless Accelerometer",e,"Canot load device.")}))}}]),angular.module("wa").controller("PandasController",["$rootScope","$scope","Authentication",function(e,t,n){t.authentication=n,e.section="devices.pandas"}]),angular.module("wa").controller("WaEditController",["Authentication","$stateParams","TdDialog","Wa","StateHelper","$mdToast","WaConfig",function(e,t,n,a,o,i,r){var s,l=this,c="0",u=!1;l.authentication=e,l.loading=!1,l.fault=!1,l.wa,l.config,l.loggingMode=c,l.tapDeltaUnit=0;for(var d=[],m=["Channel X","Channel Y","Channel Z"],f=0;f<3;f++)d.push({name:m[f],triggerEnabled:!0,minDelta:10,minDeltaUnit:"g",offset:10,offsetUnit:"g"});function p(e){i.show(i.simple().position("bottom right").textContent(e).hideDelay(3e3))}l.formData=d,l.get=function(){var e,n;l.loading=!0,(n=t.waId,a.get({waId:n}).$promise.catch((function(e){throw"Cannot find device in the data base."}))).then((function(t){return function(e){return r.get(e).catch((function(e){throw"Cannot load configuration."}))}(e=t)})).then((function(t){return function(e,t){if(!e||!t)throw"Invalid data.";l.wa=e,l.config=t,u=e.enabled,s=_.cloneDeep(t),c=s.primary.modesEnabled.toString(),l.loggingMode=c.toString(),l.tapDeltaUnit=function(e){if(!e)return 0;return 16*e/32}(l.config.primary.xlTapDelta)}(e,t)})).then((function(){l.loading=!1})).catch((function(e){l.loading=!1,l.fault=!0,p(e)}))},l.submit=function(e){if(l.wa){l.loggingMode!==c&&(l.config.primary.modesEnabled=parseInt(l.loggingMode,10),console.log("logging mode: "+l.config.primary.modesEnabled));var t=parseInt(l.tapDeltaUnit,10);l.config.primary.xlTapDelta=function e(t){return t?Math.round(32*t/16):e(2)}(t),"string"==typeof l.wa.enabled&&(l.wa.enabled="true"===l.wa.enabled),u!==l.wa.enabled&&(!0===l.wa.enabled?l.wa.connection.status.label="N/A":l.wa.connection.status.label="Disabled");var n,a=_.cloneDeep(l.config),i=!angular.equals(a,s);l.loading=!0,(n=l.wa,n.$update().catch((function(e){throw"Cannot save device."}))).then((function(){if(i)return function(e,t){return r.upload(e,t).catch((function(e){throw"Cannot add configuration upload task."}))}(l.wa,a).then((function(){p("The configuration has been successfully updated, it will be uploaded to the device during next connection.")}));p("The device has been successfully updated.")})).then((function(){l.loading=!1,o.back("core.devices.wa.start")})).catch((function(e){l.loading=!1,p(e)}))}},l.download=function(){var e;l.wa&&(l.loading=!0,(e=l.wa,r.download(e).catch((function(e){throw"Cannot add configuration download task."}))).then((function(){l.loading=!1,p("The configuration will be downloaded from the device during next connection."),o.back("core.devices.wa.start")})).catch((function(e){l.loading=!1,p(e)})))}}]),angular.module("wa").factory("WaSocket",["socketFactory",function(e){var t=io.connect();return t.on("connect",(function(){t.emit("name","www")})),e({prefix:"app:wa:",ioSocket:t})}]),angular.module("wa").factory("WaConnectionStatus",["$q","WaSocket",function(e,t){var n={status:null};return t.on("app:wa:status",(function(e,t){n.status&&n.status(e,t)})),{on:function(e,t){"status"===e&&(n.status=t)},removeListener:function(e,t){"status"===e&&(n.status=null)}}}]),angular.module("wa").factory("WaConfig",["Task",function(e){return{upload:function(t,n){var a=t.uuid;return new e({uuid:a,command:"upload",mode:"Individual",options:n}).$save()},download:function(t){var n=t.uuid;return function(t){return e.query({uuid:t,command:"download",order:"-createdOn",limit:1,skip:0}).$promise}(n).then((function(t){return t.tasks.length?t.tasks[0]:new e({uuid:n,command:"download",mode:"Individual"}).$save()}))},get:function(t){return(n=t.uuid,e.query({uuid:n,command:"upload",order:"-createdOn",limit:1,skip:0}).$promise).then((function(e){var n=e.tasks,a=n.length?n[0].options:t.remoteConfig;return _.cloneDeep(a)}));var n}}}]),angular.module("wa").factory("Wa",["$resource",function(e){return e("api/wa/:waId",{waId:"@uuid"},{update:{method:"PUT"},query:{method:"GET",isArray:!1}})}]),angular.module("wa").factory("WaSamples",["$resource",function(e){return e("api/wa/samples/:waDeviceId",{waDeviceId:"@uuid"},{update:{method:"PUT"}})}]),angular.module("wa").factory("Dpm",["$resource",function(e){return e("api/dpm/:dpmId",{dpmId:"@uuid"},{update:{method:"PUT"},query:{method:"GET",isArray:!1}})}]),angular.module("wa").factory("DpmSamples",["$resource",function(e){return e("api/dpm/samples/:dpmDeviceId",{dpmDeviceId:"@uuid"},{update:{method:"PUT"}})}]),goog.require("proto.WirelessAccelSample.Data"),goog.require("proto.WirelessAccelSample.DataArray"),angular.module("wa").factory("WaSample",["$q","$resource","TdSocket","TdDialog",function(e,t,n,a){var o={sample:null},i=t("api/wa-sample",null,{get:{responseType:"arraybuffer",transformResponse:function(e,t){return{data:e}}}});return n.on("app:wa:sample",(function(e,t){if(o.sample){var n=proto.WirelessAccelSample.Data.deserializeBinary(new Uint8Array(t));o.sample(e,n.toObject())}})),{query:function(t){return e((function(e,n){t.proto="protobuf",i.get(t).$promise.then((function(t){var n=proto.WirelessAccelSample.DataArray.deserializeBinary(new Uint8Array(t.data));e(n.toObject())}),(function(e){n(e)}))}))},on:function(e,t){"sample"===e&&(o.sample=t)},removeListener:function(e,t){"sample"===e&&(o.sample=null)}}}]),angular.module("wa").factory("WaStream",["$q","WaSocket","Task",function(e,t,n){var a={sample:null,state:null};return t.on("app:wa:stream-sample",(function(e,t){a.sample&&a.sample(e,t)})),t.on("app:wa:stream-state",(function(e,t,n){console.log(t),a.state&&a.state(e,t,n)})),{load:function(e){return o(e,1).then((function(e){return 0===e.tasks.length?null:e.tasks[0]}))},request:function(e,t){return o(e,1).then((function(a){if(a.tasks.length){var o=a.tasks[0];return new n(o).$update()}return new n({uuid:e,createdOn:Date.now(),command:"stream",mode:"Individual",options:{freq:t}}).$save()}))},ping:function(e){return o(e,1).then((function(e){if(e.tasks.length){var t=e.tasks[0];return new n(t).$update()}}))},cancelRequest:function(t){return o(t.uuid).then((function(t){var a=t.tasks.map((function(e){return new n(e).$remove()}));return e.all(a)}))},on:function(e,t){"sample"===e?a.sample=t:"state"===e&&(a.state=t)},removeListener:function(e,t){"sample"===e?a.sample=null:"state"===e&&(a.state=null)}};function o(e,t){var a={uuid:e,command:"stream",order:"-createdOn",skip:0};return t&&(a.limit=t),n.query(a).$promise}}]),goog.provide("proto.WirelessAccelFile.File"),angular.module("wa").factory("WirelessAccelFile",["$q","$resource",function(e,t){var n=t("api/fs/:lvl1/:lvl2/:lvl3/:lvl4/:lvl5/:lvl6",null,{get:{responseType:"arraybuffer",transformResponse:function(e,t){return{data:e}}}});return{get:function(t){return e((function(e,a){n.get(t).$promise.then((function(t){e(proto.WirelessAccelFile.File.deserializeBinary(new Uint8Array(t.data)).toObject())}),(function(e){a(e)}))}))}}}]),goog.provide("proto.WirelessAccelEvent.Event"),goog.require("proto.Location"),angular.module("wa").factory("WirelessAccelEvent",["$q","$resource",function(e,t){var n=t("api/fs/:lvl1/:lvl2/:lvl3/:lvl4/:lvl5/:lvl6",null,{get:{responseType:"arraybuffer",transformResponse:function(e,t){return{data:e}}}});return{get:function(t){return e((function(e,a){n.get(t).$promise.then((function(t){e(proto.WirelessAccelEvent.Event.deserializeBinary(new Uint8Array(t.data)).toObject())}),(function(e){a(e)}))}))}}}]),angular.module("atl").directive("atlConfigurationGeneral",(function(){return{templateUrl:"modules/atl/views/atl-edit.client.view.html"}})),angular.module("atl").directive("atlConfigurationTime",(function(){return{templateUrl:"modules/atl/views/atl-edit-sleep.client.view.html"}})),angular.module("atl").directive("atlConfigurationCapacity",(function(){return{templateUrl:"modules/atl/views/atl-calibration.client.view.html"}})),angular.module("atl").directive("atlConfigurationLogging",(function(){return{templateUrl:"modules/atl/views/atl-logging.client.view.html"}})),angular.module("atl").config(["$stateProvider",function(e){e.state("core.devices.atl",{abstract:!0,url:"/atl",templateUrl:"modules/atl/views/atl-content.client.view.html"}).state("core.devices.atl.start",{url:"/",templateUrl:"modules/atl/views/atl-individual.client.view.html"}).state("core.devices.atl.stats",{url:"/statistics/:atlId",templateUrl:"modules/atl/views/atl-statistics.client.view.html"}).state("core.devices.atl.edit",{url:"/edit/:atlId",templateUrl:"modules/atl/views/atl-edit.client.view.html"}).state("core.devices.atl.edit-sleep",{url:"/edit-sleep/:atlId",templateUrl:"modules/atl/views/atl-edit-sleep.client.view.html"}).state("core.devices.atl.connecting",{url:"/connecting/:atlId/:request/:next",templateUrl:"modules/atl/views/atl-connecting.client.view.html"}).state("core.devices.atl.stream",{url:"/stream/:atlId",templateUrl:"modules/atl/views/atl-stream.client.view.html"}).state("core.devices.atl.log-view",{url:"/log-view/:path",templateUrl:"modules/atl/views/atl-data-viewer.client.view.html"})}]),angular.module("atl").controller("AtlDataViewerController",["$scope","Authentication","$q","$stateParams","TdDialog","AtlFile","$interval",function(e,t,n,a,o,i,r){var s=3,l=2/32768,c=250/32768,u=1666,d=this,m=null,f=null,p=null,g=null;function v(){return n((function(e,t){d.progress={type:"indeterminate",value:void 0,disabled:!1},i.get(function(){var e,t={},n=a.path.split("/");for(e=0;e<n.length;++e)t["lvl"+(e+1)]=n[e];return t}()).then((function(t){d.progress.disabled=!0,e(t)}),(function(e){d.progress.disabled=!0,o.error("ATL",e,"Cannot find logging data file."),t(e)}))}))}function h(e,t,n,a,o,i){var r=1/u;return new Highcharts.Chart({plotOptions:{series:{borderWidth:0,animation:!1,states:{hover:{enabled:!1}},marker:{enabled:!1},pointStart:0,pointInterval:r}},chart:{zoomType:"xy",renderTo:e,animation:!1},tooltip:{useHTML:!0,shared:!0,formatter:function(){var e="";return e+='<span style="font-size: 10px">'+Highcharts.numberFormat(this.points[0].x,3)+" s</span><br/>",angular.forEach(this.points,(function(t){e+='<span style="color:'+t.color+'">●</span> '+t.series.name+": <b>"+t.y.toFixed(3)+" "+n+"</b><br/>"})),e}},legend:{width:300,itemWidth:100,itemStyle:{width:100}},credits:{enabled:!1},title:{text:t},xAxis:{title:{text:"Time [s]"}},yAxis:[{min:a,max:o,startOnTick:!0,endOnTick:!0,labels:{format:"{value} "+n},title:{text:t+" ["+n+"]"}}],series:i})}function w(){for(var e=d.file,t=function(e){for(var t,n=0,a=0;a<s;a++)(t=e.acceleration.samplesList[a].valuesList.length)>n&&(n=t),(t=e.gyroscope.samplesList[a].valuesList.length)>n&&(n=t);return n}(e),n="Time [s],ACC-X [g],ACC-Y [g],ACC-Z [g],GYR-X [dps],GYR-Y [dps],GYR-Z [dps]\n",a=0,o=0;o<t;o++){n+=a+",";for(var i=0;i<s;i++){n+=(y(e.acceleration,i,o)*l).toFixed(4)+","}for(i=0;i<s;i++){n+=(y(e.gyroscope,i,o)*c).toFixed(4)+","}n+="\n",a+=1/u}return n}function y(e,t,n){var a=e.samplesList;if(t>a.length)return 0;var o=a[t].valuesList;return n>o.length?0:o[n]}d.authentication=t,d.file=null,d.progress={type:"determinate",value:100,disabled:!0},d.canvasStyle={height:"80px"},d.samplingRate=u,e.$on("$destroy",(function(){m&&(r.cancel(m),m=null),f&&(r.cancel(f),f=null)})),d.get=function(){p=h("chartAcc","Acceleration","g",-2,2,[{name:"X",type:"line",data:[],tooltip:{valueSuffix:" g"}},{name:"Y",type:"line",data:[],tooltip:{valueSuffix:" g"}},{name:"Z",type:"line",data:[],tooltip:{valueSuffix:" g"}}]),g=h("chartGyr","Angular Rate","dps",-250,250,[{name:"X",type:"line",data:[],tooltip:{valueSuffix:" dps"}},{name:"Y",type:"line",data:[],tooltip:{valueSuffix:" dps"}},{name:"Z",type:"line",data:[],tooltip:{valueSuffix:" dps"}}]),p.showLoading("Loading..."),g.showLoading("Loading..."),v().then((function(e){console.log(e),d.file=e;for(var t=0;t<s;t++)p.series[t].setData(e.acceleration.samplesList[t].valuesList.map((function(e){return e*l}))),g.series[t].setData(e.angularRate.samplesList[t].valuesList.map((function(e){return e*c})));var n,a,o,i;p.hideLoading(),g.hideLoading(),n=angular.element("#chartAcc"),a=0,o=angular.element("#chartGyr"),i=0,f=r((function(){n.width()!==a&&(a=n.width(),p.setSize(a,p.height)),o.width()!==i&&(i=o.width(),g.setSize(i,g.height))}),500)}))},d.downloadCSV=function(){!function(e,t){var n=new Blob([t],{type:"text/csv;charset=utf-8;"}),a=URL.createObjectURL(n),o=document.createElement("a");o.style.visibility="hidden",o.setAttribute("href",a),o.setAttribute("download",e),document.body.appendChild(o),o.click(),document.body.removeChild(o)}(d.file.timestamp.toFixed()+".csv",w())}}]),angular.module("atl").controller("AtlStreamController",["$rootScope","$scope","$q","$state","$stateParams","$interval","$window","TdDialog","Authentication","Atl","AtlStream","TdAdvert","AtlConnectionStatus",function(e,t,n,a,o,i,m,f,p,g,v,h,w){var y=this,b=null,x=!1,C=12,S=.5,$=.2,D=10,A=1/D*1e3,I=C/A*1e3,k=S/A*1e3,U=$/A*1e3,T=0,L=0,q=null;y.authentication=p,y.loadingDevice=!1,y.loadingSamples=!1,y.sample=null,y.samples=[],y.chartConfig={options:{chart:{zoomType:"x",animation:!1},exporting:{enabled:!1},plotOptions:{series:{borderWidth:0,animation:!1,marker:{enabled:!1}}}},credits:{enabled:!1},legend:{width:300,itemWidth:150,itemStyle:{width:150}},title:{text:""},xAxis:{type:"datetime",title:{text:"Date"}},yAxis:[{labels:{style:{color:Highcharts.getOptions().colors[0]}},title:{style:{color:Highcharts.getOptions().colors[0]}}},{title:{style:{color:Highcharts.getOptions().colors[1]}},labels:{style:{color:Highcharts.getOptions().colors[1]}},opposite:!0}],series:[{type:"line",yAxis:0,data:Y(),tooltip:{valueSuffix:""}},{type:"line",yAxis:1,data:Y(),tooltip:{valueSuffix:""}}],func:function(e){b=e}};var O=e.$on("$stateChangeStart",(function(e,t,n,a,o,i){if(!0===x)return;x=!0,e.preventDefault(),_(t.name)}));function P(e){var t="Do not leave this page during connection, please navigate back first to disconnect first.";return e.returnValue=t,t}function V(e){}t.$on("$destroy",(function(){O(),h.removeListener("advert",E),w.removeListener("status",H),v.removeListener("sample",F),v.removeListener("state",N),m.removeEventListener("beforeunload",P),m.removeEventListener("unload",V),q&&(clearInterval(q),q=null),b=null})),m.addEventListener("beforeunload",P),m.addEventListener("unload",V);var M={sensorAccelX:{title:"Accel-X",units:[new r]},sensorAccelY:{title:"Accel-Y",units:[new r]},sensorAccelZ:{title:"Accel-Z",units:[new r]},sensorGyroX:{title:"Gyro-X",units:[new s]},sensorGyroY:{title:"Gyro-Y",units:[new s]},sensorGyroZ:{title:"Gyro-Z",units:[new s]},temperature:{title:"Temperature",units:[new c]},batteryVoltage:{title:"Battery Voltage",units:[new u]},remoteRssi:{title:"RSSI - Remote",units:[new l]},localRssi:{title:"RSSI - Local",units:[new l]},packetCounter:{title:"Packet Counter",units:[new d]}};function W(e){var t=y.channels[e].selectedChannel,n=M[t];y.channels[e].availableUnits=n.units.filter((function(e,t){return!n.allowedUnits||-1!==n.allowedUnits().indexOf(t)})).map((function(e,t){return{name:e.Unit,value:t.toString()}}));var a=0;n.defaultUnit&&(a=n.defaultUnit()),y.channels[e].selectedUnit=y.channels[e].availableUnits[a],B(e)}function R(e){B(e)}function B(e){var t=function(e){const t=y.channels[e];var n=M[t.selectedChannel],a=n.units[parseInt(t.selectedUnit.value)];return{def:n,unit:a,unit:a}}(e);b.yAxis[e].update(function(e,t,n){return{labels:{format:"{value:."+t.ValueDecimals+"f}",style:{color:Highcharts.getOptions().colors[n]}},title:{text:e.title+(t.Unit?" ("+t.Unit+")":""),style:{color:Highcharts.getOptions().colors[n]}},startOnTick:!0,endOnTick:!0}}(t.def,t.unit,e));var n=function(e,t){if(e.minmax)return{min:e.minmax.min,max:e.minmax.max};var n=t.minmax(y.config.primary);if(n)return{min:n.min,max:n.max};return{min:void 0,max:void 0}}(t.def,t.unit);b.yAxis[e].setExtremes(n.min,n.max),b.series[e].update(function(e,t,n){return{name:e.title+(t.Unit?" ("+t.Unit+")":""),type:"line",yAxis:n,data:j(n,y.config.primary),tooltip:{valueSuffix:t.Unit?" ("+t.Unit+")":"",valueDecimals:t.DetailedValueDecimals}}}(t.def,t.unit,e))}function E(e,t){e===y.atl.uuid&&console.log(t)}function H(e,t){e===y.atl.uuid&&console.log(e,t)}function F(e,t){e===y.atl.uuid&&t&&(null===y.sample&&(y.sample=t,y.loadingSamples=!1),++T>=k&&(T=0,y.sample=t),b&&function(e){if(!b)return;var t=Date.now();y.samples.unshift({timestamp:t,sample:e});for(;y.samples.length>I;)y.samples.pop();z(0,t,e,y.config.primary),z(1,t,e,y.config.primary),++L>U&&(b.xAxis[0].setExtremes(t-I*A,t),b.redraw())}(t))}function N(e,t,n){e===y.atl.uuid&&("stopped"===t?(n&&(console.log(n),f.error("Data Stream",void 0,n)),_("core.devices.atl.start")):console.log("unhandled stream state: "+t))}function _(e){a.go("core.devices.atl.connecting",{atlId:y.atl.uuid,request:"stop-stream",next:e})}function z(e,t,n,a){b.series[e].addPoint(G(e,t,n,a),!1,!0,!1)}function G(e,t,n,a){var o=y.channels[e].selectedChannel,i=parseInt(y.channels[e].selectedUnit.value);return[t,M[o].units[i].convert(n[o],a)]}function j(e,t){for(var n=[],a=(new Date).getTime(),o=I-1;o>=0;o--){var i=a+-o*A,r=null;y.samples&&y.samples[o]&&y.samples[o].timestamp&&y.samples[o].sample&&(i=parseInt(y.samples[o].timestamp),r=y.samples[o].sample),r?n.push(G(e,i,r,t)):n.push([i,0])}return n}function Y(){var e,t=[],n=(new Date).getTime();for(e=-I;e<=0;e++)t.push({x:n+e*A,y:0});return t}y.channels=[{selectedChannel:"sensorAccelX",channelChanged:function(){W(0)},selectedUnit:{value:"0",name:"pF"},availableUnits:[{value:"0",name:"pF"}],unitChanged:function(){R(0)},style:{color:Highcharts.getOptions().colors[0]}},{selectedChannel:"sensorAccelY",channelChanged:function(){W(1)},selectedUnit:{value:"0",name:"°C"},availableUnits:[{value:"0",name:"°C"}],unitChanged:function(){R(1)},style:{color:Highcharts.getOptions().colors[1]}}],y.get=function(){y.loadingSamples=!0,function(){y.loadingDevice=!0;var e=o.atlId;return g.get({atlId:e}).$promise.then((function(t){return y.atl=t,y.advert=t.advertisement,y.config=t.config,v.load(e)})).then((function(e){D=e.options.freq,I=C/(A=1/D*1e3)*1e3,k=S/A*1e3,U=$/A*1e3,T=0,L=0,y.loadingDevice=!1})).catch((function(e){throw y.loadingDevice=!1,f.error("ATL",errorResponse,"Cannot load data from the data base."),errorResponse}))}().then((function(){h.on("advert",E),w.on("status",H),v.on("sample",F),v.on("state",N),q=setInterval((function(){v.ping(y.atl.uuid).then((function(){console.log("ping")})).catch((function(e){console.log("ping error"+e)}))}),5e3),W(0),W(1)}),(function(e){f.error("ATL",e,"Canot load device.")}))}}]),angular.module("atl").controller("AtlController",["$rootScope","$scope","Authentication",function(e,t,n){t.authentication=n,e.section="devices.atl"}]),angular.module("atl").controller("AtlStatisticsController",["$scope","Authentication","$q","$stateParams","TdDialog","TdAdvert","AtlSample","Atl","AtlConnectionStatus","StateHelper","$window","$interval",function(e,t,n,a,o,i,r,s,m,f,p,g){var v=this,h=200,w=[],y=null,b=0,x=null,C=null,S=null,$={temperature:{title:"Temperature",units:[new c]},batteryVoltage:{title:"Battery Voltage",units:[new u]},rssi:{title:"RSSI",units:[new l]},restartsUnknown:{title:"Unknown Restarts",units:[new d]},restartsSoftware:{title:"Software Restarts",units:[new d]},restartsWatchdog:{title:"Watchdog Restarts",units:[new d]},configNumber:{title:"Configuration Number",units:[new d]},packetCounter:{title:"Packet Counter",units:[new d]}};function D(e,t){e===v.atl.uuid&&(v.atl||(v.atl={}),v.atl.connection||(v.atl.connection={}),v.atl.connection.status=t)}function A(e,t){e===v.atl.uuid&&(v.atl||(v.atl={}),v.atl.advertisement=t)}function I(e,t){if(e===v.atl.uuid){var n,a=y;if(y=t,!0!==v.loadingSamples)if(!a||a.packetCounter!==t.packetCounter)if(!(t.timestamp<new Date(2010,1,1,1,0,0,0).getTime()))v.sample=t,b+=1,T(t),V(0,n=t),V(1,n)}}function k(){return v.loadingSamples=!0,C.showLoading("Loading..."),(e=b,t=h,r.query({uuid:v.atl.uuid,skip:e,limit:t})).then((function(e){return v.loadingSamples=!1,C.hideLoading(),e.samplesList&&(b+=e.samplesList.length),e.samplesList}),(function(e){throw v.loadingSamples=!1,C.hideLoading(),o.error("Load Samples",e,"Cannot load samples."),e}));var e,t}function U(){P(0),P(1)}function T(e){e&&w.push(e)}function L(e){e&&w.unshift(e)}function q(e){var t=v.channels[e].selectedChannel,n=$[t];v.channels[e].availableUnits=n.units.filter((function(e,t){return!n.allowedUnits||-1!==n.allowedUnits().indexOf(t)})).map((function(e,t){return{name:e.Unit,value:t.toString()}}));var a=0;n.defaultUnit&&(a=n.defaultUnit()),v.channels[e].selectedUnit=v.channels[e].availableUnits[a],P(e)}function O(e){P(e)}function P(e){var t=v.channels[e].selectedChannel,n=parseInt(v.channels[e].selectedUnit.value),a=$[t],o=a.title,i=a.units[n],r=i.Unit,s=i.ValueDecimals,l=i.DetailedValueDecimals;C.yAxis[e].update({labels:{format:"{value:."+s+"f}",style:{color:Highcharts.getOptions().colors[e]}},title:{text:o+(r?" ("+r+")":""),style:{color:Highcharts.getOptions().colors[e]}}}),C.series[e].update({name:o+(r?" ("+r+")":""),type:"line",yAxis:e,data:w.map((function(e){return[e.timestamp,i.convert(e[t],e)]})),tooltip:{valueSuffix:r?" ("+r+")":"",valueDecimals:l}})}function V(e,t){var n=v.channels[e].selectedChannel,a=parseInt(v.channels[e].selectedUnit.value),o=$[n].units[a];C.series[e].addPoint([t.timestamp,o.convert(t[n],t)])}e.$on("$destroy",(function(){i.removeListener("advert",A),r.removeListener("sample",I),m.removeListener("status",D),x&&(g.cancel(x),x=null),S&&S()})),v.authentication=t,v.loadingDevice=!1,v.loadingSamples=!1,v.atl,v.sample,v.config,v.canvasStyle={height:"80px"},v.channels=[{selectedChannel:"temperature",channelChanged:function(){q(0)},selectedUnit:{value:"0",name:"°C"},availableUnits:[{value:"0",name:"°C"}],unitChanged:function(){O(0)},style:{color:Highcharts.getOptions().colors[0]}},{selectedChannel:"batteryVoltage",channelChanged:function(){q(1)},selectedUnit:{value:"0",name:"V"},availableUnits:[{value:"0",name:"V"}],unitChanged:function(){O(1)},style:{color:Highcharts.getOptions().colors[1]}}],v.get=function(){(v.loadingDevice=!0,s.get({atlId:a.atlId}).$promise.then((function(e){v.atl=e,v.config=e.config,v.loadingDevice=!1}),(function(e){throw v.loadingDevice=!1,o.error("ATL",e,"Cannot find device in the data base."),e}))).then((function(){var e,t,n;return C=new Highcharts.Chart({plotOptions:{series:{borderWidth:0,animation:!1,states:{hover:{enabled:!1}},marker:{enabled:!1}}},chart:{zoomType:"x",renderTo:"chart",animation:!1},legend:{width:300,itemWidth:150,itemStyle:{width:150}},credits:{enabled:!1},title:{text:""},xAxis:{title:{text:"Date"},type:"datetime"},yAxis:[{labels:{format:"{value} V",style:{color:Highcharts.getOptions().colors[0]}},title:{text:"Battery Voltage",style:{color:Highcharts.getOptions().colors[0]}}},{title:{text:"Temperature",style:{color:Highcharts.getOptions().colors[1]}},labels:{format:"{value} °C",style:{color:Highcharts.getOptions().colors[1]}},opposite:!0}],series:[{name:"Battery Voltage",type:"line",yAxis:0,data:[],tooltip:{valueSuffix:" V"}},{name:"Temperature",type:"line",yAxis:1,data:[],tooltip:{valueSuffix:" °C"}}]}),e=angular.element("#chart"),t=0,n=setInterval((function(){e.width()!==t&&(t=e.width(),C.setSize(t,C.height))}),500),S=function(){clearInterval(n)},k()})).then((function(e){y=e[0],v.sample=y,q(0),function(e){for(var t=e.length-1;t>=0;t--)T(e[t])}(e),U(),i.on("advert",A),r.on("sample",I),m.on("status",D)}))},v.loadMore=function(){k().then((function(e){!function(e){for(var t=0;t<e.length;t++)L(e[t])}(e),U()}))}}]),angular.module("atl").controller("AtlIndividualController",["$scope","$state","Atl","AtlConnectionStatus","TdDialog","TdAdvert","AtlSocket","AtlStream",function(e,t,n,a,o,i,r,s){var l=this;e.$on("$destroy",(function(){l.selected[0]?sessionStorage.setItem("atl.individual.selected",l.selected[0].uuid):sessionStorage.setItem("atl.individual.selected",void 0),sessionStorage.setItem("atl.individual.query",JSON.stringify(l.query)),i.removeListener("advert",p),a.removeListener("status",f),r.removeListener("app:atl:config-state",g)})),l.isLoading=!1,l.selected=[],l.section="devices";var c=sessionStorage.getItem("atl.individual.query"),u=sessionStorage.getItem("atl.individual.selected");l.query=c?JSON.parse(c):{order:"uuid",limit:10,page:1};function d(e){var t={count:0,devices:[]};return function(e,t){return n.query(e).$promise.then((function(e){!function(e,t){t.count+=e.count,e.devices.forEach((function(e){t.devices.push(e)}))}(e,t)}))}(e,t).then((function(){return t})).catch((function(e){throw o.error("ATL",e,"Cannot load devices."),e}))}function m(e){return _.find(l.atls.devices,(function(t){return e===t.uuid}))}function f(e,t){var n=m(e);n&&_.set(n,"connection.status",t)}function p(e,t){var n=m(e);n&&_.set(n,"advertisement",t)}function g(e,t,n){if("upload"===t||"download"===t){var a=m(e);a&&(_.set(a,"config.timestamp",n.timestamp),_.set(a,"config.primary",n.primary))}}l.get=function(){l.isLoading=!0,d({order:l.query.order,skip:(l.query.page-1)*l.query.limit,limit:l.query.limit}).then((function(e){l.atls=e,u&&l.atls.devices.forEach((function(e){e.uuid===u&&(l.selected[0]=e)})),a.on("status",f),i.on("advert",p),r.on("app:atl:config-state",g),l.isLoading=!1})).catch((function(e){l.isLoading=!1}))},l.stream=function(){if(l.selected[0]){l.isLoading=!0;var e=l.selected[0].uuid;s.request(e,50).then((function(){l.isLoading=!1,t.go("core.devices.atl.connecting",{atlId:l.selected[0].uuid,request:"start-stream"})}),(function(e){l.isLoading=!1,o.error("ATL Error",e,"Cannot start data stream.")}))}},l.statistics=function(){l.selected[0]&&t.go("core.devices.atl.stats",{atlId:l.selected[0].uuid})},l.editSleep=function(){l.selected[0]&&t.go("core.devices.atl.edit-sleep",{atlId:l.selected[0].uuid})},l.edit=function(){l.selected[0]&&t.go("core.devices.atl.edit",{atlId:l.selected[0].uuid})}}]),angular.module("atl").controller("AtlEditSleepController",["$scope","Authentication","$stateParams","TdDialog","Atl","StateHelper","$mdToast","AtlConfig","$q",function(e,t,n,a,o,i,r,s,l){var c=this,u=null;function d(e){e=1e3*parseInt(e,10),c.advertWindows=c.availableAdvertWindows.filter((function(t){var n=parseInt(t.value,10);return e>n}));var t=parseInt(c.config.primary.advertWindow,10);0===c.advertWindows.filter((function(e){return parseInt(e.value,10)===t})).length&&(c.config.primary.advertWindow=c.advertWindows[0].value)}function m(e){r.show(r.simple().position("bottom right").textContent(e).hideDelay(3e3))}c.authentication=t,c.loading=!1,c.fault=!1,c.atl,c.advertIntervals=[{value:"5",text:"5 seconds"},{value:"10",text:"10 seconds"},{value:"20",text:"20 seconds"},{value:"30",text:"30 seconds"},{value:"60",text:"1 minute"},{value:"120",text:"2 minutes"},{value:"300",text:"5 minutes"},{value:"600",text:"10 minutes"},{value:"1200",text:"20 minutes"},{value:"1800",text:"30 minutes"},{value:"3600",text:"1 hour"}],c.availableAdvertWindows=[{value:"1000",text:"1 second"},{value:"2000",text:"2 seconds"},{value:"3000",text:"3 seconds"},{value:"5000",text:"5 seconds"},{value:"8000",text:"8 seconds"},{value:"10000",text:"10 seconds"},{value:"20000",text:"20 seconds"},{value:"30000",text:"30 seconds"},{value:"40000",text:"40 seconds"},{value:"50000",text:"50 seconds"},{value:"60000",text:"1 minute"}],c.advertWindows=c.availableAdvertWindows,c.get=function(){var t,a;c.loading=!0,(a=n.atlId,o.get({atlId:a}).$promise.catch((function(e){throw"Cannot load device."}))).then((function(e){return function(e){return s.get(e).catch((function(e){throw"Cannot load configuration."}))}(t=e)})).then((function(n){return function(t,n){if(!t||!n)throw"Invalid data.";c.atl=t,c.config=n,u=_.cloneDeep(n),e.$watch(angular.bind(c,(function(){return this.config.primary.advertInterval})),d)}(t,n)})).then((function(){c.loading=!1})).catch((function(e){c.loading=!1,c.fault=!0,m(e)}))},c.submit=function(e){if(c.atl){var t=_.cloneDeep(c.config);t.primary.advertInterval=parseInt(c.config.primary.advertInterval,10),t.primary.advertWindow=parseInt(c.config.primary.advertWindow,10),angular.equals(t,u)?i.back("core.devices.atl.start"):(c.loading=!0,function(e,t){return s.upload(e,t).catch((function(e){throw"Cannot add configuration upload task."}))}(c.atl,t).then((function(){c.loading=!1,m("The configuration has been successfully updated, it will be uploaded to the device during next connection."),i.back("core.devices.atl.start")})).catch((function(e){c.loading=!1,m(e)})))}}}]),angular.module("atl").controller("AtlConnectingController",["Authentication","$rootScope","$scope","$q","$stateParams","$state","$window","TdDialog","$mdToast","StateHelper","TdAdvert","Atl","AtlStream","AtlConnectionStatus",function(e,t,n,a,o,i,r,s,l,c,u,d,m,f){var p=this,g=!1,v={advert:"Waiting for advertisement...",connecting:"Connecting...",configuring:"Configuring...",disconnecting:"Disconnecting...",disconnected:"Disconnected",canceling:"Cancelling..."},h=t.$on("$stateChangeStart",(function(e,t,n,a,o,i){if(g)return;console.log("unexpected state change"),e.preventDefault(),p.canCancel?(console.log("can cancel"),C()):(console.log("cannot cancel"),S("error","Cannot cancel request."))}));function w(e){console.log("on before unload");return e.returnValue="Operation in progress, please don't unload the window","Operation in progress, please don't unload the window"}function y(e){}n.$on("$destroy",(function(){u.removeListener("advert",I),f.removeListener("status",k),r.removeEventListener("beforeunload",w),r.removeEventListener("unload",y),h()})),r.addEventListener("beforeunload",w),r.addEventListener("unload",y);var b=null;function x(){switch(-1!==b.request.indexOf("start")?p.message=v.advert:-1!==b.request.indexOf("stop")&&(p.message=v.disconnecting),b.request){case"start-stream":(console.log("wait stream"),a((function(e,t){var n=function(n){m.removeListener("state",o),clearInterval(a),n?(S("error",error),t(n)):e()},a=setInterval((function(){m.ping(p.atl.uuid).then((function(){console.log("ping con")})).catch((function(e){n(e)}))}),5e3),o=function(e,t,a){console.log("state",e,t,a),p.atl.uuid===e&&("started"===t?n():"error"===t&&n("Cannot start data stream."))};m.on("state",o)}))).then((function(){A("core.devices.atl.stream",{atlId:p.atl.uuid})}),(function(){D()}));break;case"stop-stream":$().then((function(){D()}),(function(){D()}))}}function C(){switch(p.message=v.canceling,b.request){case"start-stream":$().then((function(){D()}),(function(){D()}))}}function S(e,t){l.show(l.simple().position("bottom right").textContent(t).hideDelay(3e3))}function $(){return a((function(e,t){m.cancelRequest(p.atl).then((function(){e()}),(function(e){s.error("ATL Error",e,"Cannot stop data stream."),t()}))}))}function D(){b.next&&"core.devices.atl.connecting"!==b.next?A(b.next):A("core.devices.atl.start")}function A(e,t){g=!0,i.go(e,t)}function I(e,t){e===p.atl.uuid&&console.log(t)}function k(e,t){if(e===p.atl.uuid){switch(t.label){case"Connecting...":p.message=v.connecting,p.canCancel=!1;break;case"Connected":p.message=v.configuring,p.canCancel=!1;break;case"Failure":p.message=v.advert,p.canCancel=!0;break;case"Disconnecting...":p.message=v.disconnecting,p.canCancel=!1;break;case"Disconnected":p.message=v.disconnected,p.canCancel=!0}console.log(e,t)}}p.authentication=e,p.loading=!1,p.canCancel=!0,p.atl=null,p.title="Connecting...",p.message="",p.get=function(){p.loading=!0,b={atlId:o.atlId,request:o.request,next:o.next},d.get({atlId:o.atlId}).$promise.then((function(e){p.atl=e})).then((function(){p.title="Connecting to "+p.atl.uuid,u.on("advert",I),f.on("status",k),p.loading=!1,x()}),(function(e){s.error("ATL Error",e,"Cannot find ATL device in the data base."),p.loading=!1}))},p.cancel=function(){C()}}]),angular.module("atl").controller("AtlEditController",["Authentication","$stateParams","TdDialog","Atl","StateHelper","$mdToast","AtlConfig",function(e,t,n,a,o,i,r){var s,l=this,c=!1;function u(e){i.show(i.simple().position("bottom right").textContent(e).hideDelay(3e3))}l.authentication=e,l.loading=!1,l.fault=!1,l.atl,l.config,l.samplingRateOptions=[12.5,26,52,104,208,416,833,1666,3332,6664],l.accelerationRangeOptions=[2,4,8,16],l.angularRateRangeOptions=[125,250,500,1e3,2e3],l.get=function(){var e,n;l.loading=!0,(n=t.atlId,a.get({atlId:n}).$promise.catch((function(e){throw"Cannot find device in the data base."}))).then((function(t){return function(e){return r.get(e).catch((function(e){throw"Cannot load configuration."}))}(e=t)})).then((function(t){return function(e,t){if(!e||!t)throw"Invalid data.";l.atl=e,l.config=t,c=e.enabled,s=_.cloneDeep(t)}(e,t)})).then((function(){l.loading=!1})).catch((function(e){l.loading=!1,l.fault=!0,u(e)}))},l.submit=function(e){if(l.atl){"string"==typeof l.atl.enabled&&(l.atl.enabled="true"===l.atl.enabled),c!==l.atl.enabled&&(!0===l.atl.enabled?l.atl.connection.status.label="N/A":l.atl.connection.status.label="Disabled");var t,n=_.cloneDeep(l.config),a=!angular.equals(n,s);if(l.config.primary.checkInterval<=l.config.primary.measNumberOfSamples/l.config.primary.measSamplingRate+l.config.primary.checkNumberOfSamples/l.config.primary.checkSamplingRate+1)u("Invalid check interval");else if(function(){const e=l.config.primary.wakeupTime;let t=0;for(let n=7;n<32;n+=8)if(e&1<<n){(e>>n-7&31)<24&&t++}return t>0}())l.loading=!0,(t=l.atl,t.$update().catch((function(e){throw"Cannot save device."}))).then((function(){if(a)return function(e,t){return r.upload(e,t).catch((function(e){throw"Cannot add configuration upload task."}))}(l.atl,n).then((function(){u("The configuration has been successfully updated, it will be uploaded to the device during next connection.")}));u("The device has been successfully updated.")})).then((function(){l.loading=!1,o.back("core.devices.atl.start")})).catch((function(e){l.loading=!1,u(e)}));else u("Invalid wake-up time")}},l.download=function(){var e;l.atl&&(l.loading=!0,(e=l.atl,r.download(e).catch((function(e){throw"Cannot add configuration download task."}))).then((function(){l.loading=!1,u("The configuration will be downloaded from the device during next connection."),o.back("core.devices.atl.start")})).catch((function(e){l.loading=!1,u(e)})))}}]),angular.module("atl").factory("AtlConfig",["Task",function(e){return{upload:function(t,n){var a=t.uuid;return new e({uuid:a,command:"upload",mode:"Individual",options:n}).$save()},download:function(t){var n=t.uuid;return function(t){return e.query({uuid:t,command:"download",order:"-createdOn",limit:1,skip:0}).$promise}(n).then((function(t){return t.tasks.length?t.tasks[0]:new e({uuid:n,command:"download",mode:"Individual"}).$save()}))},get:function(t){return(n=t.uuid,e.query({uuid:n,command:"upload",order:"-createdOn",limit:1,skip:0}).$promise).then((function(e){var n=e.tasks,a=n.length?n[0].options:t.config;return _.cloneDeep(a)}));var n}}}]),goog.require("proto.AtlSample.Data"),goog.require("proto.AtlSample.DataArray"),angular.module("atl").factory("AtlSample",["$q","$resource","TdSocket","TdDialog",function(e,t,n,a){var o={sample:null},i=t("api/atl-sample",null,{get:{responseType:"arraybuffer",transformResponse:function(e,t){return{data:e}}}});return n.on("app:atl:sample",(function(e,t){if(o.sample){var n=proto.AtlSample.Data.deserializeBinary(new Uint8Array(t));o.sample(e,n.toObject())}})),{query:function(t){return e((function(e,n){t.proto="protobuf",i.get(t).$promise.then((function(t){var n=proto.AtlSample.DataArray.deserializeBinary(new Uint8Array(t.data));e(n.toObject())}),(function(e){n(e)}))}))},on:function(e,t){"sample"===e&&(o.sample=t)},removeListener:function(e,t){"sample"===e&&(o.sample=null)}}}]),goog.provide("proto.AtlFile.File"),angular.module("atl").factory("AtlFile",["$q","$resource",function(e,t){var n=t("api/fs/:lvl1/:lvl2/:lvl3/:lvl4/:lvl5/:lvl6",null,{get:{responseType:"arraybuffer",transformResponse:function(e,t){return{data:e}}}});return{get:function(t){return e((function(e,a){n.get(t).$promise.then((function(t){e(proto.AtlFile.File.deserializeBinary(new Uint8Array(t.data)).toObject())}),(function(e){a(e)}))}))}}}]),angular.module("atl").factory("AtlSocket",["socketFactory",function(e){var t=io.connect();return t.on("connect",(function(){t.emit("name","www")})),e({prefix:"app:atl:",ioSocket:t})}]),angular.module("atl").factory("AtlConnectionStatus",["$q","AtlSocket",function(e,t){var n={status:null};return t.on("app:atl:status",(function(e,t){console.log("status",e,t),n.status&&n.status(e,t)})),{on:function(e,t){"status"===e&&(n.status=t)},removeListener:function(e,t){"status"===e&&(n.status=null)}}}]),angular.module("atl").factory("Atl",["$resource",function(e){return e("api/atl/:atlId",{atlId:"@uuid"},{update:{method:"PUT"},query:{method:"GET",isArray:!1}})}]),angular.module("atl").factory("AtlSamples",["$resource",function(e){return e("api/atl/samples/:atlDeviceId",{atlDeviceId:"@uuid"},{update:{method:"PUT"}})}]),angular.module("atl").factory("AtlStream",["$q","AtlSocket","Task",function(e,t,n){var a={sample:null,state:null};return t.on("app:atl:stream-sample",(function(e,t){a.sample&&a.sample(e,t)})),t.on("app:atl:stream-state",(function(e,t,n){a.state&&a.state(e,t,n)})),{load:function(e){return o(e,1).then((function(e){return 0===e.tasks.length?null:e.tasks[0]}))},request:function(e,t){return o(e,1).then((function(a){if(a.tasks.length){var o=a.tasks[0];return new n(o).$update()}return new n({uuid:e,createdOn:Date.now(),command:"stream",mode:"Individual",options:{freq:t}}).$save()}))},ping:function(e){return o(e,1).then((function(e){if(e.tasks.length){var t=e.tasks[0];return new n(t).$update()}}))},cancelRequest:function(t){return o(t.uuid).then((function(t){var a=t.tasks.map((function(e){return new n(e).$remove()}));return e.all(a)}))},on:function(e,t){"sample"===e?a.sample=t:"state"===e&&(a.state=t)},removeListener:function(e,t){"sample"===e?a.sample=null:"state"===e&&(a.state=null)}};function o(e,t){var a={uuid:e,command:"stream",order:"-createdOn",skip:0};return t&&(a.limit=t),n.query(a).$promise}}]),angular.module("sop").directive("configurationGeneral",(function(){return{templateUrl:"modules/sop/views/sop-edit.client.view.html"}})),angular.module("sop").directive("configurationTime",(function(){return{templateUrl:"modules/sop/views/sop-edit-sleep.client.view.html"}})),angular.module("sop").directive("configurationCapacity",(function(){return{templateUrl:"modules/sop/views/sop-calibration.client.view.html"}})),angular.module("sop").directive("configurationLogging",(function(){return{templateUrl:"modules/sop/views/sop-logging.client.view.html"}})),angular.module("sop").config(["$stateProvider",function(e){e.state("core.devices.sop",{abstract:!0,url:"/sop",templateUrl:"modules/sop/views/sop-content.client.view.html"}).state("core.devices.sop.start",{url:"/",templateUrl:"modules/sop/views/sop-individual.client.view.html"}).state("core.devices.sop.stats",{url:"/statistics/:sopId",templateUrl:"modules/sop/views/sop-statistics.client.view.html"}).state("core.devices.sop.connecting",{url:"/connecting/:sopId/:request/:next",templateUrl:"modules/sop/views/sop-connecting.client.view.html"}).state("core.devices.sop.stream",{url:"/stream/:sopId",templateUrl:"modules/sop/views/sop-stream.client.view.html"}).state("core.devices.sop.log-view",{url:"/log-view/:path",templateUrl:"modules/sop/views/sop-data-viewer.client.view.html"}).state("core.devices.sop.configuration",{url:"/configuration/:sopId",templateUrl:"modules/sop/views/sop-configuration.client.view.html"})}]),angular.module("sop").controller("SopDataViewerController",["$scope","Authentication","$q","$stateParams","TdDialog","SopFile","$interval",function(e,t,n,a,o,i,r){var s=3,l=.1,c=6400,u=this,d=null,m=null,f=null;function p(){return n((function(e,t){u.progress={type:"indeterminate",value:void 0,disabled:!1},i.get(function(){var e,t={},n=a.path.split("/");for(e=0;e<n.length;++e)t["lvl"+(e+1)]=n[e];return t}()).then((function(t){u.progress.disabled=!0,e(t)}),(function(e){u.progress.disabled=!0,o.error("Smart-Oil Plug",e,"Cannot find data file."),t(e)}))}))}function g(){for(var e=u.file,t=function(e){for(var t,n=0,a=0;a<s;a++)(t=e.acceleration.samplesList[a].valuesList.length)>n&&(n=t);return n}(e),n="Time [s],ACC-X [g],ACC-Y [g],ACC-Z [g]\n",a=0,o=0;o<t;o++){n+=a.toFixed(8)+",";for(var i=0;i<s;i++){n+=(v(e.acceleration,i,o)*l).toFixed(4)+","}n+="\n",a+=1/c}return n}function v(e,t,n){var a=e.samplesList;if(t>a.length)return 0;var o=a[t].valuesList;return n>o.length?0:o[n]}u.authentication=t,u.file=null,u.progress={type:"determinate",value:100,disabled:!0},u.canvasStyle={height:"80px"},u.samplingRate=c,e.$on("$destroy",(function(){d&&(r.cancel(d),d=null),m&&(r.cancel(m),m=null)})),u.get=function(){var e,t,n,a,o,i,d;e="chartAcc",t="Acceleration",n="g",a=-16,o=16,i=[{name:"X",type:"line",data:[],tooltip:{valueSuffix:" g"}},{name:"Y",type:"line",data:[],tooltip:{valueSuffix:" g"}},{name:"Z",type:"line",data:[],tooltip:{valueSuffix:" g"}}],d=1/c,(f=new Highcharts.Chart({plotOptions:{series:{borderWidth:0,animation:!1,states:{hover:{enabled:!1}},marker:{enabled:!1},pointStart:0,pointInterval:d}},chart:{zoomType:"xy",renderTo:e,animation:!1},tooltip:{useHTML:!0,shared:!0,formatter:function(){var e="";return e+='<span style="font-size: 10px">'+Highcharts.numberFormat(this.points[0].x,3)+" s</span><br/>",angular.forEach(this.points,(function(t){e+='<span style="color:'+t.color+'">●</span> '+t.series.name+": <b>"+t.y.toFixed(3)+" "+n+"</b><br/>"})),e}},legend:{width:300,itemWidth:100,itemStyle:{width:100}},credits:{enabled:!1},title:{text:t},xAxis:{title:{text:"Time [s]"}},yAxis:[{min:a,max:o,startOnTick:!0,endOnTick:!0,labels:{format:"{value} "+n},title:{text:t+" ["+n+"]"}}],series:i})).showLoading("Loading..."),p().then((function(e){console.log(e),u.file=e;for(var t=0;t<s;t++)f.series[t].setData(e.acceleration.samplesList[t].valuesList.map((function(e){return e*l})));var n,a;f.hideLoading(),n=angular.element("#chartAcc"),a=0,m=r((function(){n.width()!==a&&(a=n.width(),f.setSize(a,f.height))}),500)}))},u.downloadCSV=function(){!function(e,t){var n=new Blob([t],{type:"text/csv;charset=utf-8;"}),a=URL.createObjectURL(n),o=document.createElement("a");o.style.visibility="hidden",o.setAttribute("href",a),o.setAttribute("download",e),document.body.appendChild(o),o.click(),document.body.removeChild(o)}(u.file.timestamp.toFixed()+".csv",g())}}]),angular.module("sop").controller("SopController",["$rootScope","$scope","Authentication",function(e,t,n){t.authentication=n,e.section="devices.sop"}]),angular.module("sop").controller("SopCalibrationController",["$scope","Authentication","$stateParams","TdDialog","Sop","StateHelper","$mdToast","SopConfig","$mdDialog",function(e,t,n,a,o,i,r,s,l){var c,u=this;function d(e){r.show(r.simple().position("bottom right").textContent(e).hideDelay(3e3))}function m(t){e.$emit("loadingSignal",t)}u.authentication=t,u.loading=!1,u.fault=!1,u.sop,u.config,u.cal={capDacA:0,capDacB:0,capOffset:0,capGain:0,capCtrl:0},u.get=function(){m(!0),u.loading=!0,o.get({sopId:n.sopId}).$promise.then((function(e){return e})).then((function(e){return u.sop=e,function(e){return s.get(e).catch((function(e){throw"Cannot load Smart-Oil Plug configuration."}))}(e)})).then((function(e){u.config=e,c=_.cloneDeep(e),u.cal.capDacA=u.config.primary.capdaca,u.cal.capDacB=u.config.primary.capdacb,u.cal.capOffset=u.config.primary.capOffset,u.cal.capGain=u.config.primary.capGain,u.cal.capCtrl=u.config.primary.capCtrl,m(!1),u.loading=!1})).catch((function(e){m(!1),u.loading=!1,u.fault=!0,d(e)}))},u.submit=function(e){if(u.sop)try{u.config.primary.capdaca=parseInt(u.cal.capDacA),u.config.primary.capdacb=parseInt(u.cal.capDacB),u.config.primary.capOffset=parseInt(u.cal.capOffset),u.config.primary.capGain=parseInt(u.cal.capGain),u.config.primary.capCtrl=parseInt(u.cal.capCtrl);var t=_.cloneDeep(u.config);if(!!angular.equals(t,c))return void i.back("core.devices.sop.start");var n=l.confirm().parent(angular.element(document.querySelector("body"))).clickOutsideToClose(!1).title("Configuration").textContent("This operation will permanently overwrite the existing calibration. Are you sure you want to proceed?").ok("Okay").cancel("Cancel");l.show(n).then((function(){return m(!0),u.loading=!0,function(e,t){return s.upload(e,t).catch((function(e){throw"Cannot add configuration upload task."}))}(u.sop,t).then((function(){m(!1),u.loading=!1,d("The configuration has been successfully updated, it will be uploaded to the device during next connection."),i.back("core.devices.sop.start")})).catch((function(e){m(!1),u.loading=!1,d(e)}))}),(function(){console.log("canceled")}))}catch(e){d(e)}},u.download=function(){var e;u.sop&&(m(!0),u.loading=!0,(e=u.sop,s.download(e).catch((function(e){throw"Cannot add configuration download task."}))).then((function(){m(!1),u.loading=!1,d("The configuration will be downloaded from the device during next connection."),i.back("core.devices.sop.start")})).catch((function(e){m(!1),u.loading=!1,d(e)})))}}]),angular.module("sop").controller("SopStreamController",["$rootScope","$scope","$q","$state","$stateParams","$interval","$window","TdDialog","Authentication","Sop","SopStream","TdAdvert","SopConnectionStatus",function(e,t,n,a,o,i,s,f,p,g,v,h,w){var y=this,b=null,x=!1,C=600,S=100,$=null;function D(e){var t="PC,Remote RSSI [dBm],Local RSSI [dBm],Temperature [°C],Battery Voltage [V],Capacitance [pF],Temperature [°C],Acc X [g],Acc Y [g],Acc Z [g]\n";e.forEach((function(e){t+=e.packetCounter+","+e.remoteRssi+","+e.localRssi+","+e.temperature+","+e.batteryVoltage+","+e.sensorCapacitance+","+e.sensorTemperature+","+e.sensorAccelX+","+e.sensorAccelY+","+e.sensorAccelZ+"\n"})),function(e,t){var n=new Blob([t],{type:"text/csv;charset=utf-8;"}),a=URL.createObjectURL(n),o=document.createElement("a");o.style.visibility="hidden",o.setAttribute("href",a),o.setAttribute("download",e),document.body.appendChild(o),o.click(),document.body.removeChild(o)}((new Date).getTime().toFixed()+".csv",t)}y.authentication=p,y.loadingDevice=!1,y.loadingSamples=!1,y.sample=null,y.samples=[],y.logToFileInProgress=!1,y.logToFileData=[],y.logToFileIcon="input",y.logToFileTooltip="Log To File",y.toggleLogToFile=function(){!1===y.logToFileInProgress?(y.logToFileInProgress=!0,y.logToFileIcon="get_app",y.logToFileTooltip="Download File",y.logToFileData=[]):(y.logToFileIcon="input",y.logToFileTooltip="Log To File",y.logToFileInProgress=!1,D(y.logToFileData))},y.chartConfig={options:{chart:{zoomType:"y",animation:!1,events:{selection:function(e){!0===e.resetSelection?(O(0),O(1),b.resetZoomButton.hide(),e.preventDefault()):b.resetZoomButton&&b.resetZoomButton.show()}}},exporting:{enabled:!1},plotOptions:{series:{borderWidth:0,animation:!1,marker:{enabled:!1}}}},credits:{enabled:!1},legend:{width:300,itemWidth:150,itemStyle:{width:150}},title:{text:""},xAxis:{type:"datetime",title:{text:"Date"}},yAxis:[{labels:{format:"{value} V",style:{color:Highcharts.getOptions().colors[0]}},title:{text:"Battery Voltage",style:{color:Highcharts.getOptions().colors[0]}}},{title:{text:"Temperature",style:{color:Highcharts.getOptions().colors[1]}},labels:{format:"{value} °C",style:{color:Highcharts.getOptions().colors[1]}},opposite:!0}],series:[{name:"Battery Voltage",type:"line",yAxis:0,data:N(),tooltip:{valueSuffix:" V"}},{name:"Temperature",type:"line",yAxis:1,data:N(),tooltip:{valueSuffix:" °C"}}],func:function(e){b=e}};var A=e.$on("$stateChangeStart",(function(e,t,n,a,o,i){if(!0===x)return;x=!0,e.preventDefault(),B(t.name)}));function I(e){var t="Do not leave this page during connection, please navigate back first to disconnect first.";return e.returnValue=t,t}function k(e){}t.$on("$destroy",(function(){A(),h.removeListener("advert",V),w.removeListener("status",M),v.removeListener("sample",W),v.removeListener("state",R),s.removeEventListener("beforeunload",I),s.removeEventListener("unload",k),$&&(clearInterval($),$=null),b=null})),s.addEventListener("beforeunload",I),s.addEventListener("unload",k);var U={sensorCapacitance:{title:"Capacitance",units:[new m]},sensorTemperature:{title:"Temperature",units:[new c]},sensorAccelX:{title:"Accel-X",units:[new r]},sensorAccelY:{title:"Accel-Y",units:[new r]},sensorAccelZ:{title:"Accel-Z",units:[new r]},temperature:{title:"Internal Temperature",units:[new c]},batteryVoltage:{title:"Battery Voltage",units:[new u]},remoteRssi:{title:"RSSI - Remote",units:[new l]},localRssi:{title:"RSSI - Local",units:[new l]},packetCounter:{title:"Packet Counter",units:[new d]}};function T(e){var t=y.channels[e].selectedChannel,n=U[t];y.channels[e].availableUnits=n.units.filter((function(e,t){return!n.allowedUnits||-1!==n.allowedUnits().indexOf(t)})).map((function(e,t){return{name:e.Unit,value:t.toString()}}));var a=0;n.defaultUnit&&(a=n.defaultUnit()),y.channels[e].selectedUnit=y.channels[e].availableUnits[a],q(e)}function L(e){q(e)}function q(e){O(e);var t=P(e);b.series[e].update(function(e,t,n){return{name:e.title+(t.Unit?" ("+t.Unit+")":""),type:"line",yAxis:n,data:F(n,y.config.primary),tooltip:{valueSuffix:t.Unit?" ("+t.Unit+")":"",valueDecimals:t.DetailedValueDecimals}}}(t.def,t.unit,e))}function O(e){var t=P(e),n=function(e,t){if(e.minmax)return{min:e.minmax.min,max:e.minmax.max};var n=t.minmax(y.config.primary);if(n)return{min:n.min,max:n.max};return{min:void 0,max:void 0}}(t.def,t.unit);b.yAxis[e].update(function(e,t,n){return{labels:{format:"{value:."+t.ValueDecimals+"f}",style:{color:Highcharts.getOptions().colors[n]}},title:{text:e.title+(t.Unit?" ("+t.Unit+")":""),style:{color:Highcharts.getOptions().colors[n]}},startOnTick:!0,endOnTick:!0}}(t.def,t.unit,e)),b.yAxis[e].setExtremes(n.min,n.max),console.log(n.min,n.max)}function P(e){const t=y.channels[e];var n=U[t.selectedChannel],a=n.units[parseInt(t.selectedUnit.value)];return{def:n,unit:a,unit:a}}function V(e,t){e===y.sop.uuid&&console.log(t)}function M(e,t){e===y.sop.uuid&&console.log(e,t)}function W(e,t){e===y.sop.uuid&&t&&(y.sample=t,y.loadingSamples=!1,!0===y.logToFileInProgress&&y.logToFileData.push(t),b&&function(e){if(!b)return;var t=Date.now();y.samples.unshift({timestamp:t,sample:e});for(;y.samples.length>C;)y.samples.pop();E(0,t,e,y.config.primary),E(1,t,e,y.config.primary),b.xAxis[0].setExtremes(t-C*S,t),b.redraw()}(t))}function R(e,t,n){e===y.sop.uuid&&("stopped"===t?(n&&f.error("Data Stream",void 0,n),B("core.devices.wa.start")):console.log("unhandled stream state: "+t))}function B(e){a.go("core.devices.sop.connecting",{sopId:y.sop.uuid,request:"stop-stream",next:e})}function E(e,t,n,a){b.series[e].addPoint(H(e,t,n,a),!1,!0)}function H(e,t,n,a){var o=y.channels[e].selectedChannel,i=parseInt(y.channels[e].selectedUnit.value);return[t,U[o].units[i].convert(n[o],a)]}function F(e,t){for(var n=[],a=(new Date).getTime(),o=C-1;o>=0;o--){var i=a+-o*S,r=null;y.samples&&y.samples[o]&&y.samples[o].timestamp&&y.samples[o].sample&&(i=parseInt(y.samples[o].timestamp),r=y.samples[o].sample),r?n.push(H(e,i,r,t)):n.push([i,0])}return n}function N(){var e,t=[],n=(new Date).getTime();for(e=-C;e<=0;e++)t.push({x:n+e*S,y:0});return t}y.channels=[{selectedChannel:"sensorCapacitance",channelChanged:function(){T(0)},selectedUnit:{value:"0",name:"pF"},availableUnits:[{value:"0",name:"pF"}],unitChanged:function(){L(0)},style:{color:Highcharts.getOptions().colors[0]}},{selectedChannel:"temperature",channelChanged:function(){T(1)},selectedUnit:{value:"0",name:"°C"},availableUnits:[{value:"0",name:"°C"}],unitChanged:function(){L(1)},style:{color:Highcharts.getOptions().colors[1]}}],y.get=function(){y.loadingSamples=!0,(y.loadingDevice=!0,g.get({sopId:o.sopId}).$promise.then((function(e){y.sop=e,y.advert=e.advertisement,y.config=e.config,y.loadingDevice=!1}),(function(e){throw y.loadingDevice=!1,f.error("SOP Error",e,"Cannot find SOP device in the data base."),e}))).then((function(){h.on("advert",V),w.on("status",M),v.on("sample",W),v.on("state",R),$=setInterval((function(){v.request(y.sop.uuid).then((function(){console.log("ping")})).catch((function(e){console.log("ping error: ",e)}))}),5e3),T(0),T(1)}),(function(e){f.error("SOP Error",e,"Canot load SOP.")}))}}]),angular.module("sop").controller("SopIndividualController",["$scope","$state","Sop","SopConnectionStatus","TdDialog","TdAdvert","SopSocket","SopStream",function(e,t,n,a,o,i,r,s){var l=this;e.$on("$destroy",(function(){l.selected[0]?sessionStorage.setItem("sop.individual.selected",l.selected[0].uuid):sessionStorage.setItem("sop.individual.selected",void 0),sessionStorage.setItem("sop.individual.query",JSON.stringify(l.query)),i.removeListener("advert",f),a.removeListener("status",m),r.removeListener("app:sop:config-state",p)})),l.isLoading=!1,l.selected=[],l.section="devices";var c=sessionStorage.getItem("sop.individual.query"),u=sessionStorage.getItem("sop.individual.selected");l.query=c?JSON.parse(c):{order:"uuid",limit:10,page:1};function d(e){return _.find(l.sops.devices,(function(t){return e===t.uuid}))}function m(e,t){var n=d(e);n&&_.set(n,"connection.status",t)}function f(e,t){var n=d(e);n&&_.set(n,"advertisement",t)}function p(e,t,n){if("upload"===t||"download"===t){var a=d(e);a&&(_.set(a,"config.timestamp",n.timestamp),_.set(a,"config.primary",n.primary))}}l.get=function(){l.isLoading=!0,function(e){return n.query(e).$promise.catch((function(e){throw o.error("SOP Request",e,"Cannot load SOP devices."),e}))}({order:l.query.order,skip:(l.query.page-1)*l.query.limit,limit:l.query.limit}).then((function(e){l.sops=e,u&&l.sops.devices.forEach((function(e){e.uuid===u&&(l.selected[0]=e)})),a.on("status",m),i.on("advert",f),r.on("app:sop:config-state",p),l.isLoading=!1})).catch((function(e){l.isLoading=!1}))},l.stream=function(){l.selected[0]&&(l.isLoading=!0,s.request(l.selected[0].uuid).then((function(){l.isLoading=!1,t.go("core.devices.sop.connecting",{sopId:l.selected[0].uuid,request:"start-stream"})}),(function(e){l.isLoading=!1,o.error("SOP Error",e,"Cannot start data stream.")})))},l.statistics=function(){l.selected[0]&&t.go("core.devices.sop.stats",{sopId:l.selected[0].uuid})},l.calibration=function(){l.selected[0]&&t.go("core.devices.sop.calibration",{sopId:l.selected[0].uuid})},l.editSleep=function(){l.selected[0]&&t.go("core.devices.sop.edit-sleep",{sopId:l.selected[0].uuid})},l.edit=function(){l.selected[0]&&t.go("core.devices.sop.edit",{sopId:l.selected[0].uuid})},l.configuration=function(){l.selected[0]&&t.go("core.devices.sop.configuration",{sopId:l.selected[0].uuid})}}]),angular.module("sop").controller("SopStatisticsController",["$scope","Authentication","$q","$stateParams","TdDialog","TdAdvert","SopSample","Sop","SopConnectionStatus","StateHelper","$window",function(e,t,n,a,o,i,s,f,p,g,v){var h=this,w=200,y=[],b=null,x=0,C=null,S=null,$={capacitance:{title:"Capacitance",units:[new m]},temperature:{title:"Temperature",units:[new c]},acceleration:{title:"Acceleration",units:[new r]},rssi:{title:"RSSI",units:[new l]},temperatureInternal:{title:"Internal Temperature",units:[new c]},batteryVoltage:{title:"Battery Voltage",units:[new u]},restartsUnknown:{title:"Unknown Restarts",units:[new d]},restartsSoftware:{title:"Software Restarts",units:[new d]},restartsWatchdog:{title:"Watchdog Restarts",units:[new d]},configNumber:{title:"Configuration Number",units:[new d]},packetCounter:{title:"Packet Counter",units:[new d]}};function D(e,t){e===h.sop.uuid&&(h.sop||(h.sop={}),h.sop.connection||(h.sop.connection={}),h.sop.connection.status=t)}function A(e,t){e===h.sop.uuid&&(h.sop||(h.sop={}),h.sop.advertisement=t)}function I(e,t){if(e===h.sop.uuid){var n,a=b;if(b=t,!0!==h.loadingSamples)if(!a||a.packetCounter!==t.packetCounter)if(!(t.timestamp<new Date(2010,1,1,1,0,0,0).getTime()))h.sample=t,x+=1,T(t),V(0,n=t),V(1,n)}}function k(){return h.loadingSamples=!0,C.showLoading("Loading..."),(e=x,t=w,s.query({uuid:h.sop.uuid,skip:e,limit:t})).then((function(e){return h.loadingSamples=!1,C.hideLoading(),e.samplesList&&(x+=e.samplesList.length),e.samplesList}),(function(e){throw h.loadingSamples=!1,C.hideLoading(),o.error("Load Samples",e,"Cannot load samples."),e}));var e,t}function U(){P(0),P(1)}function T(e){e&&y.push(e)}function L(e){e&&y.unshift(e)}function q(e){var t=h.channels[e].selectedChannel,n=$[t];h.channels[e].availableUnits=n.units.filter((function(e,t){return!n.allowedUnits||-1!==n.allowedUnits().indexOf(t)})).map((function(e,t){return{name:e.Unit,value:t.toString()}}));var a=0;n.defaultUnit&&(a=n.defaultUnit()),h.channels[e].selectedUnit=h.channels[e].availableUnits[a],P(e)}function O(e){P(e)}function P(e){var t=h.channels[e].selectedChannel,n=parseInt(h.channels[e].selectedUnit.value),a=$[t],o=a.title,i=a.units[n],r=i.Unit,s=i.ValueDecimals,l=i.DetailedValueDecimals;C.yAxis[e].update({labels:{format:"{value:."+s+"f}",style:{color:Highcharts.getOptions().colors[e]}},title:{text:o+(r?" ("+r+")":""),style:{color:Highcharts.getOptions().colors[e]}}}),C.series[e].update({name:o+(r?" ("+r+")":""),type:"line",yAxis:e,data:y.map((function(e){return[e.timestamp,i.convert(e[t],e)]})),tooltip:{valueSuffix:r?" ("+r+")":"",valueDecimals:l}})}function V(e,t){var n=h.channels[e].selectedChannel,a=parseInt(h.channels[e].selectedUnit.value),o=$[n].units[a];C.series[e].addPoint([t.timestamp,o.convert(t[n],t)])}e.$on("$destroy",(function(){i.removeListener("advert",A),s.removeListener("sample",I),p.removeListener("status",D),S&&S()})),h.authentication=t,h.loadingDevice=!1,h.loadingSamples=!1,h.sop,h.sample,h.config,h.channels=[{selectedChannel:"capacitance",channelChanged:function(){q(0)},selectedUnit:{value:"0",name:"pF"},availableUnits:[{value:"0",name:"pF"}],unitChanged:function(){O(0)},style:{color:Highcharts.getOptions().colors[0]}},{selectedChannel:"temperature",channelChanged:function(){q(1)},selectedUnit:{value:"0",name:"°C"},availableUnits:[{value:"0",name:"°C"}],unitChanged:function(){O(1)},style:{color:Highcharts.getOptions().colors[1]}}],h.get=function(){(h.loadingDevice=!0,f.get({sopId:a.sopId}).$promise.then((function(e){h.sop=e,h.config=e.config,h.loadingDevice=!1}),(function(e){throw h.loadingDevice=!1,o.error("SOP Error",e,"Cannot find SOP device in the data base."),e}))).then((function(){var e,t,n;return C=new Highcharts.Chart({plotOptions:{series:{borderWidth:0,animation:!1,states:{hover:{enabled:!1}},marker:{enabled:!1}}},chart:{zoomType:"x",renderTo:"chart",animation:!1},legend:{width:300,itemWidth:150,itemStyle:{width:150}},credits:{enabled:!1},title:{text:""},xAxis:{title:{text:"Date"},type:"datetime"},yAxis:[{labels:{format:"{value} V",style:{color:Highcharts.getOptions().colors[0]}},title:{text:"Battery Voltage",style:{color:Highcharts.getOptions().colors[0]}}},{title:{text:"Temperature",style:{color:Highcharts.getOptions().colors[1]}},labels:{format:"{value} °C",style:{color:Highcharts.getOptions().colors[1]}},opposite:!0}],series:[{name:"Battery Voltage",type:"line",yAxis:0,data:[],tooltip:{valueSuffix:" V"}},{name:"Temperature",type:"line",yAxis:1,data:[],tooltip:{valueSuffix:" °C"}}]}),e=angular.element("#chart"),t=0,n=setInterval((function(){e.width()!==t&&(t=e.width(),C.setSize(t,C.height))}),500),S=function(){clearInterval(n)},k()})).then((function(e){b=e[0],h.sample=b,q(0),function(e){for(var t=e.length-1;t>=0;t--)T(e[t])}(e),U(),i.on("advert",A),s.on("sample",I),p.on("status",D)}))},h.loadMore=function(){k().then((function(e){!function(e){for(var t=0;t<e.length;t++)L(e[t])}(e),U()}))}}]),angular.module("sop").controller("SopLoggingController",["$scope","Authentication","$stateParams","TdDialog","Sop","StateHelper","$mdToast","SopConfig",function(e,t,n,a,o,i,r,s){var l,c=this,u="0";function d(e){r.show(r.simple().position("bottom right").textContent(e).hideDelay(3e3))}function m(t){e.$emit("loadingSignal",t)}c.authentication=t,c.loading=!1,c.fault=!1,c.sop,c.config,c.loggingMode=u,c.logParams={xThreshold:0,yThreshold:0,zThreshold:0,accAcqDivider:0,measSamples:0,checkSamples:0},c.maxAccAcqDivider=20,c.get=function(){var e,t;m(!0),c.loading=!0,(t=n.sopId,o.get({sopId:t}).$promise.catch((function(e){throw"Cannot find Smart-Oil Plug in the data base."}))).then((function(t){return function(e){return s.get(e).catch((function(e){throw"Cannot load Smart-Oil Plug configuration."}))}(e=t)})).then((function(t){return function(e,t){if(!e||!t)throw"Invalid data.";c.sop=e,c.config=t,e.enabled,l=_.cloneDeep(t),u=l.primary.hsAccelEnable.toString(),c.loggingMode=u.toString()}(e,t)})).then((function(){console.log(c.config),c.logParams.xThreshold=parseInt(c.config.primary.xThreshold)/10,c.logParams.yThreshold=parseInt(c.config.primary.yThreshold)/10,c.logParams.zThreshold=parseInt(c.config.primary.zThreshold)/10,c.logParams.accAcqDivider=parseInt(c.config.primary.accAcqDivider),c.logParams.measSamples=parseInt(c.config.primary.measSamples),c.logParams.checkSamples=parseInt(c.config.primary.checkSamples),m(!1),c.loading=!1})).catch((function(e){m(!1),c.loading=!1,c.fault=!0,d(e)}))},c.submit=function(e){if(c.sop){c.config.primary.xThreshold=10*parseInt(c.logParams.xThreshold),c.config.primary.yThreshold=10*parseInt(c.logParams.yThreshold),c.config.primary.zThreshold=10*parseInt(c.logParams.zThreshold),c.config.primary.accAcqDivider=parseInt(c.logParams.accAcqDivider),c.config.primary.measSamples=parseInt(c.logParams.measSamples),c.config.primary.checkSamples=parseInt(c.logParams.checkSamples);var t,n=_.cloneDeep(c.config),a=!angular.equals(n,l);m(!0),c.loading=!0,(t=c.sop,t.$update().catch((function(e){throw"Cannot save Smart-Oil Plug."}))).then((function(){if(a)return function(e,t){return s.upload(e,t).catch((function(e){throw"Cannot add configuration upload task."}))}(c.sop,n).then((function(){d("The configuration has been successfully updated, it will be uploaded to the device during next connection.")}));d("The Smart-Oil Plug has been successfully updated.")})).then((function(){m(!1),c.loading=!1,i.back("core.devices.sop.start")})).catch((function(e){m(!1),c.loading=!1,d(e)}))}}}]),angular.module("sop").controller("SopEditController",["$scope","Authentication","$stateParams","TdDialog","Sop","StateHelper","$mdToast","SopConfig",function(e,t,n,a,o,i,r,s){var l,c=this,u="0",d=!1;function m(e){r.show(r.simple().position("bottom right").textContent(e).hideDelay(3e3))}function f(t){e.$emit("loadingSignal",t)}c.authentication=t,c.loading=!1,c.fault=!1,c.sop,c.config,c.loggingMode=u,c.get=function(){var e,t;f(!0),c.loading=!0,(t=n.sopId,o.get({sopId:t}).$promise.catch((function(e){throw"Cannot find Smart-Oil Plug in the data base."}))).then((function(t){return function(e){return s.get(e).catch((function(e){throw"Cannot load Smart-Oil Plug configuration."}))}(e=t)})).then((function(t){return function(e,t){if(!e||!t)throw"Invalid data.";c.sop=e,c.config=t,d=e.enabled,l=_.cloneDeep(t),u=l.primary.hsAccelEnable.toString(),c.loggingMode=u.toString()}(e,t)})).then((function(){f(!1),c.loading=!1})).catch((function(e){f(!1),c.loading=!1,c.fault=!0,m(e)}))},c.submit=function(e){if(c.sop){c.loggingMode!==u&&(c.config.primary.hsAccelEnable=parseInt(c.loggingMode),console.log("logging mode: "+c.config.primary.hsAccelEnable)),"string"==typeof c.sop.enabled&&(c.sop.enabled="true"===c.sop.enabled),d!==c.sop.enabled&&(!0===c.sop.enabled?c.sop.connection.status.label="N/A":c.sop.connection.status.label="Disabled");var t,n=_.cloneDeep(c.config),a=!angular.equals(n,l);f(!0),c.loading=!0,(t=c.sop,t.$update().catch((function(e){throw"Cannot save Smart-Oil Plug."}))).then((function(){if(a)return function(e,t){return s.upload(e,t).catch((function(e){throw"Cannot add configuration upload task."}))}(c.sop,n).then((function(){m("The configuration has been successfully updated, it will be uploaded to the device during next connection.")}));m("The Smart-Oil Plug has been successfully updated.")})).then((function(){f(!1),c.loading=!1,i.back("core.devices.sop.start")})).catch((function(e){f(!1),c.loading=!1,m(e)}))}},c.download=function(){var e;c.sop&&(f(!0),c.loading=!0,(e=c.sop,s.download(e).catch((function(e){throw"Cannot add configuration download task."}))).then((function(){f(!1),c.loading=!1,m("The configuration will be downloaded from the device during next connection."),i.back("core.devices.sop.start")})).catch((function(e){f(!1),c.loading=!1,m(e)})))}}]),angular.module("sop").controller("SopConnectingController",["Authentication","$rootScope","$scope","$q","$stateParams","$state","$window","TdDialog","$mdToast","StateHelper","TdAdvert","Sop","SopStream","SopConnectionStatus",function(e,t,n,a,o,i,r,s,l,c,u,d,m,f){var p=this,g=!1,v=null,h={advert:"Waiting for advertisement...",connecting:"Connecting...",configuring:"Configuring...",disconnecting:"Disconnecting...",disconnected:"Disconnected",canceling:"Cancelling..."},w=t.$on("$stateChangeStart",(function(e,t,n,a,o,i){if(g)return;console.log("unexpected state change"),e.preventDefault(),p.canCancel?(console.log("can cancel"),S()):(console.log("cannot cancel"),$("error","Cannot cancel request."))}));function y(e){console.log("on before unload");return e.returnValue="Operation in progress, please don't unload the window","Operation in progress, please don't unload the window"}function b(e){}n.$on("$destroy",(function(){u.removeListener("advert",k),f.removeListener("status",U),r.removeEventListener("beforeunload",y),r.removeEventListener("unload",b),v&&(clearInterval(v),v=null),w()})),r.addEventListener("beforeunload",y),r.addEventListener("unload",b);var x=null;function C(){switch(-1!==x.request.indexOf("start")?p.message=h.advert:-1!==x.request.indexOf("stop")&&(p.message=h.disconnecting),x.request){case"start-stream":(console.log("wait stream"),a((function(e,t){var n=function(n){m.removeListener("state",a),v&&(clearInterval(v),v=null),n?($("error",n),t(n)):e()};v=setInterval((function(){m.request(p.sop.uuid).then((function(){console.log("ping con")})).catch((function(e){n(e)}))}),5e3);var a=function(e,t,a){console.log("state",e,t,a),p.sop.uuid===e&&("started"===t?n():"error"===t&&n("Cannot start data stream."))};m.on("state",a)}))).then((function(){I("core.devices.sop.stream",{sopId:p.sop.uuid})}),(function(){A()}));break;case"stop-stream":D().then((function(){A()}),(function(){A()}))}}function S(){switch(p.message=h.canceling,x.request){case"start-stream":D().then((function(){A()}),(function(){A()}))}}function $(e,t){l.show(l.simple().position("bottom right").textContent(t).hideDelay(3e3))}function D(){return v&&(clearInterval(v),v=null),a((function(e,t){m.cancelRequest(p.sop).then((function(){e()}),(function(e){s.error("SOP Error",e,"Cannot stop data stream."),t()}))}))}function A(){x.next&&"core.devices.sop.connecting"!==x.next?I(x.next):I("core.devices.sop.start")}function I(e,t){g=!0,i.go(e,t)}function k(e,t){e===p.sop.uuid&&console.log(t)}function U(e,t){if(e===p.sop.uuid){switch(t.label){case"Connecting...":p.message=h.connecting,p.canCancel=!1;break;case"Connected":p.message=h.configuring,p.canCancel=!1;break;case"Failure":p.message=h.advert,p.canCancel=!0;break;case"Disconnecting...":p.message=h.disconnecting,p.canCancel=!1;break;case"Disconnected":p.message=h.disconnected,p.canCancel=!0}console.log(e,t)}}p.authentication=e,p.loading=!1,p.canCancel=!0,p.sop=null,p.title="Connecting...",p.message="",p.get=function(){p.loading=!0,x={sopId:o.sopId,request:o.request,next:o.next},d.get({sopId:o.sopId}).$promise.then((function(e){p.sop=e})).then((function(){p.title="Connecting to "+p.sop.uuid,u.on("advert",k),f.on("status",U),p.loading=!1,C()}),(function(e){s.error("SOP Error",e,"Cannot find SOP device in the data base."),p.loading=!1}))},p.cancel=function(){S()}}]),angular.module("sop").controller("SopEditSleepController",["$scope","Authentication","$stateParams","TdDialog","Sop","StateHelper","$mdToast","SopConfig","$q",function(e,t,n,a,o,i,r,s,l){var c=this,u=null;function d(e){e=1e3*parseInt(e),c.advertWindows=c.availableAdvertWindows.filter((function(t){var n=parseInt(t.value);return e>n}));var t=parseInt(c.config.primary.advertWindowContactable);0===c.advertWindows.filter((function(e){return parseInt(e.value)===t})).length&&(c.config.primary.advertWindowContactable=c.advertWindows[0].value)}function m(e){r.show(r.simple().position("bottom right").textContent(e).hideDelay(3e3))}function f(t){e.$emit("loadingSignal",t)}c.authentication=t,f(!1),c.loading=!1,c.fault=!1,c.sop,c.advertIntervals=[{value:"5",text:"5 seconds"},{value:"10",text:"10 seconds"},{value:"20",text:"20 seconds"},{value:"30",text:"30 seconds"},{value:"60",text:"1 minute"},{value:"120",text:"2 minutes"},{value:"300",text:"5 minutes"},{value:"600",text:"10 minutes"},{value:"1200",text:"20 minutes"},{value:"1800",text:"30 minutes"},{value:"3600",text:"1 hour"}],c.availableAdvertWindows=[{value:"1000",text:"1 second"},{value:"2000",text:"2 seconds"},{value:"3000",text:"3 seconds"},{value:"5000",text:"5 seconds"},{value:"8000",text:"8 seconds"},{value:"10000",text:"10 seconds"},{value:"20000",text:"20 seconds"},{value:"30000",text:"30 seconds"},{value:"40000",text:"40 seconds"},{value:"50000",text:"50 seconds"},{value:"60000",text:"1 minute"}],c.advertWindows=c.availableAdvertWindows,c.get=function(){var t,a;f(!0),c.loading=!0,(a=n.sopId,o.get({sopId:a}).$promise.catch((function(e){throw"Cannot load SOP."}))).then((function(e){return function(e){return s.get(e).catch((function(e){throw"Cannot load SOP's configuration."}))}(t=e)})).then((function(n){return function(t,n){if(!t||!n)throw"Invalid data.";c.sop=t,c.config=n,u=_.cloneDeep(n),e.$watch(angular.bind(c,(function(){return this.config.primary.advertInterval})),d)}(t,n)})).then((function(){f(!1),c.loading=!1})).catch((function(e){f(!1),c.loading=!1,c.fault=!0,m(e)}))},c.submit=function(e){if(c.sop){var t=_.cloneDeep(c.config);t.primary.advertInterval=parseInt(c.config.primary.advertInterval),t.primary.advertWindowContactable=parseInt(c.config.primary.advertWindowContactable),angular.equals(t,u)?i.back("core.devices.sop.start"):(f(!0),c.loading=!0,function(e,t){return s.upload(e,t).catch((function(e){throw"Cannot add configuration upload task."}))}(c.sop,t).then((function(){f(!1),c.loading=!1,m("The configuration has been successfully updated, it will be uploaded to the device during next connection."),i.back("core.devices.sop.start")})).catch((function(e){f(!1),c.loading=!1,m(e)})))}}}]),angular.module("sop").controller("SopConfigurationController",["$scope","$stateParams",function(e,t){var n=this;n.tabsList=["edit","edit-sleep","calibration","logging"],n.loading=!1,e.$on("loadingSignal",(function(e,t){n.loading=t})),e.tabId=0,e.sopId=t.sopId,n.setTabId=function(t){e.tabId=n.tabsList[t]}}]),angular.module("sop").factory("SopStream",["$q","SopSocket","Task",function(e,t,n){var a={sample:null,state:null};return t.on("app:sop:stream-sample",(function(e,t){a.sample&&a.sample(e,t)})),t.on("app:sop:stream-state",(function(e,t,n){console.log(t),a.state&&a.state(e,t,n)})),{request:function(e){return o(e,1).then((function(t){if(t.tasks.length){var a=t.tasks[0];return new n(a).$update()}return new n({uuid:e,createdOn:Date.now(),command:"stream",mode:"Individual",options:{freq:10}}).$save()}))},cancelRequest:function(t){return o(t.uuid).then((function(t){var a=t.tasks.map((function(e){return new n(e).$remove()}));return e.all(a)}))},on:function(e,t){"sample"===e?a.sample=t:"state"===e&&(a.state=t)},removeListener:function(e,t){"sample"===e?a.sample=null:"state"===e&&(a.state=null)}};function o(e,t){var a={uuid:e,command:"stream",order:"-createdOn",skip:0};return t&&(a.limit=t),n.query(a).$promise}}]),angular.module("sop").factory("SopSocket",["socketFactory",function(e){var t=io.connect();return t.on("connect",(function(){t.emit("name","www")})),e({prefix:"app:sop:",ioSocket:t})}]),angular.module("sop").factory("SopConnectionStatus",["$q","SopSocket",function(e,t){var n={status:null};return t.on("app:sop:status",(function(e,t){n.status&&n.status(e,t)})),{on:function(e,t){"status"===e&&(n.status=t)},removeListener:function(e,t){"status"===e&&(n.status=null)}}}]),goog.provide("proto.SopFile.File"),angular.module("sop").factory("SopFile",["$q","$resource",function(e,t){var n=t("api/fs/:lvl1/:lvl2/:lvl3/:lvl4/:lvl5/:lvl6",null,{get:{responseType:"arraybuffer",transformResponse:function(e,t){return{data:e}}}});return{get:function(t){return e((function(e,a){n.get(t).$promise.then((function(t){e(proto.SopFile.File.deserializeBinary(new Uint8Array(t.data)).toObject())}),(function(e){a(e)}))}))}}}]),angular.module("sop").factory("SopConfig",["Task",function(e){return{upload:function(t,n){var a=t.uuid;return new e({uuid:a,command:"upload",mode:"Individual",options:n}).$save()},download:function(t){var n=t.uuid;return function(t){return e.query({uuid:t,command:"download",order:"-createdOn",limit:1,skip:0}).$promise}(n).then((function(t){return t.tasks.length?t.tasks[0]:new e({uuid:n,command:"download",mode:"Individual"}).$save()}))},get:function(t){return(n=t.uuid,e.query({uuid:n,command:"upload",order:"-createdOn",limit:1,skip:0}).$promise).then((function(e){var n=e.tasks,a=n.length?n[0].options:t.config;return _.cloneDeep(a)}));var n}}}]),angular.module("sop").factory("Sop",["$resource",function(e){return e("api/sop/:sopId",{sopId:"@uuid"},{update:{method:"PUT"},query:{method:"GET",isArray:!1}})}]),angular.module("sop").factory("SopSamples",["$resource",function(e){return e("api/sop/samples/:sopDeviceId",{sopDeviceId:"@uuid"},{update:{method:"PUT"}})}]),goog.require("proto.SopSample.Data"),goog.require("proto.SopSample.DataArray"),angular.module("sop").factory("SopSample",["$q","$resource","TdSocket","TdDialog",function(e,t,n,a){var o={sample:null},i=t("api/sop-sample",null,{get:{responseType:"arraybuffer",transformResponse:function(e,t){return{data:e}}}});return n.on("app:sop:sample",(function(e,t){if(o.sample){var n=proto.SopSample.Data.deserializeBinary(new Uint8Array(t));o.sample(e,n.toObject())}})),{query:function(t){return e((function(e,n){t.proto="protobuf",i.get(t).$promise.then((function(t){var n=proto.SopSample.DataArray.deserializeBinary(new Uint8Array(t.data));e(n.toObject())}),(function(e){n(e)}))}))},on:function(e,t){"sample"===e&&(o.sample=t)},removeListener:function(e,t){"sample"===e&&(o.sample=null)}}}]),angular.module("td").directive("tdchart",(function(){return{restrict:"E",scope:{config:"=config"},replace:!0,templateUrl:"modules/td/views/td-line-chart.client.view.html",controller:["$scope","TDChart",function(e,t){var n,a,o=[],i=[0,1,2];e.api=t;var r=e.config;for(n in r)o[n]=[];for(e.chartConfig={options:{chart:{zoomType:"x"}},credits:{enabled:!1},title:{text:"Monitoring"},legend:{width:300,itemWidth:150,itemStyle:{width:150}},xAxis:{type:"datetime",title:{text:"Date"}},yAxis:[{title:{text:"",style:{color:Highcharts.getOptions().colors[0]}},labels:{format:"{value}",style:{color:Highcharts.getOptions().colors[0]}}},{title:{text:"",style:{color:Highcharts.getOptions().colors[1]}},labels:{format:"{value}",style:{color:Highcharts.getOptions().colors[1]}},opposite:!0},{title:{text:"",style:{color:Highcharts.getOptions().colors[2]}},labels:{format:"{value}",style:{color:Highcharts.getOptions().colors[2]}},opposite:!0}],series:[{name:"",type:"spline",yAxis:0,data:[],tooltip:{valueSuffix:""}},{name:"",type:"spline",yAxis:1,data:[],tooltip:{valueSuffix:""}},{name:"",type:"spline",yAxis:2,data:[],tooltip:{valueSuffix:""}}],loading:!0},n=0,a=i.length;n<a;++n)s(n,r[n].title,r[n].units[0].unit);function s(t,n,a){e.chartConfig.yAxis[t].title.text=n,e.chartConfig.series[t].name=n,e.chartConfig.yAxis[t].labels.format="{value} "+a,e.chartConfig.series[t].tooltip.valueSuffix=" "+a}function l(e,t,n){return r[e].units[t].converter?[n[0],r[e].units[t].converter(n[1])]:n}function c(e){e=parseInt(e);for(var t=0,n=i.length;t<n;++t)if(i[t]===e)return t;return-1}function u(t,n){!0===e.chartConfig.loading&&(e.chartConfig.loading=!1),n.forEach((function(n){e.chartConfig.series[t].data.push(n)}))}e.$watchCollection("api.points",(function(t){if(null!==t){for(var n in t)if(t[n]&&0!==t[n].length){var a=t[n].map((function(e){return o[n].push(e),l(n,0,e)})),i=c(n);i>=0&&u(i,a)}e.api.points=null}}))}],link:function(e,t,n){}}})),angular.module("core").run(["$rootScope","$state","$location","Authentication",function(e,t,n,a){e.$on("$stateChangeStart",(function(e,t,o,i,r){"signin"!==t.name&&(a.user||n.path("signin"))}))}]),angular.module("td").factory("TdDialog",["$mdDialog",function(e){return{error:function(t,n,a){var o=a;n&&n.data&&n.data.message&&(o=n.data.message),e.show(e.alert().parent(angular.element(document.querySelector("body"))).clickOutsideToClose(!0).title(t).textContent(o).ok("Okay"))}}}]),goog.require("proto.BleAdvert.Data"),goog.require("proto.BleAdvert.DataArray"),angular.module("td").factory("TdAdvert",["$q","$resource","TdSocket","TdDialog",function(e,t,n,a){var o={advert:null},i=t("api/advert",null,{get:{responseType:"arraybuffer",transformResponse:function(e,t){return{data:e}}}});return n.on("app:advert",(function(e,t){if(o.advert){var n=proto.BleAdvert.Data.deserializeBinary(new Uint8Array(t));o.advert(e,n.toObject())}})),{query:function(t){return e((function(e,n){i.get(t).$promise.then((function(t){var n=proto.BleAdvert.DataArray.deserializeBinary(new Uint8Array(t.data));e(n.toObject())}),(function(e){n(e)}))}))},on:function(e,t){"advert"===e&&(o.advert=t)},removeListener:function(e,t){"advert"===e&&(o.advert=null)}}}]),angular.module("td").factory("TdSocket",["socketFactory",function(e){var t=io.connect();return t.on("connect",(function(){t.emit("name","www")})),e({prefix:"app:",ioSocket:t})}]),angular.module("td").factory("ProtobufModel",["$q","TdDialog",function(e,t){function n(t){return e((function(e,n){"undefined"!=typeof dcodeIO&&dcodeIO.ProtoBuf?dcodeIO.ProtoBuf.loadJsonFile(t,(function(t,a){t?n(t):e(a)})):n(new Error("ProtoBuf.js is not present."))}))}var a=e.all([n("/lib/protobuf-models/ble/advert.json"),n("/lib/protobuf-models/astute/stream.json"),n("/lib/protobuf-models/astute/logging.json")]);return e((function(e,n){a.then((function(t){e({BleAdvertData:t[0].build("BleAdvert.Data"),BleAdvertDataArray:t[0].build("BleAdvert.DataArray"),AstuteStreamSample:t[1].build("AstuteStream.Sample"),AstuteLoggingSample:t[2].build("AstuteLogging.Sample"),AstuteLoggingStats:t[2].build("AstuteLogging.Stats"),AstuteLoggingValueStats:t[2].build("AstuteLogging.ValueStats")})}),(function(e){t.error("Load Models",e,"Cannot load protobuf models."),n(e)}))}))}]),angular.module("td").factory("TDChart",(function(){return{points:null,addPoints:function(e,t){this.points||(this.points=[]),this.points[e]||(this.points[e]=[]);for(var n=0,a=t.length;n<a;n++)this.points[e].push(t[n])},addPoint:function(e,t,n){this.points||(this.points=[]),this.points[e]||(this.points[e]=[]),this.points[e].push([t,n])},clearPoints:function(){this.points=null}}})),angular.module("cw").config(["$stateProvider",function(e){e.state("core.devices.cw",{abstract:!0,url:"/cw",templateUrl:"modules/carbonwear/views/cw-content.client.view.html"}).state("core.devices.cw.start",{url:"/",templateUrl:"modules/carbonwear/views/cw-individual.client.view.html"}).state("core.devices.cw.stats",{url:"/statistics/:cwId",templateUrl:"modules/carbonwear/views/cw-statistics.client.view.html"}).state("core.devices.cw.edit",{url:"/edit/:cwId",templateUrl:"modules/carbonwear/views/cw-edit.client.view.html"}).state("core.devices.cw.edit-sleep",{url:"/edit-sleep/:cwId",templateUrl:"modules/carbonwear/views/cw-edit-sleep.client.view.html"}).state("core.devices.cw.calibration",{url:"/calibration/:cwId",templateUrl:"modules/carbonwear/views/cw-calibration.client.view.html"}).state("core.devices.cw.connecting",{url:"/connecting/:cwId/:request/:next",templateUrl:"modules/carbonwear/views/cw-connecting.client.view.html"}).state("core.devices.cw.stream",{url:"/stream/:cwId",templateUrl:"modules/carbonwear/views/cw-stream.client.view.html"}).state("core.devices.cw.log-view",{url:"/log-view/:path",templateUrl:"modules/carbonwear/views/cw-data-viewer.client.view.html"})}]),angular.module("cw").controller("CwIndividualController",["$scope","$state","Cw","CwConnectionStatus","TdDialog","TdAdvert","CwSocket","CwStream",function(e,t,n,a,o,i,r,s){var l=this;e.$on("$destroy",(function(){l.selected[0]?sessionStorage.setItem("cw.individual.selected",l.selected[0].uuid):sessionStorage.setItem("cw.individual.selected",void 0),sessionStorage.setItem("cw.individual.query",JSON.stringify(l.query)),i.removeListener("advert",f),a.removeListener("status",m),r.removeListener("app:cw:config-state",p)})),l.isLoading=!1,l.selected=[],l.section="devices";var c=sessionStorage.getItem("cw.individual.query"),u=sessionStorage.getItem("cw.individual.selected");l.query=c?JSON.parse(c):{order:"uuid",limit:10,page:1};function d(e){return _.find(l.cws.devices,(function(t){return e===t.uuid}))}function m(e,t){var n=d(e);n&&_.set(n,"connection.status",t)}function f(e,t){var n=d(e);n&&_.set(n,"advertisement",t)}function p(e,t,n){if("upload"===t||"download"===t){var a=d(e);a&&(_.set(a,"config.timestamp",n.timestamp),_.set(a,"config.primary",n.primary))}}l.get=function(){l.isLoading=!0,function(e){return n.query(e).$promise.catch((function(e){throw o.error("Carbon Wear Request",e,"Cannot load Carbon Wear devices."),e}))}({order:l.query.order,skip:(l.query.page-1)*l.query.limit,limit:l.query.limit}).then((function(e){l.cws=e,u&&l.cws.devices.forEach((function(e){e.uuid===u&&(l.selected[0]=e)})),a.on("status",m),i.on("advert",f),r.on("app:cw:config-state",p),l.isLoading=!1})).catch((function(e){l.isLoading=!1}))},l.stream=function(){l.selected[0]&&(l.isLoading=!0,s.request(l.selected[0].uuid).then((function(){l.isLoading=!1,t.go("core.devices.cw.connecting",{cwId:l.selected[0].uuid,request:"start-stream"})}),(function(e){l.isLoading=!1,o.error("Carbon Wear Error",e,"Cannot start data stream.")})))},l.statistics=function(){l.selected[0]&&t.go("core.devices.cw.stats",{cwId:l.selected[0].uuid})},l.calibration=function(){l.selected[0]&&t.go("core.devices.cw.calibration",{cwId:l.selected[0].uuid})},l.editSleep=function(){l.selected[0]&&t.go("core.devices.cw.edit-sleep",{cwId:l.selected[0].uuid})},l.edit=function(){l.selected[0]&&t.go("core.devices.cw.edit",{cwId:l.selected[0].uuid})}}]),angular.module("cw").controller("CwStatisticsController",["$scope","Authentication","$q","$stateParams","TdDialog","TdAdvert","CwSample","Cw","CwConnectionStatus","StateHelper","$window","$interval",function(e,t,n,a,o,i,r,s,m,f,p,g){var v=this,h=200,w=[],y=null,b=0,x=null,C=null,S=null,$={photoArrayRaw:{title:"Photo Array",units:[new d]},temperature:{title:"Temperature",units:[new c]},batteryVoltage:{title:"Battery Voltage",units:[new u]},rssi:{title:"RSSI",units:[new l]},restartsUnknown:{title:"Unknown Restarts",units:[new d]},restartsSoftware:{title:"Software Restarts",units:[new d]},restartsWatchdog:{title:"Watchdog Restarts",units:[new d]},configNumber:{title:"Configuration Number",units:[new d]},packetCounter:{title:"Packet Counter",units:[new d]}};function D(e){var t=angular.element("#photoArrayCanvas")[0],n=t.getContext("2d"),a=t.clientWidth,o=(a-6-114)/20,i=o+6;v.canvasStyle.height=i.toString()+"px",n.canvas.width=a,n.canvas.height=i,n.clearRect(0,0,t.width,t.height);for(var r=0;r<20;r++)n.beginPath(),n.strokeStyle="black",n.lineWidth=2..toString(),0!=e[r]?n.fillStyle="#FFD952":n.fillStyle="#969091",n.rect(3+r*o+6*r,3,o,o),n.fill(),n.stroke()}function A(e){return Array.from(Array(20).keys()).map((function(t){return(e&1<<t)>>t}))}function I(e,t){e===v.cw.uuid&&(v.cw||(v.cw={}),v.cw.connection||(v.cw.connection={}),v.cw.connection.status=t)}function k(e,t){e===v.cw.uuid&&(v.cw||(v.cw={}),v.cw.advertisement=t)}function U(e,t){if(e===v.cw.uuid){var n,a=y;if(y=t,!0!==v.loadingSamples)if(!a||a.packetCounter!==t.packetCounter)if(!(t.timestamp<new Date(2010,1,1,1,0,0,0).getTime()))v.sample=t,b+=1,q(t),W(0,n=t),W(1,n)}}function T(){return v.loadingSamples=!0,C.showLoading("Loading..."),(e=b,t=h,r.query({uuid:v.cw.uuid,skip:e,limit:t})).then((function(e){return v.loadingSamples=!1,C.hideLoading(),e.samplesList&&(b+=e.samplesList.length),e.samplesList}),(function(e){throw v.loadingSamples=!1,C.hideLoading(),o.error("Load Samples",e,"Cannot load samples."),e}));var e,t}function L(){M(0),M(1)}function q(e){e&&w.push(e)}function O(e){e&&w.unshift(e)}function P(e){var t=v.channels[e].selectedChannel,n=$[t];v.channels[e].availableUnits=n.units.filter((function(e,t){return!n.allowedUnits||-1!==n.allowedUnits().indexOf(t)})).map((function(e,t){return{name:e.Unit,value:t.toString()}}));var a=0;n.defaultUnit&&(a=n.defaultUnit()),v.channels[e].selectedUnit=v.channels[e].availableUnits[a],M(e)}function V(e){M(e)}function M(e){var t=v.channels[e].selectedChannel,n=parseInt(v.channels[e].selectedUnit.value),a=$[t],o=a.title,i=a.units[n],r=i.Unit,s=i.ValueDecimals,l=i.DetailedValueDecimals;C.yAxis[e].update({labels:{format:"{value:."+s+"f}",style:{color:Highcharts.getOptions().colors[e]}},title:{text:o+(r?" ("+r+")":""),style:{color:Highcharts.getOptions().colors[e]}}}),C.series[e].update({name:o+(r?" ("+r+")":""),type:"line",yAxis:e,data:w.map((function(e){return[e.timestamp,i.convert(e[t],e)]})),tooltip:{valueSuffix:r?" ("+r+")":"",valueDecimals:l}})}function W(e,t){var n=v.channels[e].selectedChannel,a=parseInt(v.channels[e].selectedUnit.value),o=$[n].units[a];C.series[e].addPoint([t.timestamp,o.convert(t[n],t)])}e.$on("$destroy",(function(){i.removeListener("advert",k),r.removeListener("sample",U),m.removeListener("status",I),x&&(g.cancel(x),x=null),S&&S()})),v.authentication=t,v.loadingDevice=!1,v.loadingSamples=!1,v.cw,v.sample,v.config,v.canvasStyle={height:"80px"},v.channels=[{selectedChannel:"temperature",channelChanged:function(){P(0)},selectedUnit:{value:"0",name:"°C"},availableUnits:[{value:"0",name:"°C"}],unitChanged:function(){V(0)},style:{color:Highcharts.getOptions().colors[0]}},{selectedChannel:"batteryVoltage",channelChanged:function(){P(1)},selectedUnit:{value:"0",name:"V"},availableUnits:[{value:"0",name:"V"}],unitChanged:function(){V(1)},style:{color:Highcharts.getOptions().colors[1]}}],v.get=function(){(v.loadingDevice=!0,s.get({cwId:a.cwId}).$promise.then((function(e){v.cw=e,v.config=e.config,v.loadingDevice=!1}),(function(e){throw v.loadingDevice=!1,o.error("Carbon Wear Error",e,"Cannot find Carbon Wear device in the data base."),e}))).then((function(){var e,t,n;return C=new Highcharts.Chart({plotOptions:{series:{borderWidth:0,animation:!1,states:{hover:{enabled:!1}},marker:{enabled:!1}}},chart:{zoomType:"x",renderTo:"chart",animation:!1},legend:{width:300,itemWidth:150,itemStyle:{width:150}},credits:{enabled:!1},title:{text:""},xAxis:{title:{text:"Date"},type:"datetime"},yAxis:[{labels:{format:"{value} V",style:{color:Highcharts.getOptions().colors[0]}},title:{text:"Battery Voltage",style:{color:Highcharts.getOptions().colors[0]}}},{title:{text:"Temperature",style:{color:Highcharts.getOptions().colors[1]}},labels:{format:"{value} °C",style:{color:Highcharts.getOptions().colors[1]}},opposite:!0}],series:[{name:"Battery Voltage",type:"line",yAxis:0,data:[],tooltip:{valueSuffix:" V"}},{name:"Temperature",type:"line",yAxis:1,data:[],tooltip:{valueSuffix:" °C"}}]}),e=angular.element("#chart"),t=0,n=setInterval((function(){e.width()!==t&&(t=e.width(),C.setSize(t,C.height))}),500),S=function(){clearInterval(n)},T()})).then((function(e){y=e[0],v.sample=y,P(0),function(e){for(var t=e.length-1;t>=0;t--)q(e[t])}(e),L(),i.on("advert",k),r.on("sample",U),m.on("status",I),D(A(v.sample.photoArrayRaw)),x=g((function(){D(A(v.sample.photoArrayRaw))}),500)}))},v.loadMore=function(){T().then((function(e){!function(e){for(var t=0;t<e.length;t++)O(e[t])}(e),L()}))}}]),angular.module("cw").controller("CwEditController",["Authentication","$stateParams","TdDialog","Cw","StateHelper","$mdToast","CwConfig",function(e,t,n,a,o,i,r){var s,l=this,c="0",u=!1;function d(e){i.show(i.simple().position("bottom right").textContent(e).hideDelay(3e3))}l.authentication=e,l.loading=!1,l.fault=!1,l.cw,l.config,l.loggingMode=c,l.get=function(){var e,n;l.loading=!0,(n=t.cwId,a.get({cwId:n}).$promise.catch((function(e){throw"Cannot find Smart-Oil Plug in the data base."}))).then((function(t){return function(e){return r.get(e).catch((function(e){throw"Cannot load Smart-Oil Plug configuration."}))}(e=t)})).then((function(t){return function(e,t){if(!e||!t)throw"Invalid data.";l.cw=e,l.config=t,u=e.enabled,s=_.cloneDeep(t),c=s.primary.hsAccelEnable.toString(),l.loggingMode=c.toString()}(e,t)})).then((function(){l.loading=!1})).catch((function(e){l.loading=!1,l.fault=!0,d(e)}))},l.submit=function(e){if(l.cw){l.loggingMode!==c&&(l.config.primary.hsAccelEnable=parseInt(l.loggingMode),console.log("logging mode: "+l.config.primary.hsAccelEnable)),"string"==typeof l.cw.enabled&&(l.cw.enabled="true"===l.cw.enabled),u!==l.cw.enabled&&(!0===l.cw.enabled?l.cw.connection.status.label="N/A":l.cw.connection.status.label="Disabled");var t,n=_.cloneDeep(l.config),a=!angular.equals(n,s);l.loading=!0,(t=l.cw,t.$update().catch((function(e){throw"Cannot save Smart-Oil Plug."}))).then((function(){if(a)return function(e,t){return r.upload(e,t).catch((function(e){throw"Cannot add configuration upload task."}))}(l.cw,n).then((function(){d("The configuration has been successfully updated, it will be uploaded to the device during next connection.")}));d("The Smart-Oil Plug has been successfully updated.")})).then((function(){l.loading=!1,o.back("core.devices.cw.start")})).catch((function(e){l.loading=!1,d(e)}))}},l.download=function(){var e;l.cw&&(l.loading=!0,(e=l.cw,r.download(e).catch((function(e){throw"Cannot add configuration download task."}))).then((function(){l.loading=!1,d("The configuration will be downloaded from the device during next connection."),o.back("core.devices.cw.start")})).catch((function(e){l.loading=!1,d(e)})))}}]),angular.module("cw").controller("CwEditSleepController",["$scope","Authentication","$stateParams","TdDialog","Cw","StateHelper","$mdToast","CwConfig","$q",function(e,t,n,a,o,i,r,s,l){var c=this,u=null;function d(e){e=1e3*parseInt(e),c.advertWindows=c.availableAdvertWindows.filter((function(t){var n=parseInt(t.value);return e>n}));var t=parseInt(c.config.primary.advertWindowContactable);0===c.advertWindows.filter((function(e){return parseInt(e.value)===t})).length&&(c.config.primary.advertWindowContactable=c.advertWindows[0].value)}function m(e){r.show(r.simple().position("bottom right").textContent(e).hideDelay(3e3))}c.authentication=t,c.loading=!1,c.fault=!1,c.cw,c.advertIntervals=[{value:"5",text:"5 seconds"},{value:"10",text:"10 seconds"},{value:"20",text:"20 seconds"},{value:"30",text:"30 seconds"},{value:"60",text:"1 minute"},{value:"120",text:"2 minutes"},{value:"300",text:"5 minutes"},{value:"600",text:"10 minutes"},{value:"1200",text:"20 minutes"},{value:"1800",text:"30 minutes"},{value:"3600",text:"1 hour"}],c.availableAdvertWindows=[{value:"1000",text:"1 second"},{value:"2000",text:"2 seconds"},{value:"3000",text:"3 seconds"},{value:"5000",text:"5 seconds"},{value:"8000",text:"8 seconds"},{value:"10000",text:"10 seconds"},{value:"20000",text:"20 seconds"},{value:"30000",text:"30 seconds"},{value:"40000",text:"40 seconds"},{value:"50000",text:"50 seconds"},{value:"60000",text:"1 minute"}],c.advertWindows=c.availableAdvertWindows,c.get=function(){var t,a;c.loading=!0,(a=n.cwId,o.get({cwId:a}).$promise.catch((function(e){throw"Cannot load device."}))).then((function(e){return function(e){return s.get(e).catch((function(e){throw"Cannot load configuration."}))}(t=e)})).then((function(n){return function(t,n){if(!t||!n)throw"Invalid data.";c.cw=t,c.config=n,u=_.cloneDeep(n),e.$watch(angular.bind(c,(function(){return this.config.primary.advertInterval})),d)}(t,n)})).then((function(){c.loading=!1})).catch((function(e){c.loading=!1,c.fault=!0,m(e)}))},c.submit=function(e){if(c.cw){var t=_.cloneDeep(c.config);t.primary.advertInterval=parseInt(c.config.primary.advertInterval),t.primary.advertWindowContactable=parseInt(c.config.primary.advertWindowContactable),angular.equals(t,u)?i.back("core.devices.cw.start"):(c.loading=!0,function(e,t){return s.upload(e,t).catch((function(e){throw"Cannot add configuration upload task."}))}(c.cw,t).then((function(){c.loading=!1,m("The configuration has been successfully updated, it will be uploaded to the device during next connection."),i.back("core.devices.cw.start")})).catch((function(e){c.loading=!1,m(e)})))}}}]),angular.module("cw").controller("CwConnectingController",["Authentication","$rootScope","$scope","$q","$stateParams","$state","$window","TdDialog","$mdToast","StateHelper","TdAdvert","Sop","SopStream","SopConnectionStatus",function(e,t,n,a,o,i,r,s,l,c,u,d,m,f){var p=this,g=!1,v={advert:"Waiting for advertisement...",connecting:"Connecting...",configuring:"Configuring...",disconnecting:"Disconnecting...",disconnected:"Disconnected",canceling:"Cancelling..."},h=t.$on("$stateChangeStart",(function(e,t,n,a,o,i){if(g)return;console.log("unexpected state change"),e.preventDefault(),p.canCancel?(console.log("can cancel"),C()):(console.log("cannot cancel"),S("error","Cannot cancel request."))}));function w(e){console.log("on before unload");return e.returnValue="Operation in progress, please don't unload the window","Operation in progress, please don't unload the window"}function y(e){}n.$on("$destroy",(function(){u.removeListener("advert",I),f.removeListener("status",k),r.removeEventListener("beforeunload",w),r.removeEventListener("unload",y),h()})),r.addEventListener("beforeunload",w),r.addEventListener("unload",y);var b=null;function x(){switch(-1!==b.request.indexOf("start")?p.message=v.advert:-1!==b.request.indexOf("stop")&&(p.message=v.disconnecting),b.request){case"start-stream":(console.log("wait stream"),a((function(e,t){var n=function(n){m.removeListener("state",o),clearInterval(a),n?(S("error",error),t(n)):e()},a=setInterval((function(){m.request(p.sop.uuid).then((function(){console.log("ping con")})).catch((function(e){n(e)}))}),5e3),o=function(e,t,a){console.log("state",e,t,a),p.sop.uuid===e&&("started"===t?n():"error"===t&&n("Cannot start data stream."))};m.on("state",o)}))).then((function(){A("core.devices.sop.stream",{sopId:p.sop.uuid})}),(function(){D()}));break;case"stop-stream":$().then((function(){D()}),(function(){D()}))}}function C(){switch(p.message=v.canceling,b.request){case"start-stream":$().then((function(){D()}),(function(){D()}))}}function S(e,t){l.show(l.simple().position("bottom right").textContent(t).hideDelay(3e3))}function $(){return a((function(e,t){m.cancelRequest(p.sop).then((function(){e()}),(function(e){s.error("SOP Error",e,"Cannot stop data stream."),t()}))}))}function D(){b.next&&"core.devices.sop.connecting"!==b.next?A(b.next):A("core.devices.sop.start")}function A(e,t){g=!0,i.go(e,t)}function I(e,t){e===p.sop.uuid&&console.log(t)}function k(e,t){if(e===p.sop.uuid){switch(t.label){case"Connecting...":p.message=v.connecting,p.canCancel=!1;break;case"Connected":p.message=v.configuring,p.canCancel=!1;break;case"Failure":p.message=v.advert,p.canCancel=!0;break;case"Disconnecting...":p.message=v.disconnecting,p.canCancel=!1;break;case"Disconnected":p.message=v.disconnected,p.canCancel=!0}console.log(e,t)}}p.authentication=e,p.loading=!1,p.canCancel=!0,p.sop=null,p.title="Connecting...",p.message="",p.get=function(){p.loading=!0,b={sopId:o.sopId,request:o.request,next:o.next},d.get({sopId:o.sopId}).$promise.then((function(e){p.sop=e})).then((function(){p.title="Connecting to "+p.sop.uuid,u.on("advert",I),f.on("status",k),p.loading=!1,x()}),(function(e){s.error("SOP Error",e,"Cannot find SOP device in the data base."),p.loading=!1}))},p.cancel=function(){C()}}]),angular.module("cw").controller("CwDataViewerController",["$scope","Authentication","$q","$stateParams","TdDialog","CarbonWearFile","$interval",function(e,t,n,a,o,i,r){var s=this,l=null,c=null,u=null,d=null;function m(){return n((function(e,t){s.progress={type:"indeterminate",value:void 0,disabled:!1},i.get(function(){var e,t={},n=a.path.split("/");for(e=0;e<n.length;++e)t["lvl"+(e+1)]=n[e];return t}()).then((function(t){s.progress.disabled=!0,e(t)}),(function(e){s.progress.disabled=!0,o.error("Carbon Wear Error",e,"Cannot find logging data file."),t(e)}))}))}function f(e,t,n,a,o,i){return new Highcharts.Chart({plotOptions:{series:{borderWidth:0,animation:!1,states:{hover:{enabled:!1}},marker:{enabled:!1},pointStart:0,pointInterval:1/1666}},chart:{zoomType:"xy",renderTo:e,animation:!1},tooltip:{useHTML:!0,shared:!0,formatter:function(){var e="";return e+='<span style="font-size: 10px">'+Highcharts.numberFormat(this.points[0].x,3)+" s</span><br/>",angular.forEach(this.points,(function(t){e+='<span style="color:'+t.color+'">●</span> '+t.series.name+": <b>"+t.y.toFixed(3)+" "+n+"</b><br/>"})),e}},legend:{width:300,itemWidth:100,itemStyle:{width:100}},credits:{enabled:!1},title:{text:t},xAxis:{title:{text:"Time [s]"}},yAxis:[{min:a,max:o,startOnTick:!0,endOnTick:!0,labels:{format:"{value} "+n},title:{text:t+" ["+n+"]"}}],series:i})}function p(e){var t=angular.element("#photoArrayCanvas")[0],n=t.getContext("2d"),a=t.clientWidth,o=(a-6-114)/20,i=o+6;s.canvasStyle.height=i.toString()+"px",n.canvas.width=a,n.canvas.height=i,n.clearRect(0,0,t.width,t.height);for(var r=0;r<20;r++)n.beginPath(),n.strokeStyle="black",n.lineWidth=2..toString(),0!=e[r]?n.fillStyle="#FFD952":n.fillStyle="#969091",n.rect(3+r*o+6*r,3,o,o),n.fill(),n.stroke()}s.authentication=t,s.file=null,s.progress={type:"determinate",value:100,disabled:!0},s.canvasStyle={height:"80px"},e.$on("$destroy",(function(){l&&(r.cancel(l),l=null),c&&(r.cancel(c),c=null)})),s.get=function(){u=f("chartAcc","Acceleration","g",-16,16,[{name:"X",type:"line",data:[],tooltip:{valueSuffix:" g"}},{name:"Y",type:"line",data:[],tooltip:{valueSuffix:" g"}},{name:"Z",type:"line",data:[],tooltip:{valueSuffix:" g"}}]),d=f("chartGyr","Angular Rate","dps",-250,250,[{name:"X",type:"line",data:[],tooltip:{valueSuffix:" dps"}},{name:"Y",type:"line",data:[],tooltip:{valueSuffix:" dps"}},{name:"Z",type:"line",data:[],tooltip:{valueSuffix:" dps"}}]),u.showLoading("Loading..."),d.showLoading("Loading..."),m().then((function(e){console.log(e),s.file=e;for(var t,n,a,o,i=0;i<3;i++){var m=e.acceleration.samplesList[i].valuesList.map((function(e){return e*(16/32768)}));u.series[i].setData(m);m=e.gyroscope.samplesList[i].valuesList.map((function(e){return e*(250/32768)}));d.series[i].setData(m)}u.hideLoading(),d.hideLoading(),t=angular.element("#chartAcc"),n=0,a=angular.element("#chartGyr"),o=0,c=r((function(){t.width()!==n&&(n=t.width(),u.setSize(n,u.height)),a.width()!==o&&(o=a.width(),d.setSize(o,d.height))}),500);var f=function(e){return Array.from(Array(20).keys()).map((function(t){return(e&1<<t)>>t}))}(e.remoteStatus.photoArrayRaw);l=r((function(){p(f)}),500),p(f)}))}}]),angular.module("cw").controller("CwController",["$rootScope","$scope","Authentication",function(e,t,n){t.authentication=n,e.section="devices.cw"}]),angular.module("cw").controller("CwStreamController",["$rootScope","$scope","$q","$state","$stateParams","$interval","$window","TdDialog","Authentication","Sop","SopStream","TdAdvert","SopConnectionStatus",function(e,t,n,a,o,i,s,f,p,g,v,h,w){var y=this,b=null,x=!1,C=600,S=100,$=null;y.authentication=p,y.loadingDevice=!1,y.loadingSamples=!1,y.sample=null,y.samples=[],y.chartConfig={options:{chart:{zoomType:"x",animation:!1},exporting:{enabled:!1},plotOptions:{series:{borderWidth:0,animation:!1,marker:{enabled:!1}}}},credits:{enabled:!1},legend:{width:300,itemWidth:150,itemStyle:{width:150}},title:{text:""},xAxis:{type:"datetime",title:{text:"Date"}},yAxis:[{labels:{format:"{value} V",style:{color:Highcharts.getOptions().colors[0]}},title:{text:"Battery Voltage",style:{color:Highcharts.getOptions().colors[0]}}},{title:{text:"Temperature",style:{color:Highcharts.getOptions().colors[1]}},labels:{format:"{value} °C",style:{color:Highcharts.getOptions().colors[1]}},opposite:!0}],series:[{name:"Battery Voltage",type:"line",yAxis:0,data:E(),tooltip:{valueSuffix:" V"}},{name:"Temperature",type:"line",yAxis:1,data:E(),tooltip:{valueSuffix:" °C"}}],func:function(e){b=e}};var D=e.$on("$stateChangeStart",(function(e,t,n,a,o,i){if(!0===x)return;x=!0,e.preventDefault(),M(t.name)}));function A(e){var t="Do not leave this page during connection, please navigate back first to disconnect first.";return e.returnValue=t,t}function I(e){}t.$on("$destroy",(function(){D(),h.removeListener("advert",q),w.removeListener("status",O),v.removeListener("sample",P),v.removeListener("state",V),s.removeEventListener("beforeunload",A),s.removeEventListener("unload",I),$&&(clearInterval($),$=null),b=null})),s.addEventListener("beforeunload",A),s.addEventListener("unload",I);var k={sensorCapacitance:{title:"Capacitance",units:[new m]},sensorTemperature:{title:"Temperature",units:[new c]},sensorAccelX:{title:"Accel-X",units:[new r]},sensorAccelY:{title:"Accel-Y",units:[new r]},sensorAccelZ:{title:"Accel-Z",units:[new r]},temperature:{title:"Internal Temperature",units:[new c]},batteryVoltage:{title:"Battery Voltage",units:[new u]},remoteRssi:{title:"RSSI - Remote",units:[new l]},localRssi:{title:"RSSI - Local",units:[new l]},packetCounter:{title:"Packet Counter",units:[new d]}};function U(e){var t=y.channels[e].selectedChannel,n=k[t];y.channels[e].availableUnits=n.units.filter((function(e,t){return!n.allowedUnits||-1!==n.allowedUnits().indexOf(t)})).map((function(e,t){return{name:e.Unit,value:t.toString()}}));var a=0;n.defaultUnit&&(a=n.defaultUnit()),y.channels[e].selectedUnit=y.channels[e].availableUnits[a],L(e)}function T(e){L(e)}function L(e){var t=function(e){const t=y.channels[e];var n=k[t.selectedChannel],a=n.units[parseInt(t.selectedUnit.value)];return{def:n,unit:a,unit:a}}(e);b.yAxis[e].update(function(e,t,n){return{labels:{format:"{value:."+t.ValueDecimals+"f}",style:{color:Highcharts.getOptions().colors[n]}},title:{text:e.title+(t.Unit?" ("+t.Unit+")":""),style:{color:Highcharts.getOptions().colors[n]}},startOnTick:!0,endOnTick:!0}}(t.def,t.unit,e));var n=function(e,t){if(e.minmax)return{min:e.minmax.min,max:e.minmax.max};var n=t.minmax(y.config.primary);if(n)return{min:n.min,max:n.max};return{min:void 0,max:void 0}}(t.def,t.unit);b.yAxis[e].setExtremes(n.min,n.max),b.series[e].update(function(e,t,n){return{name:e.title+(t.Unit?" ("+t.Unit+")":""),type:"line",yAxis:n,data:B(n,y.config.primary),tooltip:{valueSuffix:t.Unit?" ("+t.Unit+")":"",valueDecimals:t.DetailedValueDecimals}}}(t.def,t.unit,e))}function q(e,t){e===y.sop.uuid&&console.log(t)}function O(e,t){e===y.sop.uuid&&console.log(e,t)}function P(e,t){e===y.sop.uuid&&t&&(y.sample=t,y.loadingSamples=!1,b&&function(e){if(!b)return;var t=Date.now();y.samples.unshift({timestamp:t,sample:e});for(;y.samples.length>C;)y.samples.pop();W(0,t,e,y.config.primary),W(1,t,e,y.config.primary),b.xAxis[0].setExtremes(t-C*S,t),b.redraw()}(t))}function V(e,t,n){e===y.sop.uuid&&("stopped"===t?(n&&f.error("Data Stream",void 0,n),M("core.devices.wa.start")):console.log("unhandled stream state: "+t))}function M(e){a.go("core.devices.sop.connecting",{sopId:y.sop.uuid,request:"stop-stream",next:e})}function W(e,t,n,a){b.series[e].addPoint(R(e,t,n,a),!1,!0)}function R(e,t,n,a){var o=y.channels[e].selectedChannel,i=parseInt(y.channels[e].selectedUnit.value);return[t,k[o].units[i].convert(n[o],a)]}function B(e,t){for(var n=[],a=(new Date).getTime(),o=C-1;o>=0;o--){var i=a+-o*S,r=null;y.samples&&y.samples[o]&&y.samples[o].timestamp&&y.samples[o].sample&&(i=parseInt(y.samples[o].timestamp),r=y.samples[o].sample),r?n.push(R(e,i,r,t)):n.push([i,0])}return n}function E(){var e,t=[],n=(new Date).getTime();for(e=-C;e<=0;e++)t.push({x:n+e*S,y:0});return t}y.channels=[{selectedChannel:"sensorCapacitance",channelChanged:function(){U(0)},selectedUnit:{value:"0",name:"pF"},availableUnits:[{value:"0",name:"pF"}],unitChanged:function(){T(0)},style:{color:Highcharts.getOptions().colors[0]}},{selectedChannel:"temperature",channelChanged:function(){U(1)},selectedUnit:{value:"0",name:"°C"},availableUnits:[{value:"0",name:"°C"}],unitChanged:function(){T(1)},style:{color:Highcharts.getOptions().colors[1]}}],y.get=function(){y.loadingSamples=!0,(y.loadingDevice=!0,g.get({sopId:o.sopId}).$promise.then((function(e){y.sop=e,y.advert=e.advertisement,y.config=e.config,y.loadingDevice=!1}),(function(e){throw y.loadingDevice=!1,f.error("SOP Error",e,"Cannot find SOP device in the data base."),e}))).then((function(){h.on("advert",q),w.on("status",O),v.on("sample",P),v.on("state",V),$=setInterval((function(){v.request(y.sop.uuid).then((function(){console.log("ping")})).catch((function(e){complete(e)}))}),5e3),U(0),U(1)}),(function(e){f.error("SOP Error",e,"Canot load SOP.")}))}}]),angular.module("cw").controller("CwCalibrationController",["Authentication","$stateParams","TdDialog","Sop","StateHelper","$mdToast","SopConfig","$mdDialog",function(e,t,n,a,o,i,r,s){var l,c=this;function u(e){i.show(i.simple().position("bottom right").textContent(e).hideDelay(3e3))}c.authentication=e,c.loading=!1,c.fault=!1,c.sop,c.config,c.cal={capDacA:0,capDacB:0,capOffset:0,capGain:0,capCtrl:0},c.get=function(){c.loading=!0,a.get({sopId:t.sopId}).$promise.then((function(e){return e})).then((function(e){return c.sop=e,function(e){return r.get(e).catch((function(e){throw"Cannot load Smart-Oil Plug configuration."}))}(e)})).then((function(e){c.config=e,l=_.cloneDeep(e),console.log(c.config),c.cal.capDacA=c.config.primary.capdaca,c.cal.capDacB=c.config.primary.capdacb,c.cal.capOffset=c.config.primary.capOffset,c.cal.capGain=c.config.primary.capGain,c.cal.capCtrl=c.config.primary.capCtrl,console.log(c.cal),c.loading=!1})).catch((function(e){c.loading=!1,c.fault=!0,u(e)}))},c.submit=function(e){if(c.sop)try{c.config.primary.capdaca=parseInt(c.cal.capDacA),c.config.primary.capdacb=parseInt(c.cal.capDacB),c.config.primary.capOffset=parseInt(c.cal.capOffset),c.config.primary.capGain=parseInt(c.cal.capGain),c.config.primary.capCtrl=parseInt(c.cal.capCtrl);var t=_.cloneDeep(c.config);if(!!angular.equals(t,l))return void o.back("core.devices.cw.start");var n=s.confirm().parent(angular.element(document.querySelector("body"))).clickOutsideToClose(!1).title("Configuration").textContent("This operation will permanently overwrite the existing calibration. Are you sure you want to proceed?").ok("Okay").cancel("Cancel");s.show(n).then((function(){return c.loading=!0,function(e,t){return r.upload(e,t).catch((function(e){throw"Cannot add configuration upload task."}))}(c.sop,t).then((function(){c.loading=!1,u("The configuration has been successfully updated, it will be uploaded to the device during next connection."),o.back("core.devices.cw.start")})).catch((function(e){c.loading=!1,u(e)}))}),(function(){console.log("canceled")}))}catch(e){u(e)}},c.download=function(){var e;c.sop&&(c.loading=!0,(e=c.sop,r.download(e).catch((function(e){throw"Cannot add configuration download task."}))).then((function(){c.loading=!1,u("The configuration will be downloaded from the device during next connection."),o.back("core.devices.cw.start")})).catch((function(e){c.loading=!1,u(e)})))}}]),angular.module("cw").factory("CwStream",["$q","CwSocket","Task",function(e,t,n){var a={sample:null,state:null};return t.on("app:cw:stream-sample",(function(e,t){a.sample&&a.sample(e,t)})),t.on("app:cw:stream-state",(function(e,t,n){console.log(t),a.state&&a.state(e,t,n)})),{request:function(e){return o(e,1).then((function(t){if(t.tasks.length){var a=t.tasks[0];return new n(a).$update()}return new n({uuid:e,createdOn:Date.now(),command:"stream",mode:"Individual",options:{freq:10}}).$save()}))},cancelRequest:function(t){return o(t.uuid).then((function(t){var a=t.tasks.map((function(e){return new n(e).$remove()}));return e.all(a)}))},on:function(e,t){"sample"===e?a.sample=t:"state"===e&&(a.state=t)},removeListener:function(e,t){"sample"===e?a.sample=null:"state"===e&&(a.state=null)}};function o(e,t){var a={uuid:e,command:"stream",order:"-createdOn",skip:0};return t&&(a.limit=t),n.query(a).$promise}}]),angular.module("cw").factory("Cw",["$resource",function(e){return e("api/cw/:cwId",{cwId:"@uuid"},{update:{method:"PUT"},query:{method:"GET",isArray:!1}})}]),angular.module("cw").factory("CwSamples",["$resource",function(e){return e("api/cw/samples/cwDeviceId",{cwpDeviceId:"@uuid"},{update:{method:"PUT"}})}]),angular.module("cw").factory("CwConfig",["Task",function(e){return{upload:function(t,n){var a=t.uuid;return new e({uuid:a,command:"upload",mode:"Individual",options:n}).$save()},download:function(t){var n=t.uuid;return function(t){return e.query({uuid:t,command:"download",order:"-createdOn",limit:1,skip:0}).$promise}(n).then((function(t){return t.tasks.length?t.tasks[0]:new e({uuid:n,command:"download",mode:"Individual"}).$save()}))},get:function(t){return(n=t.uuid,e.query({uuid:n,command:"upload",order:"-createdOn",limit:1,skip:0}).$promise).then((function(e){var n=e.tasks,a=n.length?n[0].options:t.config;return _.cloneDeep(a)}));var n}}}]),goog.require("proto.CarbonWearSample.Data"),goog.require("proto.CarbonWearSample.DataArray"),angular.module("cw").factory("CwSample",["$q","$resource","TdSocket","TdDialog",function(e,t,n,a){var o={sample:null},i=t("api/cw-sample",null,{get:{responseType:"arraybuffer",transformResponse:function(e,t){return{data:e}}}});return n.on("app:cw:sample",(function(e,t){if(o.sample){var n=proto.CarbonWearSample.Data.deserializeBinary(new Uint8Array(t));o.sample(e,n.toObject())}})),{query:function(t){return e((function(e,n){t.proto="protobuf",i.get(t).$promise.then((function(t){var n=proto.CarbonWearSample.DataArray.deserializeBinary(new Uint8Array(t.data));e(n.toObject())}),(function(e){n(e)}))}))},on:function(e,t){"sample"===e&&(o.sample=t)},removeListener:function(e,t){"sample"===e&&(o.sample=null)}}}]),angular.module("cw").factory("CwSocket",["socketFactory",function(e){var t=io.connect();return t.on("connect",(function(){t.emit("name","www")})),e({prefix:"app:cw:",ioSocket:t})}]),angular.module("cw").factory("CwConnectionStatus",["$q","CwSocket",function(e,t){var n={status:null};return t.on("app:cw:status",(function(e,t){n.status&&n.status(e,t)})),{on:function(e,t){"status"===e&&(n.status=t)},removeListener:function(e,t){"status"===e&&(n.status=null)}}}]),goog.provide("proto.CarbonWearFile.File"),angular.module("cw").factory("CarbonWearFile",["$q","$resource",function(e,t){var n=t("api/fs/:lvl1/:lvl2/:lvl3/:lvl4/:lvl5/:lvl6",null,{get:{responseType:"arraybuffer",transformResponse:function(e,t){return{data:e}}}});return{get:function(t){return e((function(e,a){n.get(t).$promise.then((function(t){e(proto.CarbonWearFile.File.deserializeBinary(new Uint8Array(t.data)).toObject())}),(function(e){a(e)}))}))}}}]),angular.module("users").config(["$httpProvider",function(e){e.interceptors.push(["$q","$location","Authentication",function(e,t,n){return{responseError:function(a){switch(a.status){case 401:n.user=null,t.path("signin")}return e.reject(a)}}}])}]),angular.module("users").config(["$stateProvider",function(e){e.state("core.user",{url:"/user",template:"<ui-view></ui-view>"}).state("core.user.profile",{url:"/settings/profile",templateUrl:"modules/users/views/settings/edit-profile.client.view.html"}).state("core.user.password",{url:"/settings/password",templateUrl:"modules/users/views/settings/change-password.client.view.html"}).state("signup",{url:"/signup",templateUrl:"modules/users/views/authentication/signup.client.view.html"}).state("signin",{url:"/signin",templateUrl:"modules/users/views/authentication/signin.client.view.html"})}]),angular.module("users").controller("AuthenticationController",["$scope","$http","$location","Authentication",function(e,t,n,a){e.authentication=a,e.authentication.user&&n.path("/"),e.signup=function(){t.post("/auth/signup",e.credentials).success((function(t){e.authentication.user=t,n.path("/")})).error((function(t){e.error=t.message}))},e.signin=function(){t.post("/auth/signin",e.credentials).success((function(t){e.authentication.user=t,n.path("/")})).error((function(t){e.error=t.message}))}}]),angular.module("users").controller("SettingsController",["$scope","$rootScope","$http","$location","Users","Authentication",function(e,t,n,a,o,i){e.user=i.user,e.user||a.path("/"),t.section="account",e.hasConnectedAdditionalSocialAccounts=function(t){for(var n in e.user.additionalProvidersData)return!0;return!1},e.isConnectedSocialAccount=function(t){return e.user.provider===t||e.user.additionalProvidersData&&e.user.additionalProvidersData[t]},e.removeUserSocialAccount=function(t){e.success=e.error=null,n.delete("/users/accounts",{params:{provider:t}}).success((function(t){e.success=!0,e.user=i.user=t})).error((function(t){e.error=t.message}))},e.updateUserProfile=function(t){t?(e.success=e.error=null,new o(e.user).$update((function(t){e.success=!0,i.user=t}),(function(t){e.error=t.data.message}))):e.submitted=!0},e.changeUserPassword=function(){e.success=e.error=null,n.post("/users/password",e.passwordDetails).success((function(t){e.success=!0,e.passwordDetails=null})).error((function(t){e.error=t.message}))}}]),angular.module("users").factory("Authentication",[function(){return this._data={user:window.user},this._data}]),angular.module("users").factory("Users",["$resource",function(e){return e("users",{},{update:{method:"PUT"}})}]),angular.module("bcm").config(["$stateProvider",function(e){e.state("core.devices.bcm",{abstract:!0,url:"/bcm",templateUrl:"modules/bcm/views/bcm-content.client.view.html"}).state("core.devices.bcm.start",{url:"/",templateUrl:"modules/bcm/views/bcm-individual.client.view.html"}).state("core.devices.bcm.edit",{url:"/edit/:bcmId",templateUrl:"modules/bcm/views/bcm-edit.client.view.html"}).state("core.devices.bcm.edit-sleep",{url:"/edit-sleep/:bcmId",templateUrl:"modules/bcm/views/bcm-edit-sleep.client.view.html"}).state("core.devices.bcm.calibration",{url:"/calibration/:bcmId",templateUrl:"modules/bcm/views/bcm-calibration.client.view.html"}).state("core.devices.bcm.stats",{url:"/statistics/:bcmId",templateUrl:"modules/bcm/views/bcm-statistics.client.view.html"}).state("core.devices.bcm.connecting",{url:"/connecting/:bcmId/:request/:next",templateUrl:"modules/bcm/views/bcm-connecting.client.view.html"}).state("core.devices.bcm.stream",{url:"/stream/:bcmId",templateUrl:"modules/bcm/views/bcm-stream.client.view.html"})}]),angular.module("bcm").controller("BcmController",["$rootScope","$scope","Authentication","$mdToast",function(e,t,n,a){t.authentication=n,e.section="devices.bcm",t.$on("$destroy",(function(){}))}]),angular.module("bcm").controller("BcmCalibrationController",["Authentication","$stateParams","TdDialog","Bcm","StateHelper","$mdToast","BcmConfig","$mdDialog",f]),angular.module("mt").controller("BcmViewController",["$scope","$stateParams","$location","Authentication","Bcm","Devices","StatusSocket","DeviceSocket","GrowlMessage","BcmSamples","TDChart",function(e,t,n,a,o,i,r,s,l,c,u){e.calibration={maximumLoad:10,maximumVoltage:1.8,minimumVoltage:0};var d=200,m=0,f={tensileLoad:{title:"Tensile Load",unit:"kN"},rssi:{title:"RSSI",unit:"dBm"},temperature:{title:"Temperature",unit:"°C"},batteryVoltage:{title:"Battery Voltage",unit:"V"},packetCounter:{title:"Packet Counter",unit:""},restartsUnknown:{title:"Restarts (Unknown)",unit:""},restartsSoftware:{title:"Restarts (Software)",unit:""},restartsWatchdog:{title:"Restarts (Watchdog)",unit:""}};e.configuration=[{name:"tensile-load",title:"Tensile Load",units:[{unit:"kN",name:"kilo-newtons",converter:function(t){var n=e.bcm.configNumeric;return n?(t-n.minimumAdc)*(n.maximumUnit-n.minimumUnit)/(n.maximumAdc-n.minimumAdc)+n.minimumUnit:t}},{unit:"%",name:"percent",converter:function(t){var n=e.bcm.configNumeric;return n?100*(t-n.minimumRange)/(n.maximumRange-n.minimumRange):t}},{unit:"V",name:"volts",converter:function(e){return 1.8*e/65535}},{unit:"ADC",name:"ADC"}]},{name:"temperature",title:"Temperature",units:[{unit:"°C",name:"degree Celsius",converter:function(e){return e/4}},{unit:"ADC",name:"ADC"}]},{name:"battery-voltage",title:"Battery Voltage",units:[{unit:"V",name:"volts",converter:function(e){return e/1024*3.6}},{unit:"ADC",name:"ADC"}]},{name:"rssi",title:"RSSI",units:[{unit:"dBm",name:"decibel-milliwatts"}]},{name:"packet-counter",title:"Packet Counter",units:[{unit:"",name:""}]},{name:"restarts-unknown",title:"Restarts (Unknown)",units:[{unit:"",name:""}]},{name:"restarts-software",title:"Restarts (Software)",units:[{unit:"",name:""}]},{name:"restarts-watchdog",title:"Restarts (Watchdog)",units:[{unit:"",name:""}]}];var p=0;setInterval((function(){u.addPoint(0,(new Date).getTime(),Math.sin(2*Math.PI/10*p)),u.addPoint(1,(new Date).getTime(),Math.cos(2*Math.PI/10*p)),u.addPoint(2,(new Date).getTime(),Math.tan(2*Math.PI/10*p)),e.$digest(),p++}),1e3),e.authentication=a,e.section="devices",e.localFeatures=!1,e.loadMoreDisabled=!0,e.chartConfig={options:{chart:{type:"spline",zoomType:"x"}},title:{text:"Monitoring"},loading:!0};var g={rssi:[],temperature:[],batteryVoltage:[],packetCounter:[],tensileLoad:[],restartsUnknown:[],restartsSoftware:[],restartsWatchdog:[]};function v(t){var n=e.channels[t].selected,a=f[n],o=a.title,i=a.unit;e.chartConfig.yAxis[t].title.text=o,e.chartConfig.yAxis[t].labels.format="{value} "+i,e.chartConfig.series[t].name=o,e.chartConfig.series[t].tooltip.valueSuffix=" "+i,e.chartConfig.series[t].data=g[n]}function h(e){o.query({deviceId:t.deviceId}).$promise.then((function(t){t.length>1?e("Multiple BCM objects found for one device."):0===t.length?e("Cannot find BCM device."):e(null,t[0])}),(function(t){e(t)}))}function w(t){e.configNumeric=function(e){if(!e)return;var t=angular.copy(e);return delete t._id,delete t.__v,t}(t.configNumeric),e.bcm=t}function y(e){var t=x(e);g.tensileLoad.push([t.timestamp,t.tensileLoad]),g.rssi.push([t.timestamp,t.rssi]),g.temperature.push([t.timestamp,t.temperature]),g.batteryVoltage.push([t.timestamp,t.batteryVoltage]),g.packetCounter.push([t.timestamp,t.packetCounter]),g.restartsUnknown.push([t.timestamp,t.restartsUnknown]),g.restartsSoftware.push([t.timestamp,t.restartsSoftware]),g.restartsWatchdog.push([t.timestamp,t.restartsWatchdog])}function b(e){var t=x(e);g.tensileLoad.unshift([t.timestamp,t.tensileLoad]),g.rssi.unshift([t.timestamp,t.rssi]),g.temperature.unshift([t.timestamp,t.temperature]),g.batteryVoltage.unshift([t.timestamp,t.batteryVoltage]),g.packetCounter.unshift([t.timestamp,t.packetCounter]),g.restartsUnknown.unshift([t.timestamp,t.restartsUnknown]),g.restartsSoftware.unshift([t.timestamp,t.restartsSoftware]),g.restartsWatchdog.unshift([t.timestamp,t.restartsWatchdog])}function x(e){return{timestamp:Date.parse(e.timestamp),tensileLoad:parseFloat(e.tensionAdc),rssi:parseFloat(e.rssi),packetCounter:parseFloat(e.packetCounter),batteryVoltage:parseFloat(e.batteryVoltage),temperature:parseFloat(e.temperature),restartsUnknown:parseFloat(e.restartsUnknown),restartsSoftware:parseFloat(e.restartsSoftware),restartsWatchdog:parseFloat(e.restartsWatchdog)}}function C(e,t){t&&t.data&&t.data.message?l.error(e,t.data.message):l.error(e,"Unknown erorr")}function S(e){!function(e,n,a){c.query({bcmDeviceId:t.deviceId,skip:e,limit:n}).$promise.then((function(e){a(null,e)}),(function(e){a(e)}))}(m,d,(function(t,n){t||(m+=n.length),e(t,n)}))}function $(e){h((function(t,n){t||w(n),e(t)}))}e.channels=[{selected:"batteryVoltage",style:{color:Highcharts.getOptions().colors[0]},changed:function(){v(0)}},{selected:"temperature",style:{color:Highcharts.getOptions().colors[1]},changed:function(){v(1)}},{selected:"rssi",style:{color:Highcharts.getOptions().colors[2]},changed:function(){v(2)}}],e.viewOne=function(){var n;n=function(t,n){t?l.error("Find device",t):e.device=n},i.get({deviceId:t.deviceId}).$promise.then((function(e){n(null,e)}),(function(e){n(e)})),h((function(e,t){e?l.error("Find BCM",e):w(t)})),e.loadMoreDisabled=!0,e.chartConfig.loading=!0,S((function(t,n){t?C("Load Samples",t):(n.length>0&&(!function(e){for(var t=e.length-1;t>=0;t--)y(e[t])}(n),e.status=n[0],u.addPoints(0,angular.copy(g.tensileLoad)),u.addPoints(1,angular.copy(g.temperature)),u.addPoints(2,angular.copy(g.batteryVoltage)),u.addPoints(3,angular.copy(g.rssi)),u.addPoints(4,angular.copy(g.packetCounter)),u.addPoints(5,angular.copy(g.restartsUnknown)),u.addPoints(6,angular.copy(g.restartsSoftware)),u.addPoints(7,angular.copy(g.restartsWatchdog)),e.$$phase||e.$digest()),e.chartConfig={options:{chart:{zoomType:"x"}},credits:{enabled:!1},legend:{width:300,itemWidth:150,itemStyle:{width:150}},title:{text:"Monitoring"},xAxis:{type:"datetime",title:{text:"Date"}},yAxis:[{labels:{format:"{value} V",style:{color:Highcharts.getOptions().colors[0]}},title:{text:"Battery Voltage",style:{color:Highcharts.getOptions().colors[0]}}},{title:{text:"Temperature",style:{color:Highcharts.getOptions().colors[1]}},labels:{format:"{value} °C",style:{color:Highcharts.getOptions().colors[1]}},opposite:!0},{title:{text:"RSSI",style:{color:Highcharts.getOptions().colors[2]}},labels:{format:"{value} dBm",style:{color:Highcharts.getOptions().colors[2]}},opposite:!0}],series:[{name:"Battery Voltage",type:"spline",yAxis:0,data:g.batteryVoltage,tooltip:{valueSuffix:" V"}},{name:"Temperature",type:"spline",yAxis:1,data:g.temperature,tooltip:{valueSuffix:" °C"}},{name:"RSSI",type:"spline",yAxis:2,data:g.rssi,tooltip:{valueSuffix:" dBm"}}]}),e.loadMoreDisabled=!1,e.chartConfig.loading=!1}))},e.downloadNumericConfiguration=function(){h((function(e,t){e?C("Download Configuration",e):(t.configDate=null,t.$update((function(){w(t),l.success("Download Configuration","The configuration will be download during next connection.")}),(function(e){C("Download Configuration",e)})))}))},e.loadMore=function(){e.loadMoreDisabled=!0,e.chartConfig.loading=!0,S((function(t,n){t?C("Load Samples",t):function(e){for(var t=0;t<e.length;t++)b(e[t])}(n),e.loadMoreDisabled=!1,e.chartConfig.loading=!1}))},e.editNumericConfiguration=function(){n.path("bcm/"+e.bcm.device._id+"/edit/numeric")},e.connect=function(){n.path("bcm/"+e.bcm.device._id+"/connecting")},r.removeAllListeners("status:bcm:sample"),r.on("status:bcm:sample",(function(t){e.device&&t.uuid===e.device.uuid&&function(t){var n=e.status;if(e.status=t,!0===e.loadMoreDisabled)return;if(n&&n.packetCounter===t.packetCounter)return;if(new Date(Date.parse(t.timestamp)).getTime()<new Date(2010,1,1,1,0,0,0).getTime())return;m+=1,y(t),a=x(t),u.addPoint(0,a.timestamp,a.tensileLoad),u.addPoint(1,a.timestamp,a.temperature),u.addPoint(2,a.timestamp,a.batteryVoltage),u.addPoint(3,a.timestamp,a.rssi),u.addPoint(4,a.timestamp,a.packetCounter),u.addPoint(5,a.timestamp,a.restartsUnknown),u.addPoint(6,a.timestamp,a.restartsSoftware),u.addPoint(7,a.timestamp,a.restartsWatchdog),e.$$phase||e.$digest();var a}(t)})),r.removeAllListeners("status:device"),r.on("status:device",(function(t){e.device&&e.device.uuid===t.uuid&&(e.device=t)})),r.emit("www:features"),r.removeAllListeners("status:features"),r.on("status:features",(function(t){e.localFeatures="local"===t})),r.removeAllListeners("status:bcm:config:numeric:uploaded"),r.on("status:bcm:config:numeric:uploaded",(function(t,n){e.bcm&&$((function(e){e||l.success("Edit BCM","The configuration has been successfully uploaded.")}))})),r.removeAllListeners("status:bcm:config:numeric:downloaded"),r.on("status:bcm:config:numeric:downloaded",(function(t,n){e.bcm&&$((function(e){e||l.success("Edit BCM","The configuration has been successfully downloaded.")}))}))}]),angular.module("bcm").controller("BcmIndividualController",["$scope","$state","$window","Bcm","BcmStream","BcmConnectionStatus","TdDialog","TdAdvert","BcmSocket",function(e,t,n,a,o,i,r,s,l){var c=this;e.$on("$destroy",(function(){c.selected[0]?sessionStorage.setItem("bcm.individual.selected",c.selected[0].uuid):sessionStorage.setItem("bcm.individual.selected",void 0),sessionStorage.setItem("bcm.individual.query",JSON.stringify(c.query)),s.removeListener("advert",p),i.removeListener("status",f),l.removeListener("app:bcm:config-state",g)})),c.isLoading=!1,c.selected=[],c.section="devices";var u=sessionStorage.getItem("bcm.individual.query"),d=sessionStorage.getItem("bcm.individual.selected");c.query=u?JSON.parse(u):{order:"uuid",limit:10,page:1};function m(e){return _.find(c.bcms.devices,(function(t){return e===t.uuid}))}function f(e,t){var n=m(e);n&&_.set(n,"connection.status",t)}function p(e,t){var n=m(e);n&&_.set(n,"advertisement",t)}function g(e,t,n){if("upload"===t||"download"===t){var a=m(e);a&&(_.set(a,"config.timestamp",n.timestamp),_.set(a,"config.primary",n.primary))}}c.get=function(){c.isLoading=!0,function(e){return a.query(e).$promise.catch((function(e){throw r.error("BCM Request",e,"Cannot load BCM devices."),e}))}({order:c.query.order,skip:(c.query.page-1)*c.query.limit,limit:c.query.limit}).then((function(e){c.bcms=e,d&&c.bcms.devices.forEach((function(e){e.uuid===d&&(c.selected[0]=e)})),i.on("status",f),s.on("advert",p),l.on("app:bcm:config-state",g),c.isLoading=!1})).catch((function(e){c.isLoading=!1}))},c.stream=function(){c.selected[0]&&(c.isLoading=!0,o.request(c.selected[0]).then((function(){c.isLoading=!1,t.go("core.devices.bcm.connecting",{bcmId:c.selected[0]._id,request:"start-stream"})}),(function(e){c.isLoading=!1,r.error("BCM Error",e,"Cannot start data stream.")})))},c.statistics=function(){c.selected[0]&&t.go("core.devices.bcm.stats",{bcmId:c.selected[0]._id})},c.calibration=function(){c.selected[0]&&t.go("core.devices.bcm.calibration",{bcmId:c.selected[0]._id})},c.editSleep=function(){c.selected[0]&&t.go("core.devices.bcm.edit-sleep",{bcmId:c.selected[0]._id})},c.edit=function(){c.selected[0]&&t.go("core.devices.bcm.edit",{bcmId:c.selected[0]._id})}}]),angular.module("bcm").controller("BcmStatisticsController",["$scope","Authentication","$q","$stateParams","TdDialog","TdAdvert","BcmSample","Bcm","BcmConnectionStatus","StateHelper","$window",function(e,t,n,a,o,i,r,s,m,f,p){var h=this,w=200,y=[],b=null,x=0,C=null,S=null,$={tensionAdc:{title:"Tension",units:[new v,new g],allowedUnits:function(){return!b||0===b.minimumRange&&65535===b.maximumRange&&0===b.minimumUnit&&65535===b.maximumUnit?[0]:[0,1]},defaultUnit:function(){return!b||0===b.minimumRange&&65535===b.maximumRange&&0===b.minimumUnit&&65535===b.maximumUnit?0:1}},rssi:{title:"RSSI",units:[new l]},temperature:{title:"Temperature",units:[new c]},batteryVoltage:{title:"Battery Voltage",units:[new u]},restartsUnknown:{title:"Unknown Restarts",units:[new d]},restartsSoftware:{title:"Software Restarts",units:[new d]},restartsWatchdog:{title:"Watchdog Restarts",units:[new d]},configNumber:{title:"Configuration Number",units:[new d]},packetCounter:{title:"Packet Counter",units:[new d]}};function D(e,t){e===h.bcm.uuid&&(h.bcm||(h.bcm={}),h.bcm.connection||(h.bcm.connection={}),h.bcm.connection.status=t)}function A(e,t){e===h.bcm.uuid&&(h.bcm||(h.bcm={}),h.bcm.advertisement=t,h.advert=t)}function I(e,t){if(e===h.bcm.uuid){var n,a=b;if(b=t,!0!==h.loadingSamples)if(!a||a.packetCounter!==t.packetCounter)if(!(t.timestamp<new Date(2010,1,1,1,0,0,0).getTime()))x+=1,T(t),V(0,n=t),V(1,n)}}function k(){return h.loadingSamples=!0,C.showLoading("Loading..."),(e=x,t=w,r.query({uuid:h.bcm.uuid,skip:e,limit:t})).then((function(e){return h.loadingSamples=!1,C.hideLoading(),e.samplesList&&(x+=e.samplesList.length),e.samplesList}),(function(e){throw h.loadingSamples=!1,C.hideLoading(),o.error("Load Samples",e,"Cannot load samples."),e}));var e,t}function U(){P(0),P(1)}function T(e){e&&y.push(e)}function L(e){e&&y.unshift(e)}function q(e){var t=h.channels[e].selectedChannel,n=$[t];h.channels[e].availableUnits=n.units.filter((function(e,t){return!n.allowedUnits||-1!==n.allowedUnits().indexOf(t)})).map((function(e,t){return{name:e.Unit,value:t.toString()}}));var a=0;n.defaultUnit&&(a=n.defaultUnit()),h.channels[e].selectedUnit=h.channels[e].availableUnits[a],P(e)}function O(e){P(e)}function P(e){var t=h.channels[e].selectedChannel,n=parseInt(h.channels[e].selectedUnit.value),a=$[t],o=a.title,i=a.units[n],r=i.Unit,s=i.ValueDecimals,l=i.DetailedValueDecimals;C.yAxis[e].update({labels:{format:"{value:."+s+"f}",style:{color:Highcharts.getOptions().colors[e]}},title:{text:o+(r?" ("+r+")":""),style:{color:Highcharts.getOptions().colors[e]}}}),C.series[e].update({name:o+(r?" ("+r+")":""),type:"line",yAxis:e,data:y.map((function(e){return[e.timestamp,i.convert(e[t],e)]})),tooltip:{valueSuffix:r?" ("+r+")":"",valueDecimals:l}})}function V(e,t){var n=h.channels[e].selectedChannel,a=parseInt(h.channels[e].selectedUnit.value),o=$[n].units[a];C.series[e].addPoint([t.timestamp,o.convert(t[n],t)])}e.$on("$destroy",(function(){i.removeListener("advert",A),r.removeListener("sample",I),m.removeListener("status",D),S&&S()})),h.authentication=t,h.loadingDevice=!1,h.loadingSamples=!1,h.bcm,h.advert,h.config,h.channels=[{selectedChannel:"tensionAdc",channelChanged:function(){q(0)},selectedUnit:{value:"0",name:"V"},availableUnits:[{value:"0",name:"V"}],unitChanged:function(){O(0)},style:{color:Highcharts.getOptions().colors[0]}},{selectedChannel:"temperature",channelChanged:function(){q(1)},selectedUnit:{value:"0",name:"°C"},availableUnits:[{value:"0",name:"°C"}],unitChanged:function(){O(1)},style:{color:Highcharts.getOptions().colors[1]}}],h.get=function(){(h.loadingDevice=!0,s.get({bcmId:a.bcmId}).$promise.then((function(e){h.bcm=e,h.advert=e.advertisement,h.config=e.config,h.loadingDevice=!1}),(function(e){throw h.loadingDevice=!1,o.error("BCM Error",e,"Cannot find BCM device in the data base."),e}))).then((function(){var e,t,n;return C=new Highcharts.Chart({plotOptions:{series:{borderWidth:0,animation:!1,states:{hover:{enabled:!1}},marker:{enabled:!1}}},chart:{zoomType:"x",renderTo:"chart",animation:!1},legend:{width:300,itemWidth:150,itemStyle:{width:150}},credits:{enabled:!1},title:{text:""},xAxis:{title:{text:"Date"},type:"datetime"},yAxis:[{labels:{format:"{value} V",style:{color:Highcharts.getOptions().colors[0]}},title:{text:"Battery Voltage",style:{color:Highcharts.getOptions().colors[0]}}},{title:{text:"Temperature",style:{color:Highcharts.getOptions().colors[1]}},labels:{format:"{value} °C",style:{color:Highcharts.getOptions().colors[1]}},opposite:!0}],series:[{name:"Battery Voltage",type:"line",yAxis:0,data:[],tooltip:{valueSuffix:" V"}},{name:"Temperature",type:"line",yAxis:1,data:[],tooltip:{valueSuffix:" °C"}}]}),e=angular.element("#chart"),t=0,n=setInterval((function(){e.width()!==t&&(t=e.width(),C.setSize(t,C.height))}),500),S=function(){clearInterval(n)},k()})).then((function(e){b=e[0],q(0),function(e){for(var t=e.length-1;t>=0;t--)T(e[t])}(e),U(),i.on("advert",A),r.on("sample",I),m.on("status",D)}))},h.loadMore=function(){k().then((function(e){!function(e){for(var t=0;t<e.length;t++)L(e[t])}(e),U()}))}}]);var p={map:function(e,t,n,a,o){return(e-t)*(o-a)/(n-t)+a}};function g(){function e(e,t){return p.map(e,t.minimumRange,t.maximumRange,t.minimumUnit/10,t.maximumUnit/10)}return{Unit:"kN",UnitName:"Kilo-Newtons",ValueDecimals:1,DetailedValueDecimals:3,convert:e,minmax:function(t){return{min:e(t.minimumRange,t),max:e(t.maximumRange,t)}}}}function v(){return{Unit:"V",UnitName:"Volts",ValueDecimals:1,DetailedValueDecimals:3,convert:function(e){return p.map(e,0,65535,0,1.8)},minmax:function(){return{min:0,max:1.8}}}}function l(){return{Unit:"dBm",UnitName:"Decibel-milliwatts",ValueDecimals:0,DetailedValueDecimals:0,convert:function(e){return e},minmax:function(){return{min:-105,max:0}}}}function c(){return{Unit:"°C",UnitName:"degree-Celsius",ValueDecimals:1,DetailedValueDecimals:1,convert:function(e){return e},minmax:function(){return{min:-40,max:80}}}}function u(){return{Unit:"V",UnitName:"Volts",ValueDecimals:2,DetailedValueDecimals:2,convert:function(e){return e},minmax:function(){return{min:0,max:3.3}}}}function d(){return{Unit:"",UnitName:"",ValueDecimals:0,DetailedValueDecimals:0,convert:function(e){return e},minmax:function(){}}}function f(e,t,n,a,o,i,r){var s,l=this;function c(e){i.show(i.simple().position("bottom right").textContent(e).hideDelay(3e3))}l.authentication=e,l.loading=!1,l.fault=!1,l.bcm,l.config,l.get=function(){var e,n;l.loading=!0,(n=t.bcmId,a.get({bcmId:n}).$promise.catch((function(e){throw"Cannot add configuration upload task."}))).then((function(t){return function(e){return r.get(e).catch((function(e){throw"Cannot load Bolt-Cap configuration."}))}(e=t)})).then((function(t){return function(e,t){if(!e||!t)throw"Invalid data.";l.bcm=e,l.config=t,s=_.cloneDeep(t)}(e,t)})).then((function(){l.loading=!1})).catch((function(e){l.loading=!1,l.fault=!0,c(e)}))},l.submit=function(e){if(l.bcm){var t,n=_.cloneDeep(l.config),a=!angular.equals(n,s);l.loading=!0,(t=l.bcm,t.$update().catch((function(e){throw"Cannot save Bolt-Cap."}))).then((function(){if(a)return function(e,t){return r.upload(e,t).catch((function(e){throw"Cannot add configuration upload task."}))}(l.bcm,n).then((function(){c("The configuration has been successfully updated, it will be uploaded to the device during next connection.")}));c("The Bolt-Cap has been updated successfully")})).then((function(){l.loading=!1,o.back("core.devices.bcm.start")})).catch((function(e){l.loading=!1,c(e)}))}},l.download=function(){var e;l.bcm&&(l.loading=!0,(e=l.bcm,r.download(e).catch((function(e){throw"Cannot add configuration download task."}))).then((function(){l.loading=!1,c("The configuration will be downloaded from the device during next connection."),o.back("core.devices.bcm.start")})).catch((function(e){l.loading=!1,c(e)})))}}function i(e,t,n){$.msgGrowl({type:e,title:t,text:n})}angular.module("bcm").controller("BcmEditSleepController",["$scope","Authentication","$stateParams","TdDialog","Bcm","StateHelper","$mdToast","BcmConfig","$q",function(e,t,n,a,o,i,r,s,l){var c=this,u=null;function d(e){e=1e3*parseInt(e),c.advertWindows=c.availableAdvertWindows.filter((function(t){var n=parseInt(t.value);return e>n}));var t=parseInt(c.config.primary.advertWindowContactable);0===c.advertWindows.filter((function(e){return parseInt(e.value)===t})).length&&(c.config.primary.advertWindowContactable=c.advertWindows[0].value)}function m(e){r.show(r.simple().position("bottom right").textContent(e).hideDelay(3e3))}c.authentication=t,c.loading=!1,c.fault=!1,c.bcm,c.advertIntervals=[{value:"5",text:"5 secounds"},{value:"10",text:"10 secounds"},{value:"20",text:"20 secounds"},{value:"30",text:"30 seconds"},{value:"60",text:"1 minute"},{value:"120",text:"2 minutes"},{value:"300",text:"5 minutes"},{value:"600",text:"10 minutes"},{value:"1200",text:"20 minutes"},{value:"1800",text:"30 minutes"},{value:"3600",text:"1 hour"}],c.availableAdvertWindows=[{value:"900",text:"900 milliseconds"},{value:"1000",text:"1 second"},{value:"2000",text:"2 seconds"},{value:"3000",text:"3 seconds"},{value:"5000",text:"5 seconds"},{value:"8000",text:"8 seconds"},{value:"10000",text:"10 seconds"},{value:"20000",text:"20 seconds"},{value:"30000",text:"30 seconds"},{value:"40000",text:"40 seconds"},{value:"50000",text:"50 seconds"},{value:"60000",text:"1 minute"}],c.advertWindows=c.availableAdvertWindows,c.get=function(){var t,a;c.loading=!0,(a=n.bcmId,o.get({bcmId:a}).$promise.catch((function(e){throw"Cannot load BCM."}))).then((function(e){return function(e){return s.get(e).catch((function(e){throw"Cannot load BCM's configuration."}))}(t=e)})).then((function(n){return function(t,n){if(!t||!n)throw"Invalid data.";c.bcm=t,c.config=n,u=_.cloneDeep(n),e.$watch(angular.bind(c,(function(){return this.config.primary.advertInterval})),d)}(t,n)})).then((function(){c.loading=!1})).catch((function(e){c.loading=!1,c.fault=!0,m(e)}))},c.submit=function(e){if(c.bcm){var t=_.cloneDeep(c.config);t.primary.advertInterval=parseInt(c.config.primary.advertInterval),t.primary.advertWindowContactable=parseInt(c.config.primary.advertWindowContactable),angular.equals(t,u)?i.back("core.devices.bcm.start"):(c.loading=!0,function(e,t){return s.upload(e,t).catch((function(e){throw"Cannot add configuration upload task."}))}(c.bcm,t).then((function(){c.loading=!1,m("The configuration has been successfully updated, it will be uploaded to the device during next connection."),i.back("core.devices.bcm.start")})).catch((function(e){c.loading=!1,m(e)})))}}}]),angular.module("bcm").controller("BcmConnectingController",["Authentication","$rootScope","$scope","$q","$stateParams","$state","$window","TdDialog","$mdToast","StateHelper","TdAdvert","Bcm","BcmStream","BcmConnectionStatus",function(e,t,n,a,o,i,r,s,l,c,u,d,m,f){var p=this,g=!1,v={advert:"Waiting for advertisement...",connecting:"Connecting...",configuring:"Configuring...",disconnecting:"Disconnecting...",disconnected:"Disconnected",canceling:"Cancelling..."},h=t.$on("$stateChangeStart",(function(e,t,n,a,o,i){if(g)return;console.log("unexpected state change"),e.preventDefault(),p.canCancel?(console.log("can cancel"),C()):(console.log("cannot cancel"),S("error","Cannot cancel request."))}));function w(e){console.log("on before unload");return e.returnValue="Operation in progress, please don't unload the window","Operation in progress, please don't unload the window"}function y(e){}n.$on("$destroy",(function(){u.removeListener("advert",I),f.removeListener("status",k),r.removeEventListener("beforeunload",w),r.removeEventListener("unload",y),h()})),r.addEventListener("beforeunload",w),r.addEventListener("unload",y);var b=null;function x(){switch(-1!==b.request.indexOf("start")?p.message=v.advert:-1!==b.request.indexOf("stop")&&(p.message=v.disconnecting),b.request){case"start-stream":(console.log("wait stream"),a((function(e,t){var n=function(t,a,o){p.bcm.uuid===t&&("started"===a?(m.removeListener("state",n),e()):"error"===a&&S("error",o))};m.on("state",n)}))).then((function(){A("core.devices.bcm.stream",{bcmId:p.bcm._id})}),(function(){D()}));break;case"stop-stream":$().then((function(){D()}),(function(){D()}))}}function C(){switch(p.message=v.canceling,b.request){case"start-stream":$().then((function(){D()}),(function(){D()}))}}function S(e,t){l.show(l.simple().position("bottom right").textContent(t).hideDelay(3e3))}function $(){return a((function(e,t){m.cancelRequest(p.bcm).then((function(){e()}),(function(e){s.error("BCM Error",e,"Cannot stop data stream."),t()}))}))}function D(){b.next&&"core.devices.bcm.connecting"!==b.next?A(b.next):A("core.devices.bcm.start")}function A(e,t){g=!0,i.go(e,t)}function I(e,t){e===p.bcm.uuid&&console.log(t)}function k(e,t){if(e===p.bcm.uuid){switch(t.label){case"Connecting...":p.message=v.connecting,p.canCancel=!1;break;case"Connected":p.message=v.configuring,p.canCancel=!1;break;case"Failure":p.message=v.advert,p.canCancel=!0;break;case"Disconnecting...":p.message=v.disconnecting,p.canCancel=!1;break;case"Disconnected":p.message=v.disconnected,p.canCancel=!1}console.log(e,t)}}p.authentication=e,p.loading=!1,p.canCancel=!0,p.bcm=null,p.title="Connecting...",p.message="",p.get=function(){p.loading=!0,b={bcmId:o.bcmId,request:o.request,next:o.next},d.get({bcmId:o.bcmId}).$promise.then((function(e){p.bcm=e})).then((function(){p.title="Connecting to "+p.bcm.uuid,u.on("advert",I),f.on("status",k),p.loading=!1,x()}),(function(e){s.error("BCM Error",e,"Cannot find BCM device in the data base."),p.loading=!1}))},p.cancel=function(){C()}}]),angular.module("bcm").controller("BcmStreamController",["$rootScope","$scope","$q","$state","$stateParams","$interval","$window","TdDialog","Authentication","Bcm","BcmStream","TdAdvert","BcmConnectionStatus",function(e,t,n,a,o,i,r,s,m,f,p,h,w){var y=this,b=null,x=!1,C=60,S=1e3;y.authentication=m,y.loadingDevice=!1,y.loadingSamples=!1,y.sample=null,y.samples=[],y.tensionUnit=null,y.tensionValue=null,y.chartConfig={options:{chart:{zoomType:"x",animation:!1},exporting:{enabled:!1},plotOptions:{series:{borderWidth:0,animation:!1,marker:{enabled:!1}}}},credits:{enabled:!1},legend:{width:300,itemWidth:150,itemStyle:{width:150}},title:{text:""},xAxis:{type:"datetime",title:{text:"Date"}},yAxis:[{labels:{format:"{value} V",style:{color:Highcharts.getOptions().colors[0]}},title:{text:"Battery Voltage",style:{color:Highcharts.getOptions().colors[0]}}},{title:{text:"Temperature",style:{color:Highcharts.getOptions().colors[1]}},labels:{format:"{value} °C",style:{color:Highcharts.getOptions().colors[1]}},opposite:!0}],series:[{name:"Battery Voltage",type:"line",yAxis:0,data:E(),tooltip:{valueSuffix:" V"}},{name:"Temperature",type:"line",yAxis:1,data:E(),tooltip:{valueSuffix:" °C"}}],func:function(e){b=e}};var $=e.$on("$stateChangeStart",(function(e,t,n,a,o,i){if(!0===x)return;x=!0,e.preventDefault(),M(t.name)}));function D(e){var t="Do not leave this page during connection, please navigate back first to disconnect first.";return e.returnValue=t,t}function A(e){}t.$on("$destroy",(function(){$(),h.removeListener("advert",q),w.removeListener("status",O),p.removeListener("sample",P),p.removeListener("state",V),r.removeEventListener("beforeunload",D),r.removeEventListener("unload",A),b=null})),r.addEventListener("beforeunload",D),r.addEventListener("unload",A);var I={tension:{title:"Tension",units:[new v,new g],allowedUnits:function(){return k()?[0,1]:[0]},defaultUnit:function(){return k()?1:0}},temperature:{title:"Temperature",units:[new c]},batteryVoltage:{title:"Battery Voltage",units:[new u]},remoteRssi:{title:"RSSI (Remote)",units:[new l]},packetCounter:{title:"Packet Counter",units:[new d],minmax:{min:0,max:255}}};function k(){if(!y.config||!y.config.primary)return!1;var e=y.config.primary;return!(0===e.minimumRange&&65535===e.maximumRange&&0===e.minimumUnit&&65535===e.maximumUnit)}function U(e){var t=y.channels[e].selectedChannel,n=I[t];y.channels[e].availableUnits=n.units.filter((function(e,t){return!n.allowedUnits||-1!==n.allowedUnits().indexOf(t)})).map((function(e,t){return{name:e.Unit,value:t.toString()}}));var a=0;n.defaultUnit&&(a=n.defaultUnit()),y.channels[e].selectedUnit=y.channels[e].availableUnits[a],L(e)}function T(e){L(e)}function L(e){var t=function(e){const t=y.channels[e];var n=I[t.selectedChannel],a=n.units[parseInt(t.selectedUnit.value)];return{def:n,unit:a,unit:a}}(e);b.yAxis[e].update(function(e,t,n){return{labels:{format:"{value:."+t.ValueDecimals+"f}",style:{color:Highcharts.getOptions().colors[n]}},title:{text:e.title+(t.Unit?" ("+t.Unit+")":""),style:{color:Highcharts.getOptions().colors[n]}},startOnTick:!0,endOnTick:!0}}(t.def,t.unit,e));var n=function(e,t){if(e.minmax)return{min:e.minmax.min,max:e.minmax.max};var n=t.minmax(y.config.primary);if(n)return{min:n.min,max:n.max};return{min:void 0,max:void 0}}(t.def,t.unit);b.yAxis[e].setExtremes(n.min,n.max),b.series[e].update(function(e,t,n){return{name:e.title+(t.Unit?" ("+t.Unit+")":""),type:"line",yAxis:n,data:B(n,y.config.primary),tooltip:{valueSuffix:t.Unit?" ("+t.Unit+")":"",valueDecimals:t.DetailedValueDecimals}}}(t.def,t.unit,e))}function q(e,t){e===y.bcm.uuid&&console.log(t)}function O(e,t){e===y.bcm.uuid&&console.log(e,t)}function P(e,t){e===y.bcm.uuid&&t&&(y.sample=t,y.loadingSamples=!1,b&&function(e){if(!b)return;const t=I.tension,n=t.units[t.defaultUnit()];y.tensionUnit=n.Unit,y.tensionValue=n.convert(e.tension,y.config.primary);var a=Date.now();y.samples.unshift({timestamp:a,sample:e});for(;y.samples.length>C;)y.samples.pop();W(0,a,e,y.config.primary),W(1,a,e,y.config.primary),b.xAxis[0].setExtremes(a-C*S,a),b.redraw()}(t))}function V(e,t,n){e===y.bcm.uuid&&("error"===t?(s.error("Data Stream",void 0,n),M("core.devices.bcm.start")):"completed"===t&&console.log("completed"))}function M(e){a.go("core.devices.bcm.connecting",{bcmId:y.bcm._id,request:"stop-stream",next:e})}function W(e,t,n,a){b.series[e].addPoint(R(e,t,n,a),!1,!0)}function R(e,t,n,a){var o=y.channels[e].selectedChannel,i=parseInt(y.channels[e].selectedUnit.value);return[t,I[o].units[i].convert(n[o],a)]}function B(e,t){for(var n=[],a=(new Date).getTime(),o=C-1;o>=0;o--){var i=a+-o*S,r=null;y.samples&&y.samples[o]&&y.samples[o].timestamp&&y.samples[o].sample&&(i=parseInt(y.samples[o].timestamp),r=y.samples[o].sample),r?n.push(R(e,i,r,t)):n.push([i,0])}return n}function E(){var e,t=[],n=(new Date).getTime();for(e=-C;e<=0;e++)t.push({x:n+e*S,y:0});return t}y.channels=[{selectedChannel:"tension",channelChanged:function(){U(0)},selectedUnit:{value:"0",name:"V"},availableUnits:[{value:"0",name:"V"}],unitChanged:function(){T(0)},style:{color:Highcharts.getOptions().colors[0]}},{selectedChannel:"temperature",channelChanged:function(){U(1)},selectedUnit:{value:"0",name:"°C"},availableUnits:[{value:"0",name:"°C"}],unitChanged:function(){T(1)},style:{color:Highcharts.getOptions().colors[1]}}],y.get=function(){y.loadingSamples=!0,(y.loadingDevice=!0,f.get({bcmId:o.bcmId}).$promise.then((function(e){y.bcm=e,y.advert=e.advertisement,y.config=e.config,y.loadingDevice=!1}),(function(e){throw y.loadingDevice=!1,s.error("BCM Error",e,"Cannot find BCM device in the data base."),e}))).then((function(){h.on("advert",q),w.on("status",O),p.on("sample",P),p.on("state",V),U(0),U(1)}),(function(e){s.error("BCM Error",e,"Canot load BCM.")}))}}]),angular.module("bcm").controller("BcmEditController",["Authentication","$stateParams","TdDialog","Bcm","StateHelper","$mdToast","BcmConfig",f]),angular.module("bcm").factory("BcmSocket",["socketFactory",function(e){var t=io.connect();return t.on("connect",(function(){t.emit("name","www")})),e({prefix:"app:bcm:",ioSocket:t})}]),angular.module("bcm").factory("BcmConnectionStatus",["$q","BcmSocket",function(e,t){var n={status:null};return t.on("app:bcm:status",(function(e,t){n.status&&n.status(e,t)})),{on:function(e,t){"status"===e&&(n.status=t)},removeListener:function(e,t){"status"===e&&(n.status=null)}}}]),angular.module("bcm").factory("Devices",["$resource",function(e){return e("api/devices/:deviceId",{deviceId:"@_id"},{update:{method:"PUT"}})}]),angular.module("bcm").factory("GrowlMessage",[function(){return{success:function(e,t){i("success",e,t)},info:function(e,t){i("info",e,t)},warning:function(e,t){i("warning",e,t)},error:function(e,t){i("error",e,t)}}}]),angular.module("bcm").factory("Bcm",["$resource",function(e){return e("api/bcm/:bcmId",{bcmId:"@_id"},{update:{method:"PUT"},query:{method:"GET",isArray:!1}})}]),angular.module("bcm").factory("BcmSamples",["$resource",function(e){return e("api/bcm/samples/:bcmDeviceId",{bcmDeviceId:"@_id"},{update:{method:"PUT"}})}]),angular.module("bcm").factory("BcmConfig",["Task",function(e){return{upload:function(t,n){var a=t.uuid;return new e({uuid:a,command:"upload",mode:"Individual",options:n}).$save()},download:function(t){var n=t.uuid;return function(t){return e.query({uuid:t,command:"download",order:"-createdOn",limit:1,skip:0}).$promise}(n).then((function(t){return t.tasks.length?t.tasks[0]:new e({uuid:n,command:"download",mode:"Individual"}).$save()}))},get:function(t){return(n=t.uuid,e.query({uuid:n,command:"upload",order:"-createdOn",limit:1,skip:0}).$promise).then((function(e){var n=e.tasks,a=n.length?n[0].options:t.config;return _.cloneDeep(a)}));var n}}}]),goog.require("proto.BcmSample.Data"),goog.require("proto.BcmSample.DataArray"),angular.module("bcm").factory("BcmSample",["$q","$resource","TdSocket","TdDialog",function(e,t,n,a){var o={sample:null},i=t("api/bcm-sample",null,{get:{responseType:"arraybuffer",transformResponse:function(e,t){return{data:e}}}});return n.on("app:bcm:sample",(function(e,t){if(o.sample){var n=proto.BcmSample.Data.deserializeBinary(new Uint8Array(t));o.sample(e,n.toObject())}})),{query:function(t){return e((function(e,n){t.proto="protobuf",i.get(t).$promise.then((function(t){var n=proto.BcmSample.DataArray.deserializeBinary(new Uint8Array(t.data));e(n.toObject())}),(function(e){n(e)}))}))},on:function(e,t){"sample"===e&&(o.sample=t)},removeListener:function(e,t){"sample"===e&&(o.sample=null)}}}]),angular.module("bcm").factory("BcmStream",["$q","BcmSocket","Task",function(e,t,n){var a={sample:null,state:null};return t.on("app:bcm:stream-sample",(function(e,t){a.sample&&a.sample(e,t)})),t.on("app:bcm:stream-state",(function(e,t,n){a.state&&a.state(e,t,n)})),{request:function(e,t){var a=e.uuid;return o(a,1).then((function(e){return e.tasks.length?e.tasks[0]:new n({uuid:a,command:"stream",mode:"Individual"}).$save()}))},cancelRequest:function(t){return o(t.uuid).then((function(t){var a=t.tasks.map((function(e){return new n(e).$remove()}));return e.all(a)}))},on:function(e,t){"sample"===e?a.sample=t:"state"===e&&(a.state=t)},removeListener:function(e,t){"sample"===e?a.sample=null:"state"===e&&(a.state=null)}};function o(e,t){var a={uuid:e,command:"stream",order:"-createdOn",skip:0};return t&&(a.limit=t),n.query(a).$promise}}]),angular.module("bcm").factory("DeviceSocket",["socketFactory",function(e){var t=io.connect();return t.on("connect",(function(){t.emit("name","www")})),e({prefix:"device:",ioSocket:t})}]),angular.module("bcm").factory("StatusSocket",["socketFactory",function(e){var t=io.connect();return t.on("connect",(function(){t.emit("name","www")})),e({prefix:"status:",ioSocket:t})}]),angular.module("bcm").factory("LastDevices",["$resource",function(e){return e("api/lastDevices")}])}]);